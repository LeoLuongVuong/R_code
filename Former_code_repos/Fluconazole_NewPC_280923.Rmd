---
title: "Fluconazole_NewPC_280923"
author: "Leo"
date: "`r Sys.Date()`"
output: pdf_document
---

### Calling libraries

```{r all necessary libraries,warning=FALSE}

library(dplyr)
library(tidyr)
library(mice) #for 2l.pan imputation
library(pan) #for 2l.pan imputation
library(miceadds) #for 2l.pmm imputation
library(ggplot2)
library(viridis) #for using viridis color palette
library(grid) #to put annotation
library(gridExtra) #to make plot grids
library(cowplot) #to make plot grids
library(pROC) #for making roc curves
library(readr) #part of tidyr #data wrangling
library(purrr) #to sample from a ecdf
#library(ecdf) #to sample from a ecdf #not available - check later
library(xpose) #for making vpcs
library(xpose4) #for making vpcs #having issues with lattice package
library(vpc) #for making vpcs
library(PsNR) #for making vpcs
library(ggtext) #create latex axis labels - does not work
library(latex2exp) #to create latex label
library(table1) #create descriptive statistic table1

```


### Doing MI - Clustering with ID - 2l.pan method - fixing negative values to 0 280923

### After that, Doing MI - Clustering with ID - 2l.pmm method - 011023

### For the whole 70 imputations - 2l.pan method - fixing negative to lowest possible value from CREAT - 041023

#### Reading the source dataset

```{r reading new FlucTotIV_clean dataset, warning=FALSE}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets/Archived dataset")
FlucTotIV_clean <- read.csv("FlucTotIV_clean.csv", na.strings = "NA")
#FlucTotIV_clean_test<-read_csv("FlucTotIV_clean.csv", na= "NA",col_select = c("ID","AMT"))
# works 011223 - perfect!!!

```

#### Converting variables into appropriate types

```{r convert data types}

FlucTotIV_clean$SEX <- as.factor(FlucTotIV_clean$SEX)
FlucTotIV_clean$HOSPITAL <- as.factor(FlucTotIV_clean$HOSPITAL)
FlucTotIV_clean$CRRT <- as.factor(FlucTotIV_clean$CRRT)
FlucTotIV_clean$OCC <- as.factor(FlucTotIV_clean$OCC)
FlucTotIV_clean$EVID <- as.factor(FlucTotIV_clean$EVID)

```

#### Converting all the NAs in TAD, AMT, RATE to 0, and First row of DV to 0

```{r convert NAs to 0}

FlucTotIV_clean$TAD[is.na(FlucTotIV_clean$TAD)] <- 0
FlucTotIV_clean$AMT[is.na(FlucTotIV_clean$AMT)] <- 0
FlucTotIV_clean$RATE[is.na(FlucTotIV_clean$RATE)] <- 0

```

```{r convert DV to 0 where TIME equals 0}

FlucTotIV_clean$DV[FlucTotIV_clean$TIME == 0] <- 0

```

#### Creating crrt and non-crrt datasets

```{r crrt & non-crrt dataset, warning=FALSE}

# Creating crrt & non-crrt datasets

crrt_patients <- unique(FlucTotIV_clean[FlucTotIV_clean$CRRT == 1, "ID"])
FlucTotIV_clean_crrt<-FlucTotIV_clean%>%filter(ID%in%crrt_patients)
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID%in%(crrt_patients))

# Converting BW2 into BW

FlucTotIV_clean_crrt$BW<-FlucTotIV_clean_crrt$BW2
FlucTotIV_clean_nocrrt$BW<-FlucTotIV_clean_nocrrt$BW2

```

#### Best imputation model for crrt and non-crrt datasets

```{r best imputation crrt dataset}

### I add ID to the model in accordance with the thesis I cited below 280823
impute_CREAT_DOS_INT_crrt <- FlucTotIV_clean_crrt[, c("ID","TIME","RATE","AMT","DV","AGE","SEX","BW","LENGTH", "CRRT","OCC","HOSPITAL","CREAT_DOS_INT")]

# Selecting BW instead of BW2 - 011023

```

```{r best imputation nocrrt dataset}

### I add ID to the model in accordance with the thesis I cited below 280823
impute_CREAT_DOS_INT_nocrrt <- FlucTotIV_clean_nocrrt[, c("ID","TIME","RATE","AMT","DV","AGE","SEX","BW","LENGTH","OCC","HOSPITAL","CREAT_DOS_INT")]

# Selecting BW instead of BW2 - 011023

```

#### Then imputing crrt and non-crrt models using mice.impute.2l.pan function, clustering inside ID

```{r for impute_CREAT_DOS_INT_crrt dataset 2l.pan method, warning=FALSE}

# First 10 imputation

set.seed(123)
imp0 <- mice(impute_CREAT_DOS_INT_crrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT","ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_crrt <- mice::mice(data=impute_CREAT_DOS_INT_crrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(124)
imp0 <- mice(impute_CREAT_DOS_INT_crrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT","ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_crrt <- mice::mice(data=impute_CREAT_DOS_INT_crrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(125)
imp0 <- mice(impute_CREAT_DOS_INT_crrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT","ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_crrt <- mice::mice(data=impute_CREAT_DOS_INT_crrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(126)
imp0 <- mice(impute_CREAT_DOS_INT_crrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT","ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_crrt <- mice::mice(data=impute_CREAT_DOS_INT_crrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(127)
imp0 <- mice(impute_CREAT_DOS_INT_crrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT","ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_crrt <- mice::mice(data=impute_CREAT_DOS_INT_crrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

# Can check with density and scatter plot

```

```{r for imputed_CREAT_DOS_INT_nocrrt dataset 2l.pan method, warning=FALSE}

# First 10 imputation

set.seed(123)
imp0 <- mice(impute_CREAT_DOS_INT_nocrrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT", "ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_nocrrt <- mice::mice(data=impute_CREAT_DOS_INT_nocrrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(124)
imp0 <- mice(impute_CREAT_DOS_INT_nocrrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT", "ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_nocrrt <- mice::mice(data=impute_CREAT_DOS_INT_nocrrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(125)
imp0 <- mice(impute_CREAT_DOS_INT_nocrrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT", "ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_nocrrt <- mice::mice(data=impute_CREAT_DOS_INT_nocrrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(126)
imp0 <- mice(impute_CREAT_DOS_INT_nocrrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT", "ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_nocrrt <- mice::mice(data=impute_CREAT_DOS_INT_nocrrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(127)
imp0 <- mice(impute_CREAT_DOS_INT_nocrrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT", "ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_nocrrt <- mice::mice(data=impute_CREAT_DOS_INT_nocrrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(128)
imp0 <- mice(impute_CREAT_DOS_INT_nocrrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT", "ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_nocrrt <- mice::mice(data=impute_CREAT_DOS_INT_nocrrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

# Next 10 imputation

set.seed(129)
imp0 <- mice(impute_CREAT_DOS_INT_nocrrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT", "ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pan"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_nocrrt <- mice::mice(data=impute_CREAT_DOS_INT_nocrrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

#### Then imputing crrt and non-crrt models using mice.impute.2l.pmm function, clustering inside ID

#### Become redundant

```{r for impute_CREAT_DOS_INT_crrt dataset 2l.pmm method,warning=FALSE}

set.seed(123)
imp0 <- mice(impute_CREAT_DOS_INT_crrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT","ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pmm"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_crrt <- mice::mice(data=impute_CREAT_DOS_INT_crrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_crrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_crrt, action = i))$CREAT_DOS_INT
}

```

```{r for imputed_CREAT_DOS_INT_nocrrt dataset 2l.pmm method, warning=FALSE}

set.seed(123)
imp0 <- mice(impute_CREAT_DOS_INT_nocrrt, maxit=0)
predmat <- imp0$predictorMatrix
predmat["CREAT_DOS_INT", "ID"] <- -2
meth <- imp0$method
meth["CREAT_DOS_INT"] <- "2l.pmm"
maxit <- 20
nimp <- 10
imputed_CREAT_DOS_INT_nocrrt <- mice::mice(data=impute_CREAT_DOS_INT_nocrrt,method=meth,predictorMatrix = predmat,maxit=maxit, m=nimp, printFlag = FALSE)
for (i in 1:10) {
        FlucTotIV_clean_nocrrt[[paste0("CREAT", sprintf("%02d", i))]] <- (complete(imputed_CREAT_DOS_INT_nocrrt, action = i))$CREAT_DOS_INT
}

```

#### Adding BW and LENGTH to crrt and non-crrt datasets

```{r using a shorter code to chieve this}

# Define a function to add variables to a dataset
add_variables <- function(dataset, imputed_data, var_name) {
  for (i in 1:10) {
    new_var_name <- paste0(var_name, sprintf("%02d", i))
    dataset[[new_var_name]] <- complete(imputed_data, action = i)[[var_name]]
  }
  return(dataset)
}

# Apply the function to FlucTotIV_clean_crrt and FlucTotIV_clean_nocrrt
FlucTotIV_clean_crrt <- add_variables(FlucTotIV_clean_crrt, imputed_CREAT_DOS_INT_crrt, "BW")
FlucTotIV_clean_crrt <- add_variables(FlucTotIV_clean_crrt, imputed_CREAT_DOS_INT_crrt, "LENGTH")

FlucTotIV_clean_nocrrt <- add_variables(FlucTotIV_clean_nocrrt, imputed_CREAT_DOS_INT_nocrrt, "BW")
FlucTotIV_clean_nocrrt <- add_variables(FlucTotIV_clean_nocrrt, imputed_CREAT_DOS_INT_nocrrt, "LENGTH")

```

#### Then combine 2 datasets into 1 FlucTotIV_clean_imputed dataset

```{r combine into FlucTotIV_clean_imputed}

FlucTotIV_clean_imputed <- rbind(FlucTotIV_clean_crrt, FlucTotIV_clean_nocrrt)
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed[order(FlucTotIV_clean_imputed$ID, FlucTotIV_clean_imputed$HOSPITAL, FlucTotIV_clean_imputed$TIME), ]

```

#### Now average BW and LENGTH per each ID

```{r Integrating mean values to the original dataset, warning = FALSE}
# Creating subset of hospital 3 and 4 patients
subset <- FlucTotIV_clean_imputed %>% filter(HOSPITAL %in% c(3,4))

# Creating new variables for mean values
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
subset[, bw_mean_cols] <- NA
subset[, length_mean_cols] <- NA

# Filling mean values per ID
for (i in unique(subset$ID)) {
  for (j in 1:10) {
    bw_col <- paste0("BW", sprintf("%02d", 1:10))
    length_col <- paste0("LENGTH", sprintf("%02d", 1:10))
    bw_mean_col <- paste0("BW", sprintf("%02d", 1:10), "_mean")
    length_mean_col <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
    subset[subset$ID == i, bw_mean_col[j]] <- mean(subset[subset$ID == i, ][[bw_col[j]]], na.rm = TRUE)
    subset[subset$ID == i, length_mean_col[j]] <- mean(subset[subset$ID == i, ][[length_col[j]]], na.rm = TRUE)
  }
}

# Integrating mean values to the original dataset
FlucTotIV_clean_imputed[, bw_mean_cols] <- NA
FlucTotIV_clean_imputed[, length_mean_cols] <- NA
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, bw_mean_cols] <- subset[, bw_mean_cols]
FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$ID %in% subset$ID, length_mean_cols] <- subset[, length_mean_cols]

```

```{r Replace values of 20 columns with mean values in hospital 3 and 4}
# Replace values of 20 columns with mean values in hospital 3 and 4
for (j in 1:10) {
  bw_col <- paste0("BW", sprintf("%02d", j))
  length_col <- paste0("LENGTH", sprintf("%02d", j))
  bw_mean_col <- paste0("BW", sprintf("%02d", j), "_mean")
  length_mean_col <- paste0("LENGTH", sprintf("%02d", j), "_mean")
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), bw_mean_col]
  FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_col] <- FlucTotIV_clean_imputed[FlucTotIV_clean_imputed$HOSPITAL %in% c(3, 4), length_mean_col]
}

# Delete the 20 mean columns
bw_mean_cols <- paste0("BW", sprintf("%02d", 1:10), "_mean")
length_mean_cols <- paste0("LENGTH", sprintf("%02d", 1:10), "_mean")
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>% select(-one_of(bw_mean_cols), -one_of(length_mean_cols))

```

#### Averaging CREAT per ID and OCC, where CREAT_DOS_INT is missing

```{r average accross ID and OCC where CREAT_DOS_INT is missing, warning=FALSE}

# Create a subset of rows with missing CREAT_DOS_INT
subset <- FlucTotIV_clean_imputed %>% filter(is.na(CREAT_DOS_INT))

# Calculate the mean values per ID and OCC
mean_cols <- paste0("CREAT", sprintf("%02d", 1:10))
subset <- subset %>%
  group_by(ID, OCC) %>%
  mutate(across(mean_cols, mean, na.rm = TRUE)) %>%
  ungroup()

# Replace the mean across ID and OCC in the actual dataset

FlucTotIV_clean_imputed[is.na(FlucTotIV_clean_imputed$CREAT_DOS_INT), mean_cols] <- subset[, mean_cols]

```

#### Fixing all the negative imputed values to 0 or minimum possible values

```{r fixing negative values to 0}

# Probably before this, I need to calculate the % of negative values first
negative_percentage_CREAT <- sapply(FlucTotIV_clean_imputed[, c("CREAT01", "CREAT02", "CREAT03", "CREAT04", "CREAT05", "CREAT06", "CREAT07", "CREAT08", "CREAT09", "CREAT10")], function(col) {
  sum(col < 0, na.rm = TRUE) / length(col) * 100
})
# ranging from 1.8 to 4%

View(negative_percentage_CREAT)
str(negative_percentage_CREAT)

# Replace negative values with respective min positive values of CREAT01 to CREAT10 columns - 02/10/23
#FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>%
  #mutate_at(vars(CREAT01:CREAT10), ~ ifelse(. < 0, min(.[. > 0]), .))

# I'll try with the minimum observed value instead - 02/10/23
FlucTotIV_clean_imputed <- FlucTotIV_clean_imputed %>%
  mutate_at(vars(CREAT01:CREAT10), ~ ifelse(. < 0, min(CREAT,na.rm=TRUE), .))

```

#### Making violin plot when fixing to 0 (2l.pan method)

```{r make violin plots of observed and imputed CREAT values, warning=FALSE}

# Select the 11 columns by specifying their names explicitly
CREAT_columns <- FlucTotIV_clean_imputed %>%
  select(CREAT_DOS_INT, CREAT01, CREAT02, CREAT03, CREAT04, CREAT05, CREAT06, CREAT07, CREAT08, CREAT09, CREAT10)

# Convert from wide to long
CREAT_long_data <- CREAT_columns %>%
  pivot_longer(cols = everything(), 
               names_to = "Imputation", 
               values_to = "Value")

# Rename the levels of the "Imputation" column
CREAT_long_data$Imputation <- factor(CREAT_long_data$Imputation, 
                                levels = c("CREAT_DOS_INT", "CREAT01", "CREAT02", "CREAT03", "CREAT04", "CREAT05", "CREAT06", "CREAT07", "CREAT08", "CREAT09", "CREAT10"))

# Define a custom color palette
custom_palette <- c("skyblue", "lightgreen", "pink", "orange", "purple",
                    "lightblue", "salmon", "gold", "lightpink", "lightgray", "lightcyan")

# Create a violin plot with custom aesthetics
violin_plot<- ggplot(data = CREAT_long_data, aes(x = Imputation, y = Value, fill = Imputation)) +
  geom_violin(trim = FALSE) +
  labs(title = "Violin Plot of Observed and 10 Imputed CREAT",
       x = NULL,
       y = "Serum Creatinine (mg/dl)") +
  scale_x_discrete(labels = c("Observed", "Imputation 01", "Imputation 02", 
                              "Imputation 03", "Imputation 04", "Imputation 05", 
                              "Imputation 06", "Imputation 07", "Imputation 08", 
                              "Imputation 09", "Imputation 10")) +
  scale_fill_manual(values = custom_palette) +
  theme_bw() +
  theme(legend.position = "none",
        plot.title = element_text(hjust = 0.5, color = "black", size = 16, face = "bold"),
        axis.text.x = element_text(color = "black", size = 12),
        axis.text.y = element_text(color = "black", size = 12),
        axis.title.y = element_text(color = "black", size = 14, face = "bold"))

# Exporting the plot

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/with_dos_int/diagnostic_plots/Violin plots")
ggsave("obs_vs_imp_violin.png", plot = violin_plot, dpi = 300, width = 13, height = 7)

```

#### Calculating the CKDEPI of the imputed values

```{r calculating CKDEPI01 to CKDEPI10 using a short code}

# Assuming FlucTotIV_clean_imputed is your dataset
Fluc_NONMEM_mul_impute <- FlucTotIV_clean_imputed

# Define a function to calculate CKDEPI for each CKDEPI column
calculate_CKDEPI <- function(data, creatinine_column, sex_column, age_column, multiplier) {
  CKDEPI <- ifelse(data[[sex_column]] == 1 & data[[creatinine_column]] < 0.9,
                   multiplier * ((data[[creatinine_column]]/0.9)^-0.302) * (0.9938^data[[age_column]]),
                   ifelse(data[[sex_column]] == 1 & data[[creatinine_column]] >= 0.9,
                          multiplier * ((data[[creatinine_column]]/0.9)^-1.200) * (0.9938^data[[age_column]]),
                          ifelse(data[[sex_column]] == 2 & data[[creatinine_column]] < 0.7,
                                 multiplier * ((data[[creatinine_column]]/0.7)^-0.241) * (0.9938^data[[age_column]]) * 1.012,
                                 multiplier * ((data[[creatinine_column]]/0.7)^-1.200) * (0.9938^data[[age_column]]) * 1.012)
                   )
  )
  return(CKDEPI)
}

# Calculate CKDEPI01 to CKDEPI10
for (i in 1:10) {
  CKDEPI_column <- paste0("CKDEPI", sprintf("%02d", i))
  Fluc_NONMEM_mul_impute[[CKDEPI_column]] <- calculate_CKDEPI(Fluc_NONMEM_mul_impute, 
                                                               paste0("CREAT", sprintf("%02d", i)), 
                                                               "SEX", "AGE", 142)
}

# View the resulting dataset
View(Fluc_NONMEM_mul_impute)

```

#### Making individual plots to compare between interval variability

```{r making invidivual plots comparing BIV}

# creating a new CREAT_imputed column

Fluc_NONMEM_mul_impute$Creat_imputed<-ifelse(Fluc_NONMEM_mul_impute$unique_CREAT==0,1,0)

# subset data that has both imputed and non-imputed CREAT

Imputed_ID <- Fluc_NONMEM_mul_impute %>%
  group_by(ID) %>%
  filter(all(c(0, 1) %in% Creat_imputed)) %>%
  ungroup()

# Count the number of distinct ID
Imputed_ID %>%
  distinct(ID) %>%
  n_distinct()

# Eliminate all the duplicates ID, OCC, unique_CREAT and Creat_imputed from Imputed_data dataset

unique_Imputed_ID <- Imputed_ID %>%
  distinct(ID, OCC, unique_CREAT, Creat_imputed, .keep_all = TRUE)

# Need to recalculate CKDEPI still. I use calculate_CKDEPI function from above

unique_Imputed_ID[["CKDEPI"]] <- calculate_CKDEPI(unique_Imputed_ID, 
                                                              "CREAT", 
                                                               "SEX", "AGE", 142)

# Relocate CKDEPI column right next to CKDEPI01

unique_Imputed_ID <- unique_Imputed_ID %>%
  relocate(CKDEPI, .before = CKDEPI01)

# Select patients with at least two OCC of unique_CREAT of at least 1

OCC_two_CREAT_ID <- unique_Imputed_ID %>%
  group_by(ID) %>%
  filter(n_distinct(OCC) >= 2 & sum(unique_CREAT >= 1, na.rm = TRUE) >= 2) %>%
  select(ID) %>%
  distinct()

OCC_two_CREAT <- unique_Imputed_ID %>%
  filter(ID %in% OCC_two_CREAT_ID$ID)

# Converting from short to longer format

Imputed_Creat_Long <- OCC_two_CREAT %>%
  pivot_longer(cols = c(CKDEPI01, CKDEPI02, CKDEPI03, CKDEPI04, CKDEPI05, CKDEPI06, CKDEPI07, CKDEPI08, CKDEPI09, CKDEPI10),                names_to = "Imputed_CKDEPI", 
               values_to = "Value") %>%
  select(ID,OCC,TIME, Imputed_CKDEPI, Creat_imputed, Value)

# And making scatter plots

Imputed_Creat_Long <- Imputed_Creat_Long %>%
  mutate(Creat_imputed = factor(Creat_imputed, levels = c(0, 1), labels = c("No", "Yes")),  # Convert Creat_imputed to factor with labels
         ID = as.integer(ID))  # Create a numerical ID for grouping

# Define the title and label options
title_options <- list(
  label = "CKDEPI over Time of the first 10 imputations",
  size = 14,
  color = "black",
  hjust = 0.5,
  vjust = 1,
  face = "bold"
)

x_label_options <- list(
  label = "Time (h)",
  size = 12,
  color = "black",
  hjust = 0.5,
  vjust = 0
)

y_label_options <- list(
  label = "CKDEPI (ml/min/1.73m2)",
  size = 12,
  color = "black",
  hjust = 0,
  vjust = 0.5,
  angle = 0
)

axis_text_options <- list(
  size = 10
)

legend_options <- list(
  title = "CREAT Imputed",
  size = 8
)

# Create a function to generate scatter plots with custom styling
create_scatter_plots <- function(data, ids) {
  max_value <- max(data[data$ID %in% ids, ]$Value)  # Maximum Value for setting y-axis limit
  ggplot(data = data[data$ID %in% ids, ], aes(x = TIME, y = Value, color = Creat_imputed)) +
    geom_point (size = 3, alpha = 1) +
    facet_wrap(~ID, ncol = 2) +
    labs(title = title_options,
         x = x_label_options,
         y = y_label_options) +
    scale_color_manual(values = c("No" = "dodgerblue4", "Yes" = "goldenrod1"), 
                       name = legend_options) +
   scale_y_continuous(limits = c(0, max_value*1.1), breaks = seq(0, max_value*1.1, by = 10)) +
   # Set y-axis limit
    theme_bw() +
    theme(
      plot.title = element_text(hjust = 0.5),
      axis.text = element_text(axis_text_options),
      legend.position = "bottom"
    )
}

# Split the patient IDs into groups of 2 for paneling
id_groups <- split(unique(Imputed_Creat_Long$ID), ceiling(seq_along(unique(Imputed_Creat_Long$ID))/2))
# Create the scatter plots in panels
panel_plots <- lapply(id_groups, function(ids) {
  create_scatter_plots(Imputed_Creat_Long, ids)
})

# Export the plots as high-resolution images
output_dir <- "C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Plots/2l.pan method"
#output_dir <- "C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Plots/2l.pmm method"
if (!dir.exists(output_dir)) dir.create(output_dir)

for (i in seq_along(panel_plots)) {
  ggsave(filename = paste0(output_dir, "/scatter_plot_panel_", i, ".png"),
         plot = panel_plots[[i]],
         width = 10,
         height = 7,
         dpi = 300)
}

```

#### Converting all NAs to -99

```{r NAs to -99}

Fluc_NONMEM_mul_impute[is.na(Fluc_NONMEM_mul_impute)] <- -99

```

#### Convert back to NONMEM format

```{r DV from 0 & -99 to "."}

Fluc_NONMEM_mul_impute$DV <- ifelse(Fluc_NONMEM_mul_impute$DV %in% c(0, -99), ".", Fluc_NONMEM_mul_impute$DV)

```

```{r AMT TAD and RATE from 0 to "."}

Fluc_NONMEM_mul_impute$TAD <- ifelse(Fluc_NONMEM_mul_impute$TAD == 0, ".", Fluc_NONMEM_mul_impute$TAD)
Fluc_NONMEM_mul_impute$AMT <- ifelse(Fluc_NONMEM_mul_impute$AMT == 0, ".", Fluc_NONMEM_mul_impute$AMT)
Fluc_NONMEM_mul_impute$RATE <- ifelse(Fluc_NONMEM_mul_impute$RATE == 0, ".", Fluc_NONMEM_mul_impute$RATE)

```

#### Exporting BW dataset

```{r select appropriate variables}

FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT","CREAT3","CRRT2","dosing_interval","Creat_imputed")]

```

```{r Fluc_NONMEM_mul_impute_BW01 dataset, warning=FALSE}

# When using 2l.pan method
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan")

# First 10 imputation
#write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW01.csv",quote=F,row.names = FALSE)

# Next 10 imputation
# write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW02.csv",quote=F,row.names = FALSE)

# Next 10 imputation
#write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW03.csv",quote=F,row.names = FALSE)

# Next 10 imputation
# write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW04.csv",quote=F,row.names = FALSE)

# Next 10 imputation
# write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW05.csv",quote=F,row.names = FALSE)

# Next 10 imputation
#write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW06.csv",quote=F,row.names = FALSE)

# Next 10 imputation
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW07.csv",quote=F,row.names = FALSE)

# When using 2l.pmm method
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pmm")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_BW01.csv",quote=F,row.names = FALSE)

```

#### Adding ARC column, using the CKDEPI cut-off of 96.5 ml/min

```{r creating ARC01 to ARC10 columns corresponding to CKDEPI01 to CKDEPI10}

# Define a vector of column names from CKDEPI01 to CKDEPI10
ckdepi_cols <- paste0("CKDEPI", sprintf("%02d", 1:10))

# Loop through each column and create the corresponding ARC column
for (i in 1:10) {
  col_name <- paste0("ARC", sprintf("%02d", i))
  FlucTotIV_clean_imputed[[col_name]] <- as.integer(FlucTotIV_clean_imputed[[ckdepi_cols[i]]] >= 96.5)
}

# Creating a new dataset

FlucTotIV_clean_imputed_ARC <- FlucTotIV_clean_imputed

# Eliminating CKDEPI01 to CKDEPI10
FlucTotIV_clean_imputed_ARC <- FlucTotIV_clean_imputed_ARC %>%
  select(-CKDEPI01, -CKDEPI02, -CKDEPI03, -CKDEPI04, -CKDEPI05, 
         -CKDEPI06, -CKDEPI07, -CKDEPI08, -CKDEPI09, -CKDEPI10)

```

#### Exporting ARC dataset

```{r Fluc_NONMEM_mul_impute_ARC01 dataset, warning=FALSE}

# When using 2l.pmm method
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pmm")
write.csv(FlucTotIV_clean_imputed_ARC, "Fluc_NONMEM_mul_impute_ARC01.csv",quote=F,row.names = FALSE)

# When using 2l.pan method
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan")

# First 10 imputations
#write.csv(FlucTotIV_clean_imputed_ARC, "Fluc_NONMEM_mul_impute_ARC01.csv",quote=F,row.names = FALSE)

# The next 10 imputations
# write.csv(FlucTotIV_clean_imputed_ARC, "Fluc_NONMEM_mul_impute_ARC02.csv",quote=F,row.names = FALSE)

# The next 10 imputations
# write.csv(FlucTotIV_clean_imputed_ARC, "Fluc_NONMEM_mul_impute_ARC03.csv",quote=F,row.names = FALSE)

# The next 10 imputations
# write.csv(FlucTotIV_clean_imputed_ARC, "Fluc_NONMEM_mul_impute_ARC04.csv",quote=F,row.names = FALSE)

# The next 10 imputations
# write.csv(FlucTotIV_clean_imputed_ARC, "Fluc_NONMEM_mul_impute_ARC05.csv",quote=F,row.names = FALSE)

# The next 10 imputations
# write.csv(FlucTotIV_clean_imputed_ARC, "Fluc_NONMEM_mul_impute_ARC06.csv",quote=F,row.names = FALSE)

# The next 10 imputations
write.csv(FlucTotIV_clean_imputed_ARC, "Fluc_NONMEM_mul_impute_ARC07.csv",quote=F,row.names = FALSE)

```

#### Pooling parameters of 70 2l.pan imputed models - 051023

```{r set wd, warning=FALSE}

# Read in the dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooling_Parameters_2l.pan<-read.csv("Pooling_Parameters_2l.pan_051023.csv",sep=";")

# Creating Var (Variance) column 
Pooling_Parameters_2l.pan$Var<-(Pooling_Parameters_2l.pan$RSE*Pooling_Parameters_2l.pan$Estimates/100)^2

```

##### First of all, CKDEPI

```{r calculate Mean Within and Between Subject variability for all}

CKDEPI<-mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "CKDEPI"]) #0.4794

W_CKDEPI<-mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "CKDEPI"]) #0.0255248 #within imputation variance

B_CKDEPI<-var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "CKDEPI"]) #0.008850446 #between imputation variance

CKDEPI
W_CKDEPI
B_CKDEPI

```

```{r total variance for all}

m<-70
T_CKDEPI<-W_CKDEPI+(1+1/m)*B_CKDEPI #0.03450169
T_CKDEPI

```

```{r confidence interval - T distribution}
m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_CKDEPI<-(B_CKDEPI+B_CKDEPI/m)/T_CKDEPI #proportion of variation attributable to the missing data
r_CKDEPI<-(lambda_CKDEPI)/(1-lambda_CKDEPI) #relative increase in variance due to nonresponse
v_old_CKDEPI<-(m-1)*(1+1/r_CKDEPI^2) #old degree of freedom
v_com=n-k #degree of freedom of parameter estimate (CKDEPI) in the hypothetically complete data
v_obs_CKDEPI=((v_com+1)/(v_com+3))*v_com*(1-lambda_CKDEPI) #observed data degrees of freedom that accounts for the missing information
v_CKDEPI<-(v_old_CKDEPI*v_obs_CKDEPI)/(v_old_CKDEPI+v_obs_CKDEPI) 
t_crit_CKDEPI <- qt(0.975, v_CKDEPI) 

lower_bound_CKDEPI<-CKDEPI-t_crit_CKDEPI*sqrt(T_CKDEPI) #0.1109361
upper_bound_CKDEPI<-CKDEPI+t_crit_CKDEPI*sqrt(T_CKDEPI) #0.8478639

lower_bound_CKDEPI
upper_bound_CKDEPI

```

##### Second of all, CLcrrt

```{r calculate Mean Within and Between Subject variability for all}

CLcrrt<-mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "CLcrrt"]) #1.691857

W_CLcrrt<-mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "CLcrrt"]) #0.018215 #within imputation variance

B_CLcrrt<-var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "CLcrrt"]) #2.113872e-05 #between imputation variance

CLcrrt
W_CLcrrt
B_CLcrrt

```

```{r total variance for all}

m<-70
T_CLcrrt<-W_CLcrrt+(1+1/m)*B_CLcrrt #0.01823644
T_CLcrrt

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_CLcrrt<-(B_CLcrrt+B_CLcrrt/m)/T_CLcrrt #proportion of variation attributable to the missing data

r_CLcrrt<-(lambda_CLcrrt)/(1-lambda_CLcrrt) #relative increase in variance due to nonresponse

v_old_CLcrrt<-(m-1)*(1+1/r_CLcrrt^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (CLcrrt) in the hypothetically complete data

v_obs_CLcrrt=((v_com+1)/(v_com+3))*v_com*(1-lambda_CLcrrt) #observed data degrees of freedom that accounts for the missing information

v_CLcrrt<-(v_old_CLcrrt*v_obs_CLcrrt)/(v_old_CLcrrt+v_obs_CLcrrt)

t_crit_CLcrrt <- qt(0.975, v_CLcrrt) 

lower_bound_CLcrrt<-CLcrrt-t_crit_CLcrrt*sqrt(T_CLcrrt) #1.425197
upper_bound_CLcrrt<-CLcrrt+t_crit_CLcrrt*sqrt(T_CLcrrt) #1.958517

lower_bound_CLcrrt
upper_bound_CLcrrt

```

##### Third of all, CLr

```{r calculate Mean Within and Between Subject variability for all}

CLr<-mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "CLr"]) #0.6262857

W_CLr<-mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "CLr"]) #0.0009582094 #within imputation variance

B_CLr<-var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "CLr"]) #4.759834e-05
#between imputation variance

CLr
W_CLr
B_CLr

```

```{r total variance for all}

m<-70
T_CLr<-W_CLr+(1+1/m)*B_CLr #0.001006488
T_CLr

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_CLr<-(B_CLr+B_CLr/m)/T_CLr #proportion of variation attributable to the missing data

r_CLr<-(lambda_CLr)/(1-lambda_CLr) #relative increase in variance due to nonresponse

v_old_CLr<-(m-1)*(1+1/r_CLr^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (CLr) in the hypothetically complete data

v_obs_CLr=((v_com+1)/(v_com+3))*v_com*(1-lambda_CLr) #observed data degrees of freedom that accounts for the missing information

v_CLr<-(v_old_CLr*v_obs_CLr)/(v_old_CLr+v_obs_CLr)

t_crit_CLr <- qt(0.975, v_CLr) 

lower_bound_CLr<-CLr-t_crit_CLr*sqrt(T_CLr) #0.5636141
upper_bound_CLr<-CLr+t_crit_CLr*sqrt(T_CLr) #0.6889574

lower_bound_CLr
upper_bound_CLr

```

##### Next, V1

```{r calculate Mean Within and Between Subject variability for all}

V1<-mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "V1"]) #38.51857

W_V1<-mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "V1"]) #11.20266 #within imputation variance

B_V1<-var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "V1"]) #0.101824
#between imputation variance

V1
W_V1
B_V1

```

```{r total variance for all}

m<-70
T_V1<-W_V1+(1+1/m)*B_V1 #11.30594
T_V1

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_V1<-(B_V1+B_V1/m)/T_V1 #proportion of variation attributable to the missing data

r_V1<-(lambda_V1)/(1-lambda_V1) #relative increase in variance due to nonresponse

v_old_V1<-(m-1)*(1+1/r_V1^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (V1) in the hypothetically complete data

v_obs_V1=((v_com+1)/(v_com+3))*v_com*(1-lambda_V1) #observed data degrees of freedom that accounts for the missing information

v_V1<-(v_old_V1*v_obs_V1)/(v_old_V1+v_obs_V1)

t_crit_V1 <- qt(0.975, v_V1) 

lower_bound_V1<-V1-t_crit_V1*sqrt(T_V1) #31.87858
upper_bound_V1<-V1+t_crit_V1*sqrt(T_V1) #45.15857

lower_bound_V1
upper_bound_V1

```

##### After that, Q

```{r calculate Mean Within and Between Subject variability for all}

Q<-mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "Q"]) #12.33286

W_Q<-mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "Q"]) #23.7237 #within imputation variance

B_Q<-var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "Q"]) #0.05933954
#between imputation variance

Q
W_Q
B_Q

```

```{r total variance for all}

m<-70
T_Q<-W_Q+(1+1/m)*B_Q #23.78388
T_Q

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_Q<-(B_Q+B_Q/m)/T_Q #proportion of variation attributable to the missing data

r_Q<-(lambda_Q)/(1-lambda_Q) #relative increase in variance due to nonresponse

v_old_Q<-(m-1)*(1+1/r_Q^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (Q) in the hypothetically complete data

v_obs_Q=((v_com+1)/(v_com+3))*v_com*(1-lambda_Q) #observed data degrees of freedom that accounts for the missing information

v_Q<-(v_old_Q*v_obs_Q)/(v_old_Q+v_obs_Q)

t_crit_Q <- qt(0.975, v_Q) 

lower_bound_Q<-Q-t_crit_Q*sqrt(T_Q) #2.702697
upper_bound_Q<-Q+t_crit_Q*sqrt(T_Q) #21.96302

lower_bound_Q
upper_bound_Q

```

##### Next, V2

```{r calculate Mean Within and Between Subject variability for all}

V2<-mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "V2"]) #8.714286

W_V2<-mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "V2"]) #9.882814 #within imputation variance

B_V2<-var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "V2"]) #0.005677019
#between imputation variance

V2
W_V2
B_V2

```

```{r total variance for all}

m<-70
T_V2<-W_V2+(1+1/m)*B_V2 #9.888572
T_V2

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_V2<-(B_V2+B_V2/m)/T_V2 #proportion of variation attributable to the missing data

r_V2<-(lambda_V2)/(1-lambda_V2) #relative increase in variance due to nonresponse

v_old_V2<-(m-1)*(1+1/r_V2^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (V2) in the hypothetically complete data

v_obs_V2=((v_com+1)/(v_com+3))*v_com*(1-lambda_V2) #observed data degrees of freedom that accounts for the missing information

v_V2<-(v_old_V2*v_obs_V2)/(v_old_V2+v_obs_V2)

t_crit_V2 <- qt(0.975, v_V2) 

lower_bound_V2<-V2-t_crit_V2*sqrt(T_V2) #2.504844
upper_bound_V2<-V2+t_crit_V2*sqrt(T_V2) #14.92373

lower_bound_V2
upper_bound_V2

```

##### Next, BW

```{r calculate Mean Within and Between Subject variability for all}

BW<-mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "BW"]) #1.032786

W_BW<-mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "BW"]) #0.03541545 #within imputation variance

B_BW<-var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "BW"]) #0.0003502578
#between imputation variance

BW
W_BW
B_BW

```

```{r total variance for all}

m<-70
T_BW<-W_BW+(1+1/m)*B_BW #0.03577071
T_BW

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_BW<-(B_BW+B_BW/m)/T_BW #proportion of variation attributable to the missing data

r_BW<-(lambda_BW)/(1-lambda_BW) #relative increase in variance due to nonresponse

v_old_BW<-(m-1)*(1+1/r_BW^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (BW) in the hypothetically complete data

v_obs_BW=((v_com+1)/(v_com+3))*v_com*(1-lambda_BW) #observed data degrees of freedom that accounts for the missing information

v_BW<-(v_old_BW*v_obs_BW)/(v_old_BW+v_obs_BW)

t_crit_BW <- qt(0.975, v_BW) 

lower_bound_BW<-BW-t_crit_BW*sqrt(T_BW) #0.659294
upper_bound_BW<-BW+t_crit_BW*sqrt(T_BW) #1.406277

lower_bound_BW
upper_bound_BW

```

##### Next, Cov_CLr_V1

```{r for this special case I need preliminary treatment}

# First of all, replacing the Var with the values in RSE column

Pooling_Parameters_2l.pan <- Pooling_Parameters_2l.pan %>%
  mutate(Var = ifelse(Parameters == "Cov_CLr_V1", RSE^2, Var))

# Second of all, replacing the values of the RSE column

Pooling_Parameters_2l.pan <- Pooling_Parameters_2l.pan %>%
mutate(RSE = ifelse(Parameters == "Cov_CLr_V1", (RSE/Estimates)*100, RSE))

```

```{r calculate Mean Within and Between Subject variability for all}

Cov_CLr_V1<-mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "Cov_CLr_V1"]) #0.07843

W_Cov_CLr_V1<-mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "Cov_CLr_V1"]) #0.001475356 #within imputation variance

B_Cov_CLr_V1<-var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "Cov_CLr_V1"]) #1.735083e-05
#between imputation variance

Cov_CLr_V1
W_Cov_CLr_V1
B_Cov_CLr_V1

```

```{r total variance for all}

m<-70
T_Cov_CLr_V1<-W_Cov_CLr_V1+(1+1/m)*B_Cov_CLr_V1 #0.001492955
T_Cov_CLr_V1

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_Cov_CLr_V1<-(B_Cov_CLr_V1+B_Cov_CLr_V1/m)/T_Cov_CLr_V1 #proportion of variation attributable to the missing data

r_Cov_CLr_V1<-(lambda_Cov_CLr_V1)/(1-lambda_Cov_CLr_V1) #relative increase in variance due to nonresponse

v_old_Cov_CLr_V1<-(m-1)*(1+1/r_Cov_CLr_V1^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (Cov_CLr_V1) in the hypothetically complete data

v_obs_Cov_CLr_V1=((v_com+1)/(v_com+3))*v_com*(1-lambda_Cov_CLr_V1) #observed data degrees of freedom that accounts for the missing information

v_Cov_CLr_V1<-(v_old_Cov_CLr_V1*v_obs_Cov_CLr_V1)/(v_old_Cov_CLr_V1+v_obs_Cov_CLr_V1)

t_crit_Cov_CLr_V1 <- qt(0.975, v_Cov_CLr_V1) 

lower_bound_Cov_CLr_V1<-Cov_CLr_V1-t_crit_Cov_CLr_V1*sqrt(T_Cov_CLr_V1) #0.002126054
upper_bound_Cov_CLr_V1<-Cov_CLr_V1+t_crit_Cov_CLr_V1*sqrt(T_Cov_CLr_V1) #0.1547339

lower_bound_Cov_CLr_V1
upper_bound_Cov_CLr_V1

```

##### Thereafter, with IIVs and Prop.Err, they are variance terms, so I will log-transform them first, then use Rubin's Rule to pool the parameter estimates, then back-transform to get the actual esmates

```{r create a log-transformed Log column}

Pooling_Parameters_2l.pan$Log<-log(Pooling_Parameters_2l.pan$Estimates)

```

```{r create a Var_Log variable}

# Variance of the log-transformed variable

Pooling_Parameters_2l.pan$Var_Log<-(1/(Pooling_Parameters_2l.pan$Estimates))^2*Pooling_Parameters_2l.pan$Var #Var(log(x))=[1/(mean(x))]^2*var(x) (log(x) in R is actually ln(x))

```

##### First, we deal with IIV_CLcrrt log-transformed estimate - IIV_CLcrrt_log, then back-transform to IIV_CLcrrt

```{r calculate Mean Within and Between Subject variability for all}

IIV_CLcrrt_log<-mean(Pooling_Parameters_2l.pan$Log[Pooling_Parameters_2l.pan$Parameters == "IIV_CLcrrt"]) #1.723017

W_IIV_CLcrrt_log<-mean(Pooling_Parameters_2l.pan$Var_Log[Pooling_Parameters_2l.pan$Parameters == "IIV_CLcrrt"]) #0.1443013 #within imputation variance

B_IIV_CLcrrt_log<-var(Pooling_Parameters_2l.pan$Log[Pooling_Parameters_2l.pan$Parameters == "IIV_CLcrrt"]) #0.0001843056 #between imputation variance

IIV_CLcrrt_log
W_IIV_CLcrrt_log
B_IIV_CLcrrt_log

```

```{r total variance for log-transformed variable}

m<-70
T_IIV_CLcrrt_log<-W_IIV_CLcrrt_log+(1+1/m)*B_IIV_CLcrrt_log #0.1444883
T_IIV_CLcrrt_log

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_IIV_CLcrrt_log<-(B_IIV_CLcrrt_log+B_IIV_CLcrrt_log/m)/T_IIV_CLcrrt_log #proportion of variation attributable to the missing data

r_IIV_CLcrrt_log<-(lambda_IIV_CLcrrt_log)/(1-lambda_IIV_CLcrrt_log) #relative increase in variance due to nonresponse

v_old_IIV_CLcrrt_log<-(m-1)*(1+1/r_IIV_CLcrrt_log^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (IIV_CLcrrt_log) in the hypothetically complete data

v_obs_IIV_CLcrrt_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_CLcrrt_log) #observed data degrees of freedom that accounts for the missing information

v_IIV_CLcrrt_log<-(v_old_IIV_CLcrrt_log*v_obs_IIV_CLcrrt_log)/(v_old_IIV_CLcrrt_log+v_obs_IIV_CLcrrt_log)

t_crit_IIV_CLcrrt_log <- qt(0.975, v_IIV_CLcrrt_log) 

lower_bound_IIV_CLcrrt_log<-IIV_CLcrrt_log-t_crit_IIV_CLcrrt_log*sqrt(T_IIV_CLcrrt_log) #-2.47361
upper_bound_IIV_CLcrrt_log<-IIV_CLcrrt_log+t_crit_IIV_CLcrrt_log*sqrt(T_IIV_CLcrrt_log) #-0.9724246

lower_bound_IIV_CLcrrt_log
upper_bound_IIV_CLcrrt_log

```

```{r back transform IIV_CLcrrt_log to IIV_CLcrrt}

IIV_CLcrrt<-exp(IIV_CLcrrt_log) #0.1785267

lower_bound_IIV_CLcrrt<-exp(lower_bound_IIV_CLcrrt_log) #0.08428006

upper_bound_IIV_CLcrrt<-exp(upper_bound_IIV_CLcrrt_log) #0.378165

IIV_CLcrrt

lower_bound_IIV_CLcrrt

upper_bound_IIV_CLcrrt

```

##### Second, we deal with IIV_CLr log-transformed estimate - IIV_CLr_log, then back-transform to IIV_CLr

```{r calculate Mean Within and Between Subject variability for all}

IIV_CLr_log<-mean(Pooling_Parameters_2l.pan$Log[Pooling_Parameters_2l.pan$Parameters == "IIV_CLr"]) #-1.511388

W_IIV_CLr_log<-mean(Pooling_Parameters_2l.pan$Var_Log[Pooling_Parameters_2l.pan$Parameters == "IIV_CLr"]) #0.0377679 #within imputation variance

B_IIV_CLr_log<-var(Pooling_Parameters_2l.pan$Log[Pooling_Parameters_2l.pan$Parameters == "IIV_CLr"]) #0.001016345 #between imputation variance

IIV_CLr_log
W_IIV_CLr_log
B_IIV_CLr_log

```

```{r total variance for log-transformed variable}

m<-70
T_IIV_CLr_log<-W_IIV_CLr_log+(1+1/m)*B_IIV_CLr_log #0.001016345
T_IIV_CLr_log

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_IIV_CLr_log<-(B_IIV_CLr_log+B_IIV_CLr_log/m)/T_IIV_CLr_log #proportion of variation attributable to the missing data

r_IIV_CLr_log<-(lambda_IIV_CLr_log)/(1-lambda_IIV_CLr_log) #relative increase in variance due to nonresponse

v_old_IIV_CLr_log<-(m-1)*(1+1/r_IIV_CLr_log^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (IIV_CLr_log) in the hypothetically complete data

v_obs_IIV_CLr_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_CLr_log) #observed data degrees of freedom that accounts for the missing information

v_IIV_CLr_log<-(v_old_IIV_CLr_log*v_obs_IIV_CLr_log)/(v_old_IIV_CLr_log+v_obs_IIV_CLr_log)

t_crit_IIV_CLr_log <- qt(0.975, v_IIV_CLr_log) 

lower_bound_IIV_CLr_log<-IIV_CLr_log-t_crit_IIV_CLr_log*sqrt(T_IIV_CLr_log) #-1.900422
upper_bound_IIV_CLr_log<-IIV_CLr_log+t_crit_IIV_CLr_log*sqrt(T_IIV_CLr_log) #-1.122355

lower_bound_IIV_CLr_log
upper_bound_IIV_CLr_log

```

```{r back transform IIV_CLr_log to IIV_CLr}

IIV_CLr<-exp(IIV_CLr_log) #0.2206035

lower_bound_IIV_CLr<-exp(lower_bound_IIV_CLr_log) #0.1495055

upper_bound_IIV_CLr<-exp(upper_bound_IIV_CLr_log) #0.3255125

IIV_CLr

lower_bound_IIV_CLr

upper_bound_IIV_CLr

```

##### After that, we deal with IIV_V1 log-transformed estimate - IIV_V1_log, then back-transform to IIV_V1

```{r calculate Mean Within and Between Subject variability for all}

IIV_V1_log<-mean(Pooling_Parameters_2l.pan$Log[Pooling_Parameters_2l.pan$Parameters == "IIV_V1"]) #-1.240382

W_IIV_V1_log<-mean(Pooling_Parameters_2l.pan$Var_Log[Pooling_Parameters_2l.pan$Parameters == "IIV_V1"]) #0.0452367 #within imputation variance

B_IIV_V1_log<-var(Pooling_Parameters_2l.pan$Log[Pooling_Parameters_2l.pan$Parameters == "IIV_V1"]) #0.0001839721 #between imputation variance

IIV_V1_log
W_IIV_V1_log
B_IIV_V1_log

```

```{r total variance for log-transformed variable}

m<-70
T_IIV_V1_log<-W_IIV_V1_log+(1+1/m)*B_IIV_V1_log #0.0454233
T_IIV_V1_log

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_IIV_V1_log<-(B_IIV_V1_log+B_IIV_V1_log/m)/T_IIV_V1_log #proportion of variation attributable to the missing data

r_IIV_V1_log<-(lambda_IIV_V1_log)/(1-lambda_IIV_V1_log) #relative increase in variance due to nonresponse

v_old_IIV_V1_log<-(m-1)*(1+1/r_IIV_V1_log^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (IIV_V1_log) in the hypothetically complete data

v_obs_IIV_V1_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_IIV_V1_log) #observed data degrees of freedom that accounts for the missing information

v_IIV_V1_log<-(v_old_IIV_V1_log*v_obs_IIV_V1_log)/(v_old_IIV_V1_log+v_obs_IIV_V1_log)

t_crit_IIV_V1_log <- qt(0.975, v_IIV_V1_log) 

lower_bound_IIV_V1_log<-IIV_V1_log-t_crit_IIV_V1_log*sqrt(T_IIV_V1_log) #-1.661241
upper_bound_IIV_V1_log<-IIV_V1_log+t_crit_IIV_V1_log*sqrt(T_IIV_V1_log) #-0.8195228

lower_bound_IIV_V1_log
upper_bound_IIV_V1_log

```

```{r back transform IIV_V1_log to IIV_V1}

IIV_V1<-exp(IIV_V1_log) #0.2892737

lower_bound_IIV_V1<-exp(lower_bound_IIV_V1_log) #0.1899032

upper_bound_IIV_V1<-exp(upper_bound_IIV_V1_log) #0.4406419

IIV_V1

lower_bound_IIV_V1

upper_bound_IIV_V1

```

##### Finally, we deal with PropErr log-transformed estimate - PropErr_log, then back-transform to PropErr

```{r calculate Mean Within and Between Subject variability for all}

PropErr_log<-mean(Pooling_Parameters_2l.pan$Log[Pooling_Parameters_2l.pan$Parameters == "PropErr"]) #-3.593393

W_PropErr_log<-mean(Pooling_Parameters_2l.pan$Var_Log[Pooling_Parameters_2l.pan$Parameters == "PropErr"]) #0.01827621 #within imputation variance

B_PropErr_log<-var(Pooling_Parameters_2l.pan$Log[Pooling_Parameters_2l.pan$Parameters == "PropErr"]) #6.42266e-05
 #between imputation variance

PropErr_log
W_PropErr_log
B_PropErr_log

```

```{r total variance for log-transformed variable}

m<-70
T_PropErr_log<-W_PropErr_log+(1+1/m)*B_PropErr_log #0.01834136
T_PropErr_log

```

```{r confidence interval - T distribution}

m<-70 #number of imputations
k<-12 #my model has 12 parameters (including 6 fixed effects parameters and 6 random effect parameters where covariance is one of them)
n<-177

lambda_PropErr_log<-(B_PropErr_log+B_PropErr_log/m)/T_PropErr_log #proportion of variation attributable to the missing data

r_PropErr_log<-(lambda_PropErr_log)/(1-lambda_PropErr_log) #relative increase in variance due to nonresponse

v_old_PropErr_log<-(m-1)*(1+1/r_PropErr_log^2) #old degree of freedom

v_com=n-k #degree of freedom of parameter estimate (PropErr_log) in the hypothetically complete data

v_obs_PropErr_log=((v_com+1)/(v_com+3))*v_com*(1-lambda_PropErr_log) #observed data degrees of freedom that accounts for the missing information

v_PropErr_log<-(v_old_PropErr_log*v_obs_PropErr_log)/(v_old_PropErr_log+v_obs_PropErr_log)

t_crit_PropErr_log <- qt(0.975, v_PropErr_log) 

lower_bound_PropErr_log<-PropErr_log-t_crit_PropErr_log*sqrt(T_PropErr_log) #-3.860824
upper_bound_PropErr_log<-PropErr_log+t_crit_PropErr_log*sqrt(T_PropErr_log) #-3.325962

lower_bound_PropErr_log
upper_bound_PropErr_log

```

```{r back transform PropErr_log to PropErr}

PropErr<-exp(PropErr_log) #0.02750484

lower_bound_PropErr<-exp(lower_bound_PropErr_log) #0.02105065

upper_bound_PropErr<-exp(upper_bound_PropErr_log) #0.03593792

PropErr

lower_bound_PropErr

upper_bound_PropErr

```

#### Evaluate the adequacy of the number of imputations (for later - 091023)

```{r set wd, warning=FALSE}

# Read in the dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooling_Parameters_2l.pan<-read.csv("Pooling_Parameters_2l.pan_051023.csv",sep=";")

# Creating Var (Variance) column 
Pooling_Parameters_2l.pan$Var<-(Pooling_Parameters_2l.pan$RSE*Pooling_Parameters_2l.pan$Estimates/100)^2

```

```{r calculate variance Theta Within and Between Subject variability for 70 imputations, warning=FALSE}

# Create empty vectors
m <- Theta <- W <- B <- Total_Var <- numeric(70)

# Assign values to vectors using for loop
for (i in 1:70) {
  m[i] <- i
  Theta[i] <- mean(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "CKDEPI" & Pooling_Parameters_2l.pan$Model <= i])
  W[i] <- mean(Pooling_Parameters_2l.pan$Var[Pooling_Parameters_2l.pan$Parameters == "CKDEPI" & Pooling_Parameters_2l.pan$Model <= i])
  B[i] <- var(Pooling_Parameters_2l.pan$Estimates[Pooling_Parameters_2l.pan$Parameters == "CKDEPI" & Pooling_Parameters_2l.pan$Model <= i])
  Total_Var[i] <- W[i] + (1 + 1 / m[i]) * B[i]
}

# Combine vectors into a data frame
imputation_number <- data.frame(m, Theta, Total_Var)

```

```{r plot Theta over m, warning=FALSE}

x_label_options <- list(
  label = "Number of imputations",
  size = 12,
  color = "black",
  hjust = 0.5,
  vjust = 0,
  face = "bold"
)

y_label_options <- list(
  label = "CKDEPI effect Estimate",
  size = 12,
  color = "black",
  hjust = 0,
  vjust = 0.5,
  angle = 0,
  face = "bold"
)

axis_text_options <- list(
  size = 10
)

Theta_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Theta, color = "Parameter Estimate"), size = 1.0) +
  geom_point(aes(y = Theta, color = "Parameter Estimate"), size = 2.5) + # Add points for Parameter Estimate
  scale_color_manual(values = c("dodgerblue4")) +
  scale_x_continuous(breaks = seq(0, 70, 10), limits = c(0, 70))  +
  scale_y_continuous(breaks = seq(0, 0.55, 0.05), limits = c(0, 0.55)) +
  labs(x = x_label_options,
         y = y_label_options) +
  theme_bw() + 
  theme(axis.text = element_text(axis_text_options),
        legend.position = "none")
Theta_over_m

#labs(x = "Number of imputations", y = "CKDEPI effect Estimate", color = "Variables") +

# Exporting the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/diagnostic_plots/2l.pan")  

ggsave("theta_over_m_091023.png", plot = Theta_over_m, dpi = 300, width = 12, height = 8)

```

```{r plot variance over m, warning=FALSE}

x_label_options <- list(
  label = "Number of imputations",
  size = 12,
  color = "black",
  hjust = 0.5,
  vjust = 0,
  face = "bold"
)

y_label_options <- list(
  label = "Total variance of CKDEPI effect estimate",
  size = 12,
  color = "black",
  hjust = 0,
  vjust = 0.5,
  angle = 0,
  face = "bold"
)

axis_text_options <- list(
  size = 10
)

var_over_m<-ggplot(imputation_number, aes(x = m)) +
  geom_line(aes(y = Total_Var, color = "Total Variance"), size = 1.0) +
  geom_point(aes(y = Total_Var, color = "Total Variance"), size = 2.5) + # Add points for Total Variance
  scale_color_manual(values = c("goldenrod1")) +
  scale_x_continuous(breaks = seq(0, 70, 10), limits = c(0, 70))  +
  scale_y_continuous(breaks = seq(0, 0.042, 0.003), limits = c(0, 0.042)) +
  labs(x = x_label_options,
         y = y_label_options) +
  theme_bw() + 
  theme(axis.text = element_text(axis_text_options),
        legend.position = "none")
var_over_m

# Exporting the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/diagnostic_plots/2l.pan")  

ggsave("var_over_m_091023.png", plot = var_over_m, dpi = 300, width = 12, height = 8)

```

#### Making diagnostic plots of CKDEPI over TIME observed vs imputed; and density plot

```{r reading first imputed dataset 2l.pan method,warning=FALSE}

# For 2l.pan method
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets/Imputed_dos_int_datasets/2l method/2l.pan")
Fluc_NONMEM_mul_impute_BW01 <- read.csv("Fluc_NONMEM_mul_impute_BW01.csv")

# For 2l.pmm method
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pmm")
Fluc_NONMEM_mul_impute_BW01 <- read.csv("Fluc_NONMEM_mul_impute_BW01.csv")

# Assigning -99 in CKDEPI and CREAT to NA
Fluc_NONMEM_mul_impute_BW01$CKDEPI[Fluc_NONMEM_mul_impute_BW01$CKDEPI == -99] <- NA
Fluc_NONMEM_mul_impute_BW01$CREAT[Fluc_NONMEM_mul_impute_BW01$CREAT == -99] <- NA

# This will no longer be necessary as I already exported the new dataset FlucTotIV_clean in which I recalculated CKDEPI - 051023
Fluc_NONMEM_mul_impute_BW01[["CKDEPI"]] <- calculate_CKDEPI(Fluc_NONMEM_mul_impute_BW01,"CREAT", 
                                                            "SEX", "AGE", 142)

```

```{r CKDEPI over TIME imputed vs non-imputed}

## Creat_Imputed variable indicating whether CREAT is missing or imputed
## Value of 1 means yes, and 0 means no

Fluc_NONMEM_mul_impute_BW01$Creat_Imputed<-ifelse(is.na(Fluc_NONMEM_mul_impute_BW01$CREAT),1,0)

## Making 10 plots with trend lines

# Create a list to store the plots
plot_list <- list()

# Loop through CKDEPI01 to CKDEPI10
for (i in 1:10) {
  # Create a plot for each CKDEPI variable
  plot <- ggplot(Fluc_NONMEM_mul_impute_BW01, aes(x = TIME, y = get(paste0("CKDEPI", sprintf("%02d", i))), color = factor(Creat_Imputed))) +
    geom_point() +
    geom_smooth(method = "lm", se = FALSE) +  # Add trend line
    labs(title = paste("CKDEPI", sprintf("%02d", i), "over Time"),
         x = "Time (h)", y = paste("eGFR (ml/min/1.73m2)"),
         color = "Creatinine Imputed") + 
    scale_color_discrete(labels = c("No", "Yes")) +
    theme_bw() +
        scale_y_continuous(breaks = seq(0, 300, by = 20), limits = c(0, 300),expand = c(0,0)) +
        scale_x_continuous(breaks = seq(0, 1100, by = 50), limits = c(0, 1100),expand = c(0,0)) +
        theme(
    axis.text = element_text(size = 12),
    axis.title = element_text(size = 12),
    plot.title = element_text(size = 14, face = "bold", hjust = 0.5)
  ) 
  
  # Add the plot to the list
  plot_list[[i]] <- plot
}

# Print and export the plots
for (i in 1:10) {
  # Print the plot
  print(plot_list[[i]])
  
# Export the plot to a high-quality image

  # 2l.pan method  
  setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/diagnostic_plots/2l.pan")  
  ggsave(paste("CKDEPI", sprintf("%02d", i), "_plot.png"), plot = plot_list[[i]], dpi = 300, width = 12, height = 8)
  # 2l.pmm method
#setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/diagnostic_plots/2l.pmm")  
  #ggsave(paste("CKDEPI", sprintf("%02d", i), "_plot.png"), plot = plot_list[[i]], dpi = 300, width = 12, height = 8)
}

```

```{r density plot observed vs imputed, warning=FALSE}

# Your dataset and initial plot code
# Assuming your dataset is called Fluc_NONMEM_mul_impute_BW01
# ...

# Define the title and label options
title_options <- list(
  label = "Density plot of 10 imputed CKDEPI vs the original CKDEPI",
  size = 14,
  color = "black",
  hjust = 0.5,
  vjust = 1,
  face = "bold"
)

x_label_options <- list(
  label = "eGFR (ml/min/1.73m2)",
  size = 12,
  color = "black",
  hjust = 0.5,
  vjust = 0
)

y_label_options <- list(
  label = "Density",
  size = 12,
  color = "black",
  hjust = 0,
  vjust = 0.5,
  angle = 0
)

axis_text_options <- list(
  size = 10
)

legend_options <- list(
  title = "Variable",
  size = 8
)

# Density plot first 10 imputations 
density_plot<-ggplot(Fluc_NONMEM_mul_impute_BW01, aes(x = CKDEPI01)) + 
  geom_density(aes(fill = "CKDEPI01"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI02, fill = "CKDEPI02"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI03, fill = "CKDEPI03"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI04, fill = "CKDEPI04"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI05, fill = "CKDEPI05"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI06, fill = "CKDEPI06"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI07, fill = "CKDEPI07"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI08, fill = "CKDEPI08"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI09, fill = "CKDEPI09"), alpha = 0.5) + 
  geom_density(aes(x = CKDEPI10, fill = "CKDEPI10"), alpha = 0.5) +
  geom_density(aes(x = CKDEPI, fill = "CKDEPI"), alpha = 0.5) +
  theme_bw() +
  scale_fill_manual(
    name = "Variable",
    values = c("CKDEPI01" = "blue", "CKDEPI02" = "lightblue", "CKDEPI03" = "green",
               "CKDEPI04" = "orange", "CKDEPI05" = "purple", "CKDEPI06" = "pink",
               "CKDEPI07" = "brown", "CKDEPI08" = "gray", "CKDEPI09" = "black",
               "CKDEPI10" = "yellow","CKDEPI" = "red")
  ) + labs(title = title_options,
         x = x_label_options,
         y = y_label_options) +
  theme(
      plot.title = element_text(hjust = 0.5),
      axis.text = element_text(axis_text_options),
      legend.position = "right"
    )

# 2l.pan method
#setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/diagnostic_plots/2l.pan")  
#ggsave("Density_2l.pan_051023.png", plot = density_plot, dpi = 300, width = 12, height = 8)

# 2l.pmm method
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/diagnostic_plots/2l.pmm")  
ggsave("Density_2l.pmm_051023.png", plot = density_plot, dpi = 300, width = 12, height = 8)

```

### Making VPC - 111023

#### First of all, calculate mean BW and CKDEPI of the total 70 imputations

```{r calculate mean BW and CKDEPI - BW_ave and CKDEPI_ave, warning=FALSE}

# Set wd
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan")

# Create a list to store all datasets
datasets <- list()
# Repeat Steps 1 and 2 for the other datasets
for (i in 1:7) {
  # Generate the dataset name
  dataset_name <- paste0("Fluc_NONMEM_mul_impute_BW0", i, ".csv")
  
  # Read the dataset
  data  <- read.csv(dataset_name)

  # Create "BW_ave0i" in the current dataset
  data  <- data  %>%
    mutate(!!paste0("BW_ave0", i) := rowMeans(select(data , BW01:BW10), na.rm = TRUE))
  
   # Create "CKDEPI_ave0i" in the current dataset
  data  <- data  %>%
    mutate(!!paste0("CKDEPI_ave0", i) := rowMeans(select(data , CKDEPI01:CKDEPI10), na.rm = TRUE))
  
  # Add the dataset to the list
  
  datasets[[i]] <- data 
  
}

# Combine the datasets by columns
combined_dataset <- bind_cols(datasets)

# Calculate the mean of "BW_ave01" to "BW_ave07" columns and create "BW_ave"
combined_dataset <- combined_dataset %>%
  mutate(BW_ave = rowMeans(select(., starts_with("BW_ave0")), na.rm = TRUE))

# Calculate the mean of "CKDEPI_ave01" to "CKDEPI_ave07" columns and create "CKDEPI_ave"
combined_dataset <- combined_dataset %>%
  mutate(CKDEPI_ave = rowMeans(select(., starts_with("CKDEPI_ave0")), na.rm = TRUE))

# Add "BW_ave" to the "Fluc_NONMEM_mul_impute_BW01.csv" dataset
datasets[[1]]$BW_ave<-combined_dataset$BW_ave

# Add "CKDEPI_ave" to the "Fluc_NONMEM_mul_impute_BW01.csv" dataset
datasets[[1]]$CKDEPI_ave<-combined_dataset$CKDEPI_ave

# Excluding "BW_ave01" column
datasets[[1]]$BW_ave01<-NULL
datasets[[1]]$CKDEPI_ave01<-NULL

# Exporting the dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan/vpc")
write.csv(datasets[[1]], "Fluc_NONMEM_mul_impute_BW01.csv",quote=F,row.names = FALSE)

```

#### Then making vpc, code is in pcVPC_pooled.R

#### Checking data for refining VPC

##### Check the summary of the dosing intervals

```{r FlucTotIV_clean_int dataset}

FlucTotIV_clean$AMT <- as.numeric(FlucTotIV_clean$AMT)
FlucTotIV_clean_int <- FlucTotIV_clean%>%filter(AMT!=0)

```

```{r checking dosing intervals}

dosing_intervals <- FlucTotIV_clean_int %>%
  arrange(ID, TIME) %>%
  group_by(ID) %>%
  mutate(dosing_interval = TIME - lag(TIME)) 

summary(dosing_intervals$dosing_interval)

dosing_intervals<-ungroup(dosing_intervals)
dosing_intervals <- dosing_intervals[!is.na(dosing_intervals$dosing_interval), ]
percentage_12_24 <- dosing_intervals %>%
  filter((dosing_interval < 13 & dosing_interval > 11) | (dosing_interval < 25 & dosing_interval > 23)) %>%
  summarize(percentage = (n() / nrow(dosing_intervals)) * 100)
percentage_12_24
# 86.34713% dosing interval are within 12 hours or 24 hours

percentage_below_12 <- dosing_intervals %>%
  filter((dosing_interval < 11)) %>%
  summarize(percentage = (n() / nrow(dosing_intervals)) * 100)
percentage_below_12
# 3.485839% dosing interval are below 12 hours

percentage_above_24 <- dosing_intervals %>%
  filter((dosing_interval >25)) %>%
  summarize(percentage = (n() / nrow(dosing_intervals)) * 100)
percentage_above_24
# 1.670298% dosing interval are above 24 hours

```

##### Explore FlucTotIV_clean to make stratified VPC

```{r explore loading dose} 

#Count the number of different loading doses

# Filter for loading doses
loading_doses <- FlucTotIV_clean[FlucTotIV_clean$AMT > 0 & FlucTotIV_clean$TIME == 0, ]

loading_doses$AMT<-as.factor(loading_doses$AMT)

# Summary of frequencies
loading_dose_summary <- table1(~AMT,data=loading_doses)

# Display the summary
print(loading_dose_summary)


```

```{r explore maintenance dose} 

#Count the number of different loading doses

# Filter for maintenance doses
maintenance_doses <- FlucTotIV_clean[FlucTotIV_clean$AMT > 0 & FlucTotIV_clean$TIME > 0, ]

maintenance_doses$AMT<-as.factor(maintenance_doses$AMT)

# Summary of frequencies
maintenance_doses_summary <- table1(~AMT,data=maintenance_doses)

# Display the summary
print(maintenance_doses_summary)

# Summary of AMT & dosing_interval
maintenance_doses$dosing_interval<-as.factor(maintenance_doses$dosing_interval)
maintenance_dosint_summary <- table1(~AMT|dosing_interval,data=maintenance_doses)
print(maintenance_dosint_summary)

```

```{r explore dosing intervals} 

#Count the number of different loading doses

# Filter for dosing_intervals
dosing_intervals <- FlucTotIV_clean[FlucTotIV_clean$dosing_interval > 0, ]

dosing_intervals$dosing_interval<-as.factor(dosing_intervals$dosing_interval)

# Summary of frequencies
dosing_intervals_summary <- table1(~dosing_interval,data=maintenance_doses)

# Display the summary
print(maintenance_doses_summary)

```

```{r 3 times a day regimen}

# Check for rows with OCC = 3 and 22 < TIME < 26
rows_to_check <- FlucTotIV_clean[FlucTotIV_clean$OCC == 6 & FlucTotIV_clean$TIME > 46 & FlucTotIV_clean$TIME < 48, ]

# Display the rows (if any)
print(rows_to_check)

unique(rows_to_check$ID)

# It means no 3 times a day patient

```

```{r another way of checking dosing_interval}

# 17/11/2023
# Extract all dosing_events first
Fluc_dosing_events<-FlucTotIV_clean%>%filter(AMT!=0)

# Re-creating dosing_interval column, for OCC == 1 (loading dose), 
# dosing_interval = TIME (OCC==2) - TIME (OCC==1). Do similarly for the
# following OCC until it reaches the maximum OCC. dosing_interval of the maximum 
# OCC should also be equal to TIME (OCC==MAX) - TIME (OCC==MAX-1)

Fluc_dosing_events <- Fluc_dosing_events %>%
                      group_by(ID) %>%
                      arrange(OCC) %>%
                      mutate(
dosing_interval = ifelse(OCC != max(OCC), lead(dosing_interval), dosing_interval)
) %>% ungroup()
# I have 9 patients who received only 1 dose of fluconazole

# Rearrange the dataset
Fluc_dosing_events<-arrange(Fluc_dosing_events, ID, TIME)

## Checking frequency distribution

hist(Fluc_dosing_events$dosing_interval) #overall histogram

hist((Fluc_dosing_events%>%filter(TIME==0))$dosing_interval)

# Loading dosing_interval
Fluc_loading_events<-Fluc_dosing_events%>%filter(TIME==0)
hist(Fluc_loading_events$dosing_interval)
plot(Fluc_loading_events$dosing_interval)
#FLag: 18-30 :1 - 8-15 :2 - The rest:3

# Loading doses 
hist(Fluc_loading_events$AMT)
plot(Fluc_loading_events$AMT)
#FLag: 800 :1 - 400 :2 - 200&other:3 

# Maintenance dosing_interval
Fluc_maintenance_events<-Fluc_dosing_events%>%filter(TIME>0)
hist(Fluc_maintenance_events$dosing_interval)
plot(Fluc_maintenance_events$dosing_interval)
#FLag: 18-30 :1 - 8-15 :2 - The rest:3

# Maintenance doses 
hist(Fluc_maintenance_events$AMT)
plot(Fluc_maintenance_events$AMT)
#FLag: 400 :1 - 800 :2 - 200&other:3

```

```{r assigning flags to different events}

## continuing from above
## adding flag for loading dose interval
Fluc_dosing_events <- Fluc_dosing_events %>%
  group_by(ID) %>%
  mutate(
    loading_dose_interval = case_when(
      row_number() == 1 & dosing_interval >= 18 & dosing_interval <= 30 ~ 1,
      row_number() == 1 & dosing_interval >= 8 & dosing_interval <= 15 ~ 2,
      TRUE ~ 3
    )
  ) %>%
  ungroup()

# Rearrange the dataset
Fluc_dosing_events<-arrange(Fluc_dosing_events, ID, TIME)

# Carry the value of the first row to the rest
Fluc_dosing_events <- Fluc_dosing_events %>%
  group_by(ID) %>%
  mutate(
    loading_dose_interval = ifelse(OCC > 1, first(loading_dose_interval), loading_dose_interval)
  ) %>%
  ungroup()

## adding flag for maintenance dose interval
Fluc_dosing_events <- Fluc_dosing_events %>%
  group_by(ID) %>%
  mutate(
    maintenance_dose_interval = case_when(
      row_number() != 1 & dosing_interval >= 18 & dosing_interval <= 30 ~ 1,
      row_number() != 1 & dosing_interval >= 8 & dosing_interval <= 15 ~ 2,
      TRUE ~ 3
    )
  ) %>%
  ungroup()

# Rearrange the dataset
Fluc_dosing_events<-arrange(Fluc_dosing_events, ID, TIME)

# Carry the value of the first row to the rest
Fluc_dosing_events <- Fluc_dosing_events %>%
  group_by(ID) %>%
  mutate(
    maintenance_dose_interval = ifelse(OCC == 1, nth(maintenance_dose_interval,2), maintenance_dose_interval)
  ) %>%
  ungroup()

# Check if every OCC of a single patient ID has the same maintenance_dose_interval
Fluc_dosing_events$maintenance_dose_interval<-as.factor(Fluc_dosing_events$maintenance_dose_interval)
table1(~maintenance_dose_interval|ID,data=Fluc_dosing_events)
# not every OCC of a single ID has the same interval

# Find out who have more than 1 interval
distinctID_maintenance_intervals<- Fluc_dosing_events %>%
    group_by(ID) %>%
    summarize(num_distinct_intervals = length(unique(maintenance_dose_interval))) %>%
    filter(num_distinct_intervals >= 2) %>%
    pull(ID)
View(distinctID_maintenance_intervals) 
# 33 patients having more than 1 intervals - not a good news.

## Then I need to adress this
# First option, assign 3 as maintenance_dose_interval of all these patients
Fluc_dosing_events <- Fluc_dosing_events %>%
  mutate(
    maintenance_dose_interval = ifelse(ID %in% distinctID_maintenance_intervals, 3, maintenance_dose_interval)
  )
# Also need to assign 3 to all missing maintenance_dose_interval
Fluc_dosing_events$maintenance_dose_interval[is.na(Fluc_dosing_events$maintenance_dose_interval)]<-3

# Then assign real_flag based on dosing_interval of both loading and maintenance doses
# In order to do so, check how many unique combinations between loading and maintenance dose
unique(Fluc_dosing_events[c("loading_dose_interval","maintenance_dose_interval")])

## Report the number of IDs falls in each combination

# Convert ID, loading_dose, maintenance_dose, loading_dose_interval & 
# maintenance_dose_interval into factor
col_names <- c("ID","loading_dose","maintenance_dose","loading_dose_interval","maintenance_dose_interval")
Fluc_dosing_events[,col_names] <- lapply(Fluc_dosing_events[,col_names] , factor)

# Use table 1 to see how many ID per each combination
table1(~ID|loading_dose_interval+maintenance_dose_interval,data = Fluc_dosing_events%>%group_by(ID)%>%slice(1)%>%ungroup()) #slice function helps select the first row

# loading dose of 24 hours and maitenance dose of 24 hours are still the most popular - 93/177

# Will create a flag dosing_interval_flag which equals 1 if loading_dose_interval == 1 & maintenance_dose_interval == 1, and equals 2 otherwise.
Fluc_dosing_events$dosing_interval_flag<-ifelse(Fluc_dosing_events$loading_dose_interval==1 & Fluc_dosing_events$maintenance_dose_interval==1,1,0)

# distinct ID for dosing_interval_flag
distinctID_dosing_interval<-Fluc_dosing_events %>% filter(dosing_interval_flag==1) %>% 
  distinct(ID)
# This is used to add dosing_interval_flag to the VPC Rscript

### Events based on the AMT values

## For loading dose

Fluc_dosing_events <- Fluc_dosing_events %>%
  group_by(ID) %>%
  mutate(
    loading_dose = case_when(
      row_number() == 1 & AMT == 800 ~ 1,
      row_number() == 1 & AMT == 400 ~ 2,
      TRUE ~ 3
    )
  ) %>%
  ungroup()

# Rearrange the dataset
Fluc_dosing_events<-arrange(Fluc_dosing_events, ID, TIME)

# Carry the value of the first row to the rest
Fluc_dosing_events <- Fluc_dosing_events %>%
  group_by(ID) %>%
  mutate(
    loading_dose = ifelse(OCC > 1, first(loading_dose), loading_dose)
  ) %>%
  ungroup()

## For maintenance doses

Fluc_dosing_events <- Fluc_dosing_events %>%
  group_by(ID) %>%
  mutate(
    maintenance_dose = case_when(
      row_number() != 1 & AMT == 400 ~ 1,
      row_number() != 1 & AMT == 800 ~ 3,
      row_number() != 1 & AMT == 200 ~ 2,
      TRUE ~ 4
    )
  ) %>%
  ungroup()
# I change the label of maintenance dose
# 400mg 1 200mg 2 800mg 3 and the rest

# Rearrange the dataset
Fluc_dosing_events<-arrange(Fluc_dosing_events, ID, TIME)

# Carry the value of the first row to the rest
Fluc_dosing_events <- Fluc_dosing_events %>%
  group_by(ID) %>%
  mutate(
    maintenance_dose = ifelse(OCC == 1, nth(maintenance_dose,2), maintenance_dose)
  ) %>%
  ungroup()

# Find out who have more than 1 maintenance dose
distinctID_maintenance_dose<- Fluc_dosing_events %>%
    group_by(ID) %>%
    summarize(num_distinct_dose = length(unique(maintenance_dose))) %>%
    filter(num_distinct_dose >= 2) %>%
    pull(ID)
View(distinctID_maintenance_dose) 
# 19 patients having more than 2 doses - not a good news.

# First option, assign 3 as maintenance_dose of all these patients
Fluc_dosing_events <- Fluc_dosing_events %>%
  mutate(
    maintenance_dose = ifelse(ID %in% distinctID_maintenance_dose, 4, maintenance_dose)
  )
# Also need to assign 4 to all missing maintenance_dose_interval
Fluc_dosing_events$maintenance_dose[is.na(Fluc_dosing_events$maintenance_dose)]<-4

# Then assign real_flag based on dosing_interval of both loading and maintenance doses
# In order to do so, check how many unique combinations between loading and maintenance dose
unique(Fluc_dosing_events[c("loading_dose","maintenance_dose")])

# Use table 1 to see how many ID per each combination
table1(~ID|loading_dose+maintenance_dose,data = Fluc_dosing_events%>%group_by(ID)%>%slice(1)%>%ungroup()) #slice function helps select the first row

# a lot of weird combination, need to check the interval as well
unique(Fluc_dosing_events[c("loading_dose","loading_dose_interval","maintenance_dose","maintenance_dose_interval")])

# Check the number of IDs falling into these different combinations 
distinct_flag_ID <- Fluc_dosing_events %>%
  group_by(loading_dose, loading_dose_interval, maintenance_dose, maintenance_dose_interval) %>%
  summarize(num_patients = n_distinct(ID))
View(distinct_flag_ID)

# based on distinct_flag_ID, we create like this
Fluc_dosing_events$dose_and_interval <- with(Fluc_dosing_events, ifelse(
  loading_dose == 2 & loading_dose_interval == 1 & maintenance_dose == 1 & maintenance_dose_interval == 1, 1,
  ifelse(loading_dose == 1 & loading_dose_interval == 1 & maintenance_dose == 1 & maintenance_dose_interval == 1, 2, 3)))
# 2 1 1 1: 1 - 400 mg every 24 hours LD, 400 mg every 24 hours MD
# 1 1 1 1: 2 - 800 mg every 24 hours LD, 400 mg every 24 hours MD
# 3: the rest

# create distinct ID
dose_and_interval_1<-Fluc_dosing_events %>% filter(dose_and_interval==1) %>% 
  distinct(ID)
dose_and_interval_2<-Fluc_dosing_events %>% filter(dose_and_interval==2) %>% 
  distinct(ID)

# Check dose_and_interval column
table1(~ID|dose_and_interval,data = Fluc_dosing_events%>%group_by(ID)%>%slice(1)%>%ungroup())

# Will create a flag dosing_interval_flag which equals 1 if loading_dose_interval == 1 & maintenance_dose_interval == 1, and equals 2 otherwise.
Fluc_dosing_events$dosing_interval_flag<-ifelse(Fluc_dosing_events$loading_dose_interval==1 & Fluc_dosing_events$maintenance_dose_interval==1,1,0)

# distinct ID for dosing_interval_flag
distinctID_dosing_interval<-Fluc_dosing_events %>% filter(dosing_interval_flag==1) %>% 
  distinct(ID)

```

```{r some more exploratory analysis}

## 201" "202" "203" "205" "208" "210" "212" "215" "218" "219" "221" does not have TIME == 0

# Proof
totalID<-as.data.frame(unique(Fluc_dosing_events$ID))
LDID<-FlucTotIV_clean%>%filter(TIME==0)
setdiff(totalID$ID,LDID$ID)


```

###### Exploring Ceftriaxone dataset Dreesen 2022 JAC for my tutorial paper case study 260124

```{r}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Projects/Multiple Imputation Tutorial in Pharmacometrics/References/Case study datasets & papers")

Ceftriaxone<-read.csv("Ceftriaxone_mol_2.csv",header = TRUE)

# Firstly, check how many unique ALB values are there

length(unique(Ceftriaxone$ALB)) # 80 unique ALB values

length(unique(Ceftriaxone$BM)) # 21 unique values, which means some patients had the same BM


### This part is redundant now

## Checking availability of ALB between dosing interval

# First, extract the unique ID, TIME, AMT, and ALB combinations

uniqueID<-Ceftriaxone%>%select(ID,REL_TIME,AMT,ALB)%>%distinct()

# Check how many unique ALB per combination of ID, TIME, and AMT

uniqueID%>%group_by(ID,REL_TIME,AMT)%>%summarize(n_distinct(ALB))

# Add new column unique_ALB to my Ceftriaxone dataset, counting the number of unique ALB values per patient ID

Ceftriaxone$unique_ALB<-with(Ceftriaxone, ave(ALB, ID, FUN = function(x) length(unique(x))))


### My code starts from here

## Plot ALB over REL_TIME, color by OCC, facet by ID, lineplot, make 3 plots for 3 groups of 11 IDs, instead of current 33 IDs in my Ceftriaxone dataset

# Probably group_by ID, OCC, and ALB, then slice the first row of each group, then ungroup, select the distinct values of ID, OCC, REL_TIME and ALB

ALB<-Ceftriaxone%>%group_by(ID,OCC,ALB)%>%slice(1)%>%ungroup()%>%select(ID,OCC,REL_TIME,ALB)%>%distinct()

# Convert ID and OCC to factor, REL_TIME and ALB to numeric

ALB$ID<-as.factor(ALB$ID)

ALB$OCC<-as.factor(ALB$OCC)

ALB$REL_TIME<-as.numeric(ALB$REL_TIME)

ALB$ALB<-as.numeric(ALB$ALB)

# Sort ALB by ID, OCC and REL_TIME

ALB<-ALB%>%arrange(ID,OCC,REL_TIME)

# For ID from 7 to 19

ALB%>%filter(ID %in% c(7:19))%>%
  ggplot(aes(x=REL_TIME,y=ALB,color=OCC,shape=OCC)) + geom_line(size=1.5) + geom_point(size=3) + scale_colour_viridis_d(option="A") + facet_wrap(~ID,scales="free")  + theme_bw() # 12 dose intervals with imputation

# For ID from 20 to 33

ALB%>%filter(ID %in% c(20:33))%>%
  ggplot(aes(x=REL_TIME,y=ALB,color=OCC,shape=OCC)) + geom_line(size=1.5) + geom_point(size=3) + scale_colour_viridis_d(option="A") + facet_wrap(~ID,scales="free")  + theme_bw() # 5 dose intervals with imputation

# For ID from 34 to 45

ALB%>%filter(ID %in% c(34:45))%>%
  ggplot(aes(x=REL_TIME,y=ALB,color=OCC,shape=OCC)) + geom_line(size=1.5) + geom_point(size=3) + scale_colour_viridis_d(option="A") + facet_wrap(~ID,scales="free")  + theme_bw() # 8 dose intervals with imputation

# From my Ceftriaxone dataset, count the number of dosing intervals, by summing the maximum of OCC per ID, then minus the number of ID

OCC<-Ceftriaxone%>%group_by(ID)%>%summarize(maxOCC=max(OCC))

sum(OCC$maxOCC)-length(unique(Ceftriaxone$ID)) # 78 dosing intervals # 111 dosing intervals

# percentage of imputation

25/78 # 36%

25/111 #  23%

## Do similarly for between days imputation

# First, create a new column DAY in my Ceftriaxone dataset, by dividing REL_TIME by 24, and get the integer part

Ceftriaxone$DAY<-floor((Ceftriaxone$REL_TIME/24)+1)

# Then, group_by ID, DAY, and ALB, then slice the first row of each group, then ungroup, select the distinct values of ID, DAY, REL_TIME and ALB

ALB<-Ceftriaxone%>%group_by(ID,DAY,ALB)%>%slice(1)%>%ungroup()%>%select(ID,DAY,REL_TIME,ALB)%>%distinct()

# Convert ID and DAY to factor, REL_TIME and ALB to numeric

ALB$ID<-as.factor(ALB$ID)

ALB$DAY<-as.factor(ALB$DAY)

ALB$REL_TIME<-as.numeric(ALB$REL_TIME)

ALB$ALB<-as.numeric(ALB$ALB)

# Sort ALB by ID, DAY and REL_TIME

ALB<-ALB%>%arrange(ID,DAY,REL_TIME)

# For ID from 7 to 19

ALB%>%filter(ID %in% c(7:19))%>%
  ggplot(aes(x=REL_TIME,y=ALB,color=DAY,shape=DAY)) + geom_line(size=1.5) + geom_point(size=3) + scale_colour_viridis_d(option="A") + facet_wrap(~ID,scales="free")  + theme_bw() # 8 days with imputation

# For ID from 20 to 33

ALB%>%filter(ID %in% c(20:33))%>%
  ggplot(aes(x=REL_TIME,y=ALB,color=DAY,shape=DAY)) + geom_line(size=1.5) + geom_point(size=3) + scale_colour_viridis_d(option="A") + facet_wrap(~ID,scales="free")  + theme_bw() # 6 days with imputation

# For ID from 34 to 45

ALB%>%filter(ID %in% c(34:45))%>%
  ggplot(aes(x=REL_TIME,y=ALB,color=DAY,shape=DAY)) + geom_line(size=1.5) + geom_point(size=3) + scale_colour_viridis_d(option="A") + facet_wrap(~ID,scales="free")  + theme_bw() # 8 days with imputation

# From my Ceftriaxone dataset, count the number of days, by summing the maximum of DAY per ID

DAY<-Ceftriaxone%>%group_by(ID)%>%summarize(maxDAY=max(DAY))

sum(DAY$maxDAY) # 107 days

# percentage of imputation

22/107 # 21%

#### Checking IHD after meeting with Isabel 260124

# Counting how many rows having missing IHD in my FlucTotIV_clean dataset

sum(is.na(FlucTotIV_clean$IHD))

# the percentage missing

sum(is.na(FlucTotIV_clean$IHD))/nrow(FlucTotIV_clean) # 60.5%

```


##### Identify patients with high concentration

```{r identifying high concentration patients}

FlucTotIV_clean$TAD<-as.numeric(FlucTotIV_clean$TAD)
FlucTotIV_clean$DV<-as.numeric(FlucTotIV_clean$DV)
FlucTotIV_clean$HOSPITAL<-as.factor(FlucTotIV_clean$HOSPITAL)

high_rows <- FlucTotIV_clean %>% #identify patients with high trough concentration
  filter(TAD >= 23, TAD <= 25.5, DV > 50) %>% #regardless of 25 or 25.5, the results remain the same
  distinct(ID)
#5 patient IDs 117 122 126 139 144

long_rows <- FlucTotIV_clean %>% #identify patients with >25.5 TAD trough concentration
  filter(TAD > 25.5, DV>0) %>%
  distinct(ID)
#18 patient IDs, 9 from HOSPITAL 2, 1 from HOS 5, 1 from HOS 7 & 7 from HOS 8

```

#### Refine the dataset to make another vpc overall

```{r read another vpc, warning=FALSE}

# Refine vpc datasets, exclude all having either DV>70 or TAD>25.5
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan/vpc")

Fluc_NONMEM_mul_impute_BW01 <- read.csv("Fluc_NONMEM_mul_impute_BW01.csv")

Fluc_NONMEM_mul_impute_BW01$DV<-as.numeric(Fluc_NONMEM_mul_impute_BW01$DV)

Fluc_NONMEM_mul_impute_BW01$TAD<-as.numeric(Fluc_NONMEM_mul_impute_BW01$TAD)

# The refined dataset
Fluc_NONMEM_mul_impute_BW01_refined <- Fluc_NONMEM_mul_impute_BW01 %>%
  filter((TAD <= 25.5|is.na(DV)))
Fluc_NONMEM_mul_impute_BW01_refined <- Fluc_NONMEM_mul_impute_BW01_refined %>%
  filter((DV <= 70|is.na(DV)))
# eliminate 25 concentration - time points

# Replace NAs in DV & TAD with "."

Fluc_NONMEM_mul_impute_BW01_refined$DV <- ifelse(is.na(Fluc_NONMEM_mul_impute_BW01_refined$DV), ".", Fluc_NONMEM_mul_impute_BW01_refined$DV)

Fluc_NONMEM_mul_impute_BW01_refined$TAD <- ifelse(is.na(Fluc_NONMEM_mul_impute_BW01_refined$TAD), ".", Fluc_NONMEM_mul_impute_BW01_refined$TAD)

# Another way of coding this
Fluc_NONMEM_mul_impute_BW01_refined$DV[is.na(Fluc_NONMEM_mul_impute_BW01_refined$DV)] <- "."


# Exclude into refined dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan/vpc")
write.csv(Fluc_NONMEM_mul_impute_BW01_refined, "Fluc_NONMEM_mul_impute_BW01_refined.csv",quote=F,row.names = FALSE)

```

#### Refine Fluc_NONMEM_mul_impute_BW02 dataset to make 10 vpcs 

```{r refine Fluc_NONMEM_mul_impute_BW02 making 10 vpcs, warning=FALSE}

# Refine Fluc_NONMEM_mul_impute_BW02 dataset, exclude all having either DV>70 or TAD>25.5
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan")

Fluc_NONMEM_mul_impute_BW02 <- read.csv("Fluc_NONMEM_mul_impute_BW02.csv")

Fluc_NONMEM_mul_impute_BW02$DV<-as.numeric(Fluc_NONMEM_mul_impute_BW02$DV)

Fluc_NONMEM_mul_impute_BW02$TAD<-as.numeric(Fluc_NONMEM_mul_impute_BW02$TAD)

# The refined dataset
Fluc_NONMEM_mul_impute_BW02_refined <- Fluc_NONMEM_mul_impute_BW02 %>%
  filter((TAD <= 25.5|is.na(DV)))
Fluc_NONMEM_mul_impute_BW02_refined <- Fluc_NONMEM_mul_impute_BW02_refined %>%
  filter((DV <= 70|is.na(DV)))
# eliminate 25 concentration - time points

# Replace NAs in DV & TAD with "."

Fluc_NONMEM_mul_impute_BW02_refined$TAD[is.na(Fluc_NONMEM_mul_impute_BW02_refined$TAD)] <- "."
Fluc_NONMEM_mul_impute_BW02_refined$DV[is.na(Fluc_NONMEM_mul_impute_BW02_refined$DV)] <- "."

# Exclude into refined dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan/vpc")
write.csv(Fluc_NONMEM_mul_impute_BW02_refined, "Fluc_NONMEM_mul_impute_BW02_refined.csv",quote=F,row.names = FALSE)

```

### Doing simulation - 091023

#### First of all, check the correlation between BW & CKDEPI - overall

```{r correlation BW & CKDEPI}

cor(FlucTotIV_clean$CKDEPI,FlucTotIV_clean$BW2) #Equal NA
# Note: in cor(x,y), y needs to have compatible dimensions to x
FlucTotIV_clean %>% filter (!is.na(CKDEPI)) %>% summarize(correlation = cor(CKDEPI, BW2,method="pearson")) #-0.175662 #weak negative #Ask Erwin if it can be ignored?

```

#### Then check the correlation between BW & CKDEPI - non-CRRT patients

```{r correlation BW & CKDEPI}

# Identify all patients on CRRT
crrt_ids<-unique(FlucTotIV_clean$ID[FlucTotIV_clean$CRRT == 1])

# Dataset of all non-CRRT patients
FlucTotIV_clean_nocrrt<-FlucTotIV_clean%>%filter(!ID %in% crrt_ids)

# Correlation coefficient
# Note: in cor(x,y), y needs to have compatible dimensions to x
FlucTotIV_clean_nocrrt %>% filter (!is.na(CKDEPI)) %>% summarize(correlation = cor(CKDEPI, BW2,method="pearson")) #-0.2432515 #weak negative #Ask Erwin if it can be ignored - still relatively low

```

#### Creating simulation datasets, seperately for CRRT and non-CRRT

##### First of all, explore the covariate characteristics of my actual dataset

```{r checking normal distribution of CKDEPI - overall dataset}

# Test if CKDEPI has a normal distribution
test <- FlucTotIV_clean %>% select(ID, CKDEPI,CRRT) %>% unique() %>% mutate(CKDEPI2 = log10(CKDEPI))

test<-na.omit(test)

# Making a qqplot
qqnorm(test$CKDEPI, pch = 1, frame = FALSE)
qqline(test$CKDEPI, col = "steelblue", lwd = 2)

shapiro.test(test$CKDEPI) # p-value = 4.691e-11 - non-normal

# For the log-transformed CKDEPI
qqnorm(test$CKDEPI2, pch = 1, frame = FALSE)
qqline(test$CKDEPI2, col = "steelblue", lwd = 2)

shapiro.test(test$CKDEPI2) #p-value = 1.281e-15

# normal distribution doesn't work

```

```{r checking normal distribution of CKDEPI - non-CRRT dataset}

# Test if CKDEPI has a normal distribution
test <- FlucTotIV_clean_nocrrt %>% select(ID, CKDEPI) %>% unique() %>% mutate(CKDEPI2 = log10(CKDEPI))

test<-na.omit(test)

# Making a qqplot
qqnorm(test$CKDEPI, pch = 1, frame = FALSE)
qqline(test$CKDEPI, col = "steelblue", lwd = 2)

shapiro.test(test$CKDEPI) # p-value = 3.807e-09 - non-normal

# For the log-transformed CKDEPI
qqnorm(test$CKDEPI2, pch = 1, frame = FALSE)
qqline(test$CKDEPI2, col = "steelblue", lwd = 2)

shapiro.test(test$CKDEPI2) #p-value = 2.2e-16

# normal distribution doesn't work

```

```{r checking normal distribution of BW - non-CRRT dataset}

# Test if BW2 has a normal distribution
test <- FlucTotIV_clean_nocrrt %>% select(ID, BW2) %>% unique() %>% mutate(BW = log10(BW2))

test<-na.omit(test)

# Making a qqplot
qqnorm(test$BW2, pch = 1, frame = FALSE)
qqline(test$BW2, col = "steelblue", lwd = 2)

shapiro.test(test$BW2) # p-value = 0.03124 - non-normal

# For the log-transformed BW
qqnorm(test$BW, pch = 1, frame = FALSE)
qqline(test$BW, col = "steelblue", lwd = 2)

shapiro.test(test$BW) #p-value = 0.09443 - still quite small

# normal distribution doesn't work

```

```{r comparing CKDEPI of CRRT vs non-CRRT - not necessary anymore}
# comparing if CRRT vs non-CRRT patients have a different distribution

crrt_ids<-unique(test$ID[test$CRRT == 1])

# Perform Mann-Whitney U test
non_parametric_test <- wilcox.test(CKDEPI ~ ifelse(ID %in% crrt_ids, "CRRT", "Non-CRRT"), data = test)

# Print the test results
print(non_parametric_test) #p=1.434e-12 #crrt & non-crrt patients have different CKDEPI distributions

#CRRT and non-CRRT patients does not have a similar CKDEPI distribution

# Summary statistics of CRRT vs non-CRRT patients

# Calculate summary statistics for CKDEPI for patients in crrt_ids
summary_in_crrt <- test %>%
  filter(ID %in% crrt_ids) %>%
  summarize(
    Mean_CKDEPI = mean(CKDEPI, na.rm = TRUE),
    Median_CKDEPI = median(CKDEPI, na.rm = TRUE),
    Min_CKDEPI = min(CKDEPI, na.rm = TRUE),
    Max_CKDEPI = max(CKDEPI, na.rm = TRUE),
    SD_CKDEPI = sd(CKDEPI, na.rm = TRUE)
  )

# Calculate summary statistics for CKDEPI for patients not in crrt_ids
summary_not_in_crrt <- test %>%
  filter(!ID %in% crrt_ids) %>%
  summarize(
    Mean_CKDEPI = mean(CKDEPI, na.rm = TRUE),
    Median_CKDEPI = median(CKDEPI, na.rm = TRUE),
    Min_CKDEPI = min(CKDEPI, na.rm = TRUE),
    Max_CKDEPI = max(CKDEPI, na.rm = TRUE),
    SD_CKDEPI = sd(CKDEPI, na.rm = TRUE)
  )
summary_in_crrt
summary_not_in_crrt

```

```{r comparing BW of CRRT vs non-CRRT}

test <- FlucTotIV_clean %>% select(ID, BW2,CRRT) %>% unique() %>% mutate(BW = log10(BW2))

# comparing if CRRT vs non-CRRT patients have a different distribution

crrt_ids<-unique(test$ID[test$CRRT == 1])

# Perform Mann-Whitney U test
non_parametric_test <- wilcox.test(BW2 ~ ifelse(ID %in% crrt_ids, "CRRT", "Non-CRRT"), data = test)

# Print the test results
print(non_parametric_test) #p=0.8322 #crrt & non-crrt patients have the same BW distributions

#CRRT and non-CRRT patients have a similar BW distribution

```

##### Secondly, creating virtual patient datasets

##### Strategy: make seperate datasets for CRRT & non-CRRT patients. With non-CRRT patients: CKDEPI sampled from non-CRRT events distribution, BW sampled from total BW distribution. For CRRT patients, BW sampled from total BW distribution.

##### Firstly, the effect of CKDEPI in non-CRRT patients

```{r import virtual patient dataset dosing_08, warning=FALSE}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Simulation datasets")
sim_dosing_01<-read.csv("dosing_08.csv")

# With dose-finding simulation, we don't need a dense sampling strategy, since we only care about trough and AUC-24 target attainment

```

```{r finetune dosing_08 dataset, warning=FALSE}

# Eliminate all rows with PEAK == 1
sim_dosing_01<- sim_dosing_01 %>% filter(PEAK==0)

# Eliminate PEAK column
sim_dosing_01$PEAK<-NULL

# Convert CRRT into 0
sim_dosing_01$CRRT<-0

# summary statistics for CKDEPI in non-CRRT patients
summary(FlucTotIV_clean$CKDEPI[FlucTotIV_clean$CRRT == 0])

# Min 5 - max 215 - so I will try firstly distance = 10, and then = 5.
# Note: Normal kidney function is from 90 to 120 mL/min/1.73 m2

# Creat a new column "CKDEPI" for sim_dosing_01 dataset
sim_dosing_01 <- sim_dosing_01 %>%
  mutate(CKDEPI = ifelse(ID == 1, 5, 5 + (ID - 1) * 10))

# Delete all the rows with CKDEPI > 215

sim_dosing_01 <- sim_dosing_01 %>%
  filter(CKDEPI <= 215)

# Change ID into ID_CKDEPI
sim_dosing_01 <- sim_dosing_01 %>%
  rename(ID_CKDEPI = ID)

# Replicate each ID_CKDEPI 100 times
sim_dosing_01<-sim_dosing_01 %>%
  group_by(ID_CKDEPI) %>%
  slice(rep(1:n(), each = 100)) %>%
  ungroup()

# Assign an ID for each replication
sim_dosing_01 <- sim_dosing_01 %>%
  arrange(TIME) %>%
  group_by(TIME) %>%
  mutate(ID = row_number()) %>%
  ungroup()

##  Assign a unique BW per each ID

# Step 1: Get unique, non-missing values of BW2 from FlucTotIV_clean
unique_BW2 <- FlucTotIV_clean %>%
  distinct(BW2, .keep_all = TRUE) %>%
  filter(!is.na(BW2)) %>%
  pull(BW2)

# Create a new dataset "new_dataset" with ID from 1 to 2200
new_dataset <- data.frame(ID = 1:2200)

# Step 2: Create an ECDF based on unique BW2 values
ecdf_BW2 <- ecdf(unique_BW2)

# Create a vector to store the sampled BWs
sampled_BWs <- numeric(0)

# Loop 22 times to get 22 sets of 100 random values
for (i in 1:22) {
  # Generate random values from the ECDF
  random_values <- runif(100)

  # Map the random values to the empirical distribution using the inverse transform sampling method
  sampled_BW <- round(quantile(unique_BW2, random_values), 1)

  # Append the sampled BWs to the vector
  sampled_BWs <- c(sampled_BWs, sampled_BW)
}

# Assuming new_dataset is your data frame with IDs
new_dataset$BW <- sampled_BWs

# Now, you have "new_dataset" with unique BW values for each set of 100 IDs

# Merge "new_dataset" with "sim_dosing_01" dataset based on ID
sim_dosing_01 <- sim_dosing_01 %>%
  left_join(new_dataset, by = "ID")

# Rename BW
sim_dosing_01$BW.x<-NULL
sim_dosing_01 <- sim_dosing_01 %>%
  rename(BW = BW.y)

# Eliminate ID_CKDEPI, change the name of the dataset
sim_CKDEPI_01<-sim_dosing_01 %>%
  select(ID_CKDEPI, ID, everything())
sim_CKDEPI_01$ID_CKDEPI<-NULL

# Sort sim_CKDEPI_01 according to ID
sim_CKDEPI_01 <- sim_CKDEPI_01 %>%
  arrange(ID)

# Export sim_CKDEPI_01 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(sim_CKDEPI_01, "sim_CKDEPI_01.csv",quote=F,row.names = FALSE)

# Here I have another _min dataset, where all dosing events need to be kept, and eliminate all redundant dummy lines
sim_CKDEPI_01_min <- sim_CKDEPI_01 %>%
  filter((DAY %in% c(3, 4, 5, 8, 9, 10, 11, 12) & TAD == 0) | (!DAY %in% c(3, 4,5, 8, 9, 10, 11, 12)))

# Then Export sim_CKDEPI_01_min dataset (min stands for minimize)
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(sim_CKDEPI_01_min, "sim_CKDEPI_01_min.csv",quote=F,row.names = FALSE)

```

```{r testing the standard dosing 800 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_CKD_01_min dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
sim_CKDEPI_01_min<-read.csv("sim_CKDEPI_01_min.csv")
#sim_CKDEPI_01<-read.csv("sim_CKDEPI_01.csv")

View(sim_CKDEPI_01_min)
sim_CKDEPI_01_min$AMT<-ifelse(sim_CKDEPI_01_min$TIME==0,800,ifelse(sim_CKDEPI_01_min$TAD==0,400,0))

# Export sim_CKDEPI_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(sim_CKDEPI_01_min, "sim_CKDEPI_02.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 03 1000 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_CKD_01_min dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
sim_CKDEPI_01_min<-read.csv("sim_CKDEPI_01_min.csv")

View(sim_CKDEPI_01_min)
sim_CKDEPI_01_min$AMT<-ifelse(sim_CKDEPI_01_min$TIME==0,1000,ifelse(sim_CKDEPI_01_min$TAD==0,400,0))

# Export sim_CKDEPI_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(sim_CKDEPI_01_min, "sim_CKDEPI_03.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 04 1200 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_CKD_01_min dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
sim_CKDEPI_01_min<-read.csv("sim_CKDEPI_01_min.csv")

View(sim_CKDEPI_01_min)
sim_CKDEPI_01_min$AMT<-ifelse(sim_CKDEPI_01_min$TIME==0,1200,ifelse(sim_CKDEPI_01_min$TAD==0,400,0))

# Export sim_CKDEPI_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(sim_CKDEPI_01_min, "sim_CKDEPI_04.csv",quote=F,row.names = FALSE)

```

##### Next, effect of BW in non-CRRT patients

```{r import virtual patient dataset dosing_08, warning=FALSE}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Simulation datasets")
sim_dosing_01<-read.csv("dosing_08.csv")

# With dose-finding simulation, we don't need a dense sampling strategy, since we only care about trough and AUC-24 target attainment

```

```{r finetune dosing_08 dataset, warning=FALSE}

# Eliminate all rows with PEAK == 1
sim_dosing_01<- sim_dosing_01 %>% filter(PEAK==0)

# Eliminate PEAK column
sim_dosing_01$PEAK<-NULL

# Convert CRRT into 0
sim_dosing_01$CRRT<-0

# Change ID into ID_BW
sim_dosing_01 <- sim_dosing_01 %>%
  rename(ID_BW = ID)

# Replicate each ID_CKDEPI 100 times
sim_dosing_01<-sim_dosing_01 %>%
  group_by(ID_BW) %>%
  slice(rep(1:n(), each = 100)) %>%
  ungroup()

# Assign an ID for each replication
sim_dosing_01 <- sim_dosing_01 %>%
  arrange(TIME) %>%
  group_by(TIME) %>%
  mutate(ID = row_number()) %>%
  ungroup()

##  Assign a unique CKDEPI per each ID

# Step 1: Get unique, non-missing values of CKDEPI from FlucTotIV_clean with CRRT = 0
unique_CKDEPI <- FlucTotIV_clean %>% filter (CRRT==0) %>%
  filter(!is.na(CKDEPI)) %>%
  pull(CKDEPI)

# Create a new dataset "new_dataset" with ID from 1 to 2500
new_dataset <- data.frame(ID = 1:2500)

# Step 2: Create an ECDF based on unique CKDEPI values
ecdf_CKDEPI <- ecdf(unique_CKDEPI)

# Create a vector to store the sampled CKDEPIs
sampled_CKDEPIs <- numeric(0)

# Loop 25 times to get 25 sets of 100 random values
for (i in 1:25) {
  # Generate random values from the ECDF
  random_values <- runif(100)

  # Map the random values to the empirical distribution using the inverse transform sampling method
  sampled_CKDEPI <- round(quantile(unique_CKDEPI, random_values), 1)

  # Append the sampled CKDEPIs to the vector
  sampled_CKDEPIs <- c(sampled_CKDEPIs, sampled_CKDEPI)
}

# Assuming new_dataset is your data frame with IDs
new_dataset$CKDEPI <- sampled_CKDEPIs

# Now, you have "new_dataset" with unique BW values for each set of 100 IDs

# Merge "new_dataset" with "sim_dosing_01" dataset based on ID
sim_dosing_01 <- sim_dosing_01 %>%
  left_join(new_dataset, by = "ID")

# Eliminate ID_BW, change the name of the dataset
sim_BW_01<-sim_dosing_01 %>%
  select(ID_BW, ID, everything())
sim_BW_01$ID_BW<-NULL

# Sort sim_BW_01 according to ID
sim_BW_01 <- sim_BW_01 %>%
  arrange(ID)

# Export sim_BW_01 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_01, "sim_BW_01.csv",quote=F,row.names = FALSE)

# Minimizing the dataset where all dosing events are kept, and all redundant dummy lines can be eliminated
sim_BW_01_min <- sim_BW_01 %>%
  filter((DAY %in% c(3, 4, 5, 8, 9, 10, 11, 12) & TAD == 0) | (!DAY %in% c(3, 4,5, 8, 9, 10, 11, 12)))

# Then Export sim_BW_noCRRT_01 dataset (min stands for minimize)
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_01_min, "sim_BW_noCRRT_01.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 02 the CKDEPI optimized dosing 1200 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_noCRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_noCRRT_01<-read.csv("sim_BW_noCRRT_01.csv")

View(sim_BW_noCRRT_01)
sim_BW_noCRRT_01$AMT<-ifelse(sim_BW_noCRRT_01$TIME==0,1200,ifelse(sim_BW_noCRRT_01$TAD==0,400,0))

# Export sim_BW_noCRRT_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_noCRRT_01, "sim_BW_noCRRT_02.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 03 of 1000 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_noCRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_noCRRT_01<-read.csv("sim_BW_noCRRT_01.csv")

View(sim_BW_noCRRT_01)
sim_BW_noCRRT_01$AMT<-ifelse(sim_BW_noCRRT_01$TIME==0,1000,ifelse(sim_BW_noCRRT_01$TAD==0,400,0))

# Export sim_BW_noCRRT_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_noCRRT_01, "sim_BW_noCRRT_03.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 04 of 800 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_noCRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_noCRRT_01<-read.csv("sim_BW_noCRRT_01.csv")

View(sim_BW_noCRRT_01)
sim_BW_noCRRT_01$AMT<-ifelse(sim_BW_noCRRT_01$TIME==0,800,ifelse(sim_BW_noCRRT_01$TAD==0,400,0))

# Export sim_BW_noCRRT_04 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_noCRRT_01, "sim_BW_noCRRT_04.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 05 of 1400 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_noCRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_noCRRT_01<-read.csv("sim_BW_noCRRT_01.csv")

View(sim_BW_noCRRT_01)
sim_BW_noCRRT_01$AMT<-ifelse(sim_BW_noCRRT_01$TIME==0,1400,ifelse(sim_BW_noCRRT_01$TAD==0,400,0))

# Export sim_BW_noCRRT_05 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_noCRRT_01, "sim_BW_noCRRT_05.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 06 of 1600 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_noCRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_noCRRT_01<-read.csv("sim_BW_noCRRT_01.csv")

View(sim_BW_noCRRT_01)
sim_BW_noCRRT_01$AMT<-ifelse(sim_BW_noCRRT_01$TIME==0,1600,ifelse(sim_BW_noCRRT_01$TAD==0,400,0))

# Export sim_BW_noCRRT_06 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_noCRRT_01, "sim_BW_noCRRT_06.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 07 of 1800 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_noCRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_noCRRT_01<-read.csv("sim_BW_noCRRT_01.csv")

View(sim_BW_noCRRT_01)
sim_BW_noCRRT_01$AMT<-ifelse(sim_BW_noCRRT_01$TIME==0,1800,ifelse(sim_BW_noCRRT_01$TAD==0,400,0))

# Export sim_BW_noCRRT_07 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_noCRRT_01, "sim_BW_noCRRT_07.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 08 of 800 LD & 200 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_noCRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_noCRRT_01<-read.csv("sim_BW_noCRRT_01.csv")

View(sim_BW_noCRRT_01)
sim_BW_noCRRT_01$AMT<-ifelse(sim_BW_noCRRT_01$TIME==0,800,ifelse(sim_BW_noCRRT_01$TAD==0,200,0))

# Export sim_BW_noCRRT_08 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_noCRRT_01, "sim_BW_noCRRT_08.csv",quote=F,row.names = FALSE)

```

##### Thirdly, effect of BW in CRRT patients

```{r import virtual patient dataset dosing_08, warning=FALSE}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Simulation datasets")
sim_dosing_01<-read.csv("dosing_08.csv")

# With dose-finding simulation, we don't need a dense sampling strategy, since we only care about trough and AUC-24 target attainment

```

```{r finetune dosing_08 dataset, warning=FALSE}

# Eliminate all rows with PEAK == 1
sim_dosing_01<- sim_dosing_01 %>% dplyr::filter(PEAK==0)

# Eliminate PEAK column
sim_dosing_01$PEAK<-NULL

# BW CRRT sim dataset
sim_BW_CRRT_01 <- sim_dosing_01 %>%
  dplyr::filter((DAY %in% c(3, 4, 5, 8, 9, 10, 11, 12) & TAD == 0) | (!DAY %in% c(3, 4,5, 8, 9, 10, 11, 12)))

sim_BW_CRRT_01$CKDEPI <- 0

# Then Export sim_BW_01_min dataset (min stands for minimize)
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_CRRT_01, "sim_BW_CRRT_01.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 02 800 LD & 400 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_CRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_CRRT_01<-read.csv("sim_BW_CRRT_01.csv")

View(sim_BW_CRRT_01)
sim_BW_CRRT_01$AMT<-ifelse(sim_BW_CRRT_01$TIME==0,800,ifelse(sim_BW_noCRRT_01$TAD==0,400,0))

# Export sim_BW_CRRT_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_CRRT_01, "sim_BW_CRRT_02.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 03 1000 LD & 600 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_CRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_CRRT_01<-read.csv("sim_BW_CRRT_01.csv")

View(sim_BW_CRRT_01)
sim_BW_CRRT_01$AMT<-ifelse(sim_BW_CRRT_01$TIME==0,1000,ifelse(sim_BW_noCRRT_01$TAD==0,600,0))

# Export sim_BW_CRRT_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_CRRT_01, "sim_BW_CRRT_03.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 04 1000 LD & 800 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_CRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_CRRT_01<-read.csv("sim_BW_CRRT_01.csv")

View(sim_BW_CRRT_01)
sim_BW_CRRT_01$AMT<-ifelse(sim_BW_CRRT_01$TIME==0,1000,ifelse(sim_BW_noCRRT_01$TAD==0,800,0))

# Export sim_BW_CRRT_04 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_CRRT_01, "sim_BW_CRRT_04.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 05 1400 LD & 800 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_CRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_CRRT_01<-read.csv("sim_BW_CRRT_01.csv")

View(sim_BW_CRRT_01)
sim_BW_CRRT_01$AMT<-ifelse(sim_BW_CRRT_01$TIME==0,1400,ifelse(sim_BW_noCRRT_01$TAD==0,800,0))

# Export sim_BW_CRRT_05 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_CRRT_01, "sim_BW_CRRT_05.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 06 1600 LD & 800 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_CRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_CRRT_01<-read.csv("sim_BW_CRRT_01.csv")

View(sim_BW_CRRT_01)
sim_BW_CRRT_01$AMT<-ifelse(sim_BW_CRRT_01$TIME==0,1600,ifelse(sim_BW_noCRRT_01$TAD==0,800,0))

# Export sim_BW_CRRT_06 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_CRRT_01, "sim_BW_CRRT_06.csv",quote=F,row.names = FALSE)

```

```{r testing dosing 07 1800 LD & 800 MD, warning=FALSE}

# Change the dosing regimen using sim_BW_CRRT_01 dataset above

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
sim_BW_CRRT_01<-read.csv("sim_BW_CRRT_01.csv")

View(sim_BW_CRRT_01)
sim_BW_CRRT_01$AMT<-ifelse(sim_BW_CRRT_01$TIME==0,1800,ifelse(sim_BW_noCRRT_01$TAD==0,800,0))

# Export sim_BW_CRRT_07 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(sim_BW_CRRT_01, "sim_BW_CRRT_07.csv",quote=F,row.names = FALSE)

```

#### Analyzing simulation datasets

##### Firstly, CKDEPI effect output datasets

```{r for the 1200 LD & 800 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_CKDEPI_01_min.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
CKDEPI_dos_01 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
CKDEPI_dos_01$ID<-as.integer(CKDEPI_dos_01$ID)

# Create a new variable AUC24 for each ID
CKDEPI_dos_01 <- CKDEPI_dos_01 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

CKDEPI_dos_01<- CKDEPI_dos_01 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
CKDEPI_dos_01$fAUC<- CKDEPI_dos_01$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and CKDEPI columns
PTA_01 <- subset(CKDEPI_dos_01, select = c("ID", "DV", "fAUC", "DAY", "CKDEPI"))

# Calculate percentage of DV >= 7.5 per DAY per CKDEPI (PTA_Cmin_75)
PTA_01$PTA_Cmin_75 <- 100 * ave(PTA_01$DV >= 7.5, PTA_01$DAY, PTA_01$CKDEPI, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per CKDEPI (PTA_Cmin_80)
PTA_01$PTA_Cmin_80 <- 100 * ave(PTA_01$DV >= 80, PTA_01$DAY, PTA_01$CKDEPI, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per CKDEPI (PTA_fAUC_200)
PTA_01$PTA_fAUC_200 <- 100 * ave(PTA_01$fAUC >= 200, PTA_01$DAY, PTA_01$CKDEPI, FUN = mean)

# Create PTA_01_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and CKDEPI
PTA_01_overall <- unique(PTA_01[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "CKDEPI")])

# Export PTA_dos_01 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(PTA_01_overall, "PTA_dos_01.csv",quote=F,row.names = FALSE)

```

```{r for the 800 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_CKDEPI_02.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
CKDEPI_dos_02 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
CKDEPI_dos_02$ID<-as.integer(CKDEPI_dos_02$ID)

# Create a new variable AUC24 for each ID
CKDEPI_dos_02 <- CKDEPI_dos_02 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

CKDEPI_dos_02<- CKDEPI_dos_02 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
CKDEPI_dos_02$fAUC<- CKDEPI_dos_02$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and CKDEPI columns
PTA_02 <- subset(CKDEPI_dos_02, select = c("ID", "DV", "fAUC", "DAY", "CKDEPI"))

# Calculate percentage of DV >= 7.5 per DAY per CKDEPI (PTA_Cmin_75)
PTA_02$PTA_Cmin_75 <- 100 * ave(PTA_02$DV >= 7.5, PTA_02$DAY, PTA_02$CKDEPI, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per CKDEPI (PTA_Cmin_80)
PTA_02$PTA_Cmin_80 <- 100 * ave(PTA_02$DV >= 80, PTA_02$DAY, PTA_02$CKDEPI, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per CKDEPI (PTA_fAUC_200)
PTA_02$PTA_fAUC_200 <- 100 * ave(PTA_02$fAUC >= 200, PTA_02$DAY, PTA_02$CKDEPI, FUN = mean)

# Create PTA_02_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and CKDEPI
PTA_02_overall <- unique(PTA_02[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "CKDEPI")])

# Export PTA_dos_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(PTA_02_overall, "PTA_dos_02.csv",quote=F,row.names = FALSE)

```

```{r for the 1000 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_CKDEPI_03.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
CKDEPI_dos_03 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
CKDEPI_dos_03$ID<-as.integer(CKDEPI_dos_03$ID)

# Create a new variable AUC24 for each ID
CKDEPI_dos_03 <- CKDEPI_dos_03 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

CKDEPI_dos_03<- CKDEPI_dos_03 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
CKDEPI_dos_03$fAUC<- CKDEPI_dos_03$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and CKDEPI columns
PTA_03 <- subset(CKDEPI_dos_03, select = c("ID", "DV", "fAUC", "DAY", "CKDEPI"))

# Calculate percentage of DV >= 7.5 per DAY per CKDEPI (PTA_Cmin_75)
PTA_03$PTA_Cmin_75 <- 100 * ave(PTA_03$DV >= 7.5, PTA_03$DAY, PTA_03$CKDEPI, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per CKDEPI (PTA_Cmin_80)
PTA_03$PTA_Cmin_80 <- 100 * ave(PTA_03$DV >= 80, PTA_03$DAY, PTA_03$CKDEPI, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per CKDEPI (PTA_fAUC_200)
PTA_03$PTA_fAUC_200 <- 100 * ave(PTA_03$fAUC >= 200, PTA_03$DAY, PTA_03$CKDEPI, FUN = mean)

# Create PTA_03_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and CKDEPI
PTA_03_overall <- unique(PTA_03[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "CKDEPI")])

# Export PTA_dos_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(PTA_03_overall, "PTA_dos_03.csv",quote=F,row.names = FALSE)

```

```{r for the 1200 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_CKDEPI_04.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
CKDEPI_dos_04 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
CKDEPI_dos_04$ID<-as.integer(CKDEPI_dos_04$ID)

# Create a new variable AUC24 for each ID
CKDEPI_dos_04 <- CKDEPI_dos_04 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

CKDEPI_dos_04<- CKDEPI_dos_04 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
CKDEPI_dos_04$fAUC<- CKDEPI_dos_04$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and CKDEPI columns
PTA_04 <- subset(CKDEPI_dos_04, select = c("ID", "DV", "fAUC", "DAY", "CKDEPI"))

# Calculate percentage of DV >= 7.5 per DAY per CKDEPI (PTA_Cmin_75)
PTA_04$PTA_Cmin_75 <- 100 * ave(PTA_04$DV >= 7.5, PTA_04$DAY, PTA_04$CKDEPI, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per CKDEPI (PTA_Cmin_80)
PTA_04$PTA_Cmin_80 <- 100 * ave(PTA_04$DV >= 80, PTA_04$DAY, PTA_04$CKDEPI, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per CKDEPI (PTA_fAUC_200)
PTA_04$PTA_fAUC_200 <- 100 * ave(PTA_04$fAUC >= 200, PTA_04$DAY, PTA_04$CKDEPI, FUN = mean)

# Create PTA_04_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and CKDEPI
PTA_04_overall <- unique(PTA_04[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "CKDEPI")])

# Export PTA_dos_04 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
write.csv(PTA_04_overall, "PTA_dos_04.csv",quote=F,row.names = FALSE)

```

##### Secondly, BW non-CRRT effect output datasets

```{r for the 1200 LD & 800 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_noCRRT_01.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_noCRRT_dos_01 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_noCRRT_dos_01$ID<-as.integer(BW_noCRRT_dos_01$ID)

# Create a new variable AUC24 for each ID
BW_noCRRT_dos_01 <- BW_noCRRT_dos_01 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_noCRRT_dos_01<- BW_noCRRT_dos_01 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_noCRRT_dos_01$fAUC<- BW_noCRRT_dos_01$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_noCRRT_01 <- subset(BW_noCRRT_dos_01, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_noCRRT_01$PTA_Cmin_75 <- 100 * ave(PTA_noCRRT_01$DV >= 7.5, PTA_noCRRT_01$DAY, PTA_noCRRT_01$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_noCRRT_01$PTA_Cmin_80 <- 100 * ave(PTA_noCRRT_01$DV >= 80, PTA_noCRRT_01$DAY, PTA_noCRRT_01$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_noCRRT_01$PTA_fAUC_200 <- 100 * ave(PTA_noCRRT_01$fAUC >= 200, PTA_noCRRT_01$DAY, PTA_noCRRT_01$BW, FUN = mean)

# Calculate percentage of fAUC >= 400 per DAY per BW (PTA_fAUC_400) #Isabel'comment on simulating for MIC of 4 mg/L
PTA_noCRRT_01$PTA_fAUC_400 <- 100 * ave(PTA_noCRRT_01$fAUC >= 400, PTA_noCRRT_01$DAY, PTA_noCRRT_01$BW, FUN = mean)

# Create PTA_noCRRT_01_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_01_overall <- unique(PTA_noCRRT_01[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200","PTA_fAUC_400", "DAY", "BW")])

# Export PTA_noCRRT_dos_01 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_noCRRT_01_overall, "PTA_noCRRT_dos_01.csv",quote=F,row.names = FALSE)

# Export BW_noCRRT_dos_01.csv for future use
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(BW_noCRRT_dos_01, "BW_noCRRT_dos_01.csv",quote=F,row.names = FALSE)

```

```{r for the 1200 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_noCRRT_02.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_noCRRT_dos_02 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_noCRRT_dos_02$ID<-as.integer(BW_noCRRT_dos_02$ID)

# Create a new variable AUC24 for each ID
BW_noCRRT_dos_02 <- BW_noCRRT_dos_02 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_noCRRT_dos_02<- BW_noCRRT_dos_02 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_noCRRT_dos_02$fAUC<- BW_noCRRT_dos_02$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_noCRRT_02 <- subset(BW_noCRRT_dos_02, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_noCRRT_02$PTA_Cmin_75 <- 100 * ave(PTA_noCRRT_02$DV >= 7.5, PTA_noCRRT_02$DAY, PTA_noCRRT_02$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_noCRRT_02$PTA_Cmin_80 <- 100 * ave(PTA_noCRRT_02$DV >= 80, PTA_noCRRT_02$DAY, PTA_noCRRT_02$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_noCRRT_02$PTA_fAUC_200 <- 100 * ave(PTA_noCRRT_02$fAUC >= 200, PTA_noCRRT_02$DAY, PTA_noCRRT_02$BW, FUN = mean)

# Calculate percentage of fAUC >= 400 per DAY per BW (PTA_fAUC_400) #Isabel'comment on simulating for MIC of 4 mg/L
PTA_noCRRT_02$PTA_fAUC_400 <- 100 * ave(PTA_noCRRT_02$fAUC >= 400, PTA_noCRRT_02$DAY, PTA_noCRRT_02$BW, FUN = mean)

# Create PTA_noCRRT_02_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_02_overall <- unique(PTA_noCRRT_02[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200","PTA_fAUC_400", "DAY", "BW")])

# Create PTA_noCRRT_02_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_02_overall <- unique(PTA_noCRRT_02[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_noCRRT_dos_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_noCRRT_02_overall, "PTA_noCRRT_dos_02.csv",quote=F,row.names = FALSE)

```

```{r for the 1000 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_noCRRT_03.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_noCRRT_dos_03 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_noCRRT_dos_03$ID<-as.integer(BW_noCRRT_dos_03$ID)

# Create a new variable AUC24 for each ID
BW_noCRRT_dos_03 <- BW_noCRRT_dos_03 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_noCRRT_dos_03<- BW_noCRRT_dos_03 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_noCRRT_dos_03$fAUC<- BW_noCRRT_dos_03$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_noCRRT_03 <- subset(BW_noCRRT_dos_03, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_noCRRT_03$PTA_Cmin_75 <- 100 * ave(PTA_noCRRT_03$DV >= 7.5, PTA_noCRRT_03$DAY, PTA_noCRRT_03$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_noCRRT_03$PTA_Cmin_80 <- 100 * ave(PTA_noCRRT_03$DV >= 80, PTA_noCRRT_03$DAY, PTA_noCRRT_03$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_noCRRT_03$PTA_fAUC_200 <- 100 * ave(PTA_noCRRT_03$fAUC >= 200, PTA_noCRRT_03$DAY, PTA_noCRRT_03$BW, FUN = mean)

# Create PTA_noCRRT_03_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_03_overall <- unique(PTA_noCRRT_03[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_noCRRT_dos_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_noCRRT_03_overall, "PTA_noCRRT_dos_03.csv",quote=F,row.names = FALSE)

```

```{r for the 800 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_noCRRT_04.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_noCRRT_dos_04 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_noCRRT_dos_04$ID<-as.integer(BW_noCRRT_dos_04$ID)

# Create a new variable AUC24 for each ID
BW_noCRRT_dos_04 <- BW_noCRRT_dos_04 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_noCRRT_dos_04<- BW_noCRRT_dos_04 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_noCRRT_dos_04$fAUC<- BW_noCRRT_dos_04$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_noCRRT_04 <- subset(BW_noCRRT_dos_04, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_noCRRT_04$PTA_Cmin_75 <- 100 * ave(PTA_noCRRT_04$DV >= 7.5, PTA_noCRRT_04$DAY, PTA_noCRRT_04$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_noCRRT_04$PTA_Cmin_80 <- 100 * ave(PTA_noCRRT_04$DV >= 80, PTA_noCRRT_04$DAY, PTA_noCRRT_04$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_noCRRT_04$PTA_fAUC_200 <- 100 * ave(PTA_noCRRT_04$fAUC >= 200, PTA_noCRRT_04$DAY, PTA_noCRRT_04$BW, FUN = mean)

# Create PTA_noCRRT_04_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_04_overall <- unique(PTA_noCRRT_04[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_noCRRT_dos_04 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_noCRRT_04_overall, "PTA_noCRRT_dos_04.csv",quote=F,row.names = FALSE)

```

```{r for the 1400 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_noCRRT_05.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_noCRRT_dos_05 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_noCRRT_dos_05$ID<-as.integer(BW_noCRRT_dos_05$ID)

# Create a new variable AUC24 for each ID
BW_noCRRT_dos_05 <- BW_noCRRT_dos_05 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_noCRRT_dos_05<- BW_noCRRT_dos_05 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_noCRRT_dos_05$fAUC<- BW_noCRRT_dos_05$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_noCRRT_05 <- subset(BW_noCRRT_dos_05, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_noCRRT_05$PTA_Cmin_75 <- 100 * ave(PTA_noCRRT_05$DV >= 7.5, PTA_noCRRT_05$DAY, PTA_noCRRT_05$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_noCRRT_05$PTA_Cmin_80 <- 100 * ave(PTA_noCRRT_05$DV >= 80, PTA_noCRRT_05$DAY, PTA_noCRRT_05$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_noCRRT_05$PTA_fAUC_200 <- 100 * ave(PTA_noCRRT_05$fAUC >= 200, PTA_noCRRT_05$DAY, PTA_noCRRT_05$BW, FUN = mean)

# Create PTA_noCRRT_05_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_05_overall <- unique(PTA_noCRRT_05[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_noCRRT_dos_05 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_noCRRT_05_overall, "PTA_noCRRT_dos_05.csv",quote=F,row.names = FALSE)

```

```{r for the 1600 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_noCRRT_06.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_noCRRT_dos_06 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_noCRRT_dos_06$ID<-as.integer(BW_noCRRT_dos_06$ID)

# Create a new variable AUC24 for each ID
BW_noCRRT_dos_06 <- BW_noCRRT_dos_06 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_noCRRT_dos_06<- BW_noCRRT_dos_06 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_noCRRT_dos_06$fAUC<- BW_noCRRT_dos_06$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_noCRRT_06 <- subset(BW_noCRRT_dos_06, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_noCRRT_06$PTA_Cmin_75 <- 100 * ave(PTA_noCRRT_06$DV >= 7.5, PTA_noCRRT_06$DAY, PTA_noCRRT_06$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_noCRRT_06$PTA_Cmin_80 <- 100 * ave(PTA_noCRRT_06$DV >= 80, PTA_noCRRT_06$DAY, PTA_noCRRT_06$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_noCRRT_06$PTA_fAUC_200 <- 100 * ave(PTA_noCRRT_06$fAUC >= 200, PTA_noCRRT_06$DAY, PTA_noCRRT_06$BW, FUN = mean)

# Create PTA_noCRRT_06_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_06_overall <- unique(PTA_noCRRT_06[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_noCRRT_dos_06 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_noCRRT_06_overall, "PTA_noCRRT_dos_06.csv",quote=F,row.names = FALSE)

```

```{r for the 1800 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_noCRRT_07.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_noCRRT_dos_07 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_noCRRT_dos_07$ID<-as.integer(BW_noCRRT_dos_07$ID)

# Create a new variable AUC24 for each ID
BW_noCRRT_dos_07 <- BW_noCRRT_dos_07 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_noCRRT_dos_07<- BW_noCRRT_dos_07 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_noCRRT_dos_07$fAUC<- BW_noCRRT_dos_07$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_noCRRT_07 <- subset(BW_noCRRT_dos_07, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_noCRRT_07$PTA_Cmin_75 <- 100 * ave(PTA_noCRRT_07$DV >= 7.5, PTA_noCRRT_07$DAY, PTA_noCRRT_07$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_noCRRT_07$PTA_Cmin_80 <- 100 * ave(PTA_noCRRT_07$DV >= 80, PTA_noCRRT_07$DAY, PTA_noCRRT_07$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_noCRRT_07$PTA_fAUC_200 <- 100 * ave(PTA_noCRRT_07$fAUC >= 200, PTA_noCRRT_07$DAY, PTA_noCRRT_07$BW, FUN = mean)

# Create PTA_noCRRT_07_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_07_overall <- unique(PTA_noCRRT_07[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_noCRRT_dos_07 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_noCRRT_07_overall, "PTA_noCRRT_dos_07.csv",quote=F,row.names = FALSE)

```

```{r for the 800 LD & 200 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_noCRRT_08.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_noCRRT_dos_08 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_noCRRT_dos_08$ID<-as.integer(BW_noCRRT_dos_08$ID)

# Create a new variable AUC24 for each ID
BW_noCRRT_dos_08 <- BW_noCRRT_dos_08 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_noCRRT_dos_08<- BW_noCRRT_dos_08 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_noCRRT_dos_08$fAUC<- BW_noCRRT_dos_08$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_noCRRT_08 <- subset(BW_noCRRT_dos_08, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_noCRRT_08$PTA_Cmin_75 <- 100 * ave(PTA_noCRRT_08$DV >= 7.5, PTA_noCRRT_08$DAY, PTA_noCRRT_08$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_noCRRT_08$PTA_Cmin_80 <- 100 * ave(PTA_noCRRT_08$DV >= 80, PTA_noCRRT_08$DAY, PTA_noCRRT_08$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_noCRRT_08$PTA_fAUC_200 <- 100 * ave(PTA_noCRRT_08$fAUC >= 200, PTA_noCRRT_08$DAY, PTA_noCRRT_08$BW, FUN = mean)

# Create PTA_noCRRT_08_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_noCRRT_08_overall <- unique(PTA_noCRRT_08[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_noCRRT_dos_08 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_noCRRT_08_overall, "PTA_noCRRT_dos_08.csv",quote=F,row.names = FALSE)

```

##### Thirdly, BW CRRT effect output datasets

```{r for the 1200 LD & 800 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_CRRT_01.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_CRRT_dos_01 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_CRRT_dos_01$ID<-as.integer(BW_CRRT_dos_01$ID)

# Create a new variable AUC24 for each ID
BW_CRRT_dos_01 <- BW_CRRT_dos_01 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_CRRT_dos_01<- BW_CRRT_dos_01 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_CRRT_dos_01$fAUC<- BW_CRRT_dos_01$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_CRRT_01 <- subset(BW_CRRT_dos_01, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_CRRT_01$PTA_Cmin_75 <- 100 * ave(PTA_CRRT_01$DV >= 7.5, PTA_CRRT_01$DAY, PTA_CRRT_01$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_CRRT_01$PTA_Cmin_80 <- 100 * ave(PTA_CRRT_01$DV >= 80, PTA_CRRT_01$DAY, PTA_CRRT_01$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_CRRT_01$PTA_fAUC_200 <- 100 * ave(PTA_CRRT_01$fAUC >= 200, PTA_CRRT_01$DAY, PTA_CRRT_01$BW, FUN = mean)

# Create PTA_CRRT_01_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_CRRT_01_overall <- unique(PTA_CRRT_01[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_CRRT_dos_01 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
#write.csv(PTA_CRRT_01_overall, "PTA_CRRT_dos_01.csv",quote=F,row.names = FALSE)
PTA_CRRT_dos_01<-read.csv("PTA_CRRT_dos_01.csv")

```

```{r for the 800 LD & 400 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_CRRT_02.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_CRRT_dos_02 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_CRRT_dos_02$ID<-as.integer(BW_CRRT_dos_02$ID)

# Create a new variable AUC24 for each ID
BW_CRRT_dos_02 <- BW_CRRT_dos_02 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_CRRT_dos_02<- BW_CRRT_dos_02 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_CRRT_dos_02$fAUC<- BW_CRRT_dos_02$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_CRRT_02 <- subset(BW_CRRT_dos_02, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_CRRT_02$PTA_Cmin_75 <- 100 * ave(PTA_CRRT_02$DV >= 7.5, PTA_CRRT_02$DAY, PTA_CRRT_02$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_CRRT_02$PTA_Cmin_80 <- 100 * ave(PTA_CRRT_02$DV >= 80, PTA_CRRT_02$DAY, PTA_CRRT_02$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_CRRT_02$PTA_fAUC_200 <- 100 * ave(PTA_CRRT_02$fAUC >= 200, PTA_CRRT_02$DAY, PTA_CRRT_02$BW, FUN = mean)

# Create PTA_CRRT_02_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_CRRT_02_overall <- unique(PTA_CRRT_02[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_CRRT_dos_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
#write.csv(PTA_CRRT_02_overall, "PTA_CRRT_dos_02.csv",quote=F,row.names = FALSE)
PTA_CRRT_dos_02<-read.csv("PTA_CRRT_dos_02.csv")

```

```{r for the 1000 LD & 600 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_CRRT_03.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_CRRT_dos_03 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_CRRT_dos_03$ID<-as.integer(BW_CRRT_dos_03$ID)

# Create a new variable AUC24 for each ID
BW_CRRT_dos_03 <- BW_CRRT_dos_03 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_CRRT_dos_03<- BW_CRRT_dos_03 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_CRRT_dos_03$fAUC<- BW_CRRT_dos_03$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_CRRT_03 <- subset(BW_CRRT_dos_03, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_CRRT_03$PTA_Cmin_75 <- 100 * ave(PTA_CRRT_03$DV >= 7.5, PTA_CRRT_03$DAY, PTA_CRRT_03$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_CRRT_03$PTA_Cmin_80 <- 100 * ave(PTA_CRRT_03$DV >= 80, PTA_CRRT_03$DAY, PTA_CRRT_03$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_CRRT_03$PTA_fAUC_200 <- 100 * ave(PTA_CRRT_03$fAUC >= 200, PTA_CRRT_03$DAY, PTA_CRRT_03$BW, FUN = mean)

# Create PTA_CRRT_03_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_CRRT_03_overall <- unique(PTA_CRRT_03[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_CRRT_dos_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
#write.csv(PTA_CRRT_03_overall, "PTA_CRRT_dos_03.csv",quote=F,row.names = FALSE)
PTA_CRRT_dos_03<-read.csv("PTA_CRRT_dos_03.csv")

```

```{r for the 1000 LD & 800 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_CRRT_04.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_CRRT_dos_04 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_CRRT_dos_04$ID<-as.integer(BW_CRRT_dos_04$ID)

# Create a new variable AUC24 for each ID
BW_CRRT_dos_04 <- BW_CRRT_dos_04 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_CRRT_dos_04<- BW_CRRT_dos_04 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_CRRT_dos_04$fAUC<- BW_CRRT_dos_04$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_CRRT_04 <- subset(BW_CRRT_dos_04, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_CRRT_04$PTA_Cmin_75 <- 100 * ave(PTA_CRRT_04$DV >= 7.5, PTA_CRRT_04$DAY, PTA_CRRT_04$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_CRRT_04$PTA_Cmin_80 <- 100 * ave(PTA_CRRT_04$DV >= 80, PTA_CRRT_04$DAY, PTA_CRRT_04$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_CRRT_04$PTA_fAUC_200 <- 100 * ave(PTA_CRRT_04$fAUC >= 200, PTA_CRRT_04$DAY, PTA_CRRT_04$BW, FUN = mean)

# Create PTA_CRRT_04_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_CRRT_04_overall <- unique(PTA_CRRT_04[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_CRRT_dos_04 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_CRRT_04_overall, "PTA_CRRT_dos_04.csv",quote=F,row.names = FALSE)

```

```{r for the 1400 LD & 800 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_CRRT_05.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_CRRT_dos_05 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_CRRT_dos_05$ID<-as.integer(BW_CRRT_dos_05$ID)

# Create a new variable AUC24 for each ID
BW_CRRT_dos_05 <- BW_CRRT_dos_05 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_CRRT_dos_05<- BW_CRRT_dos_05 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_CRRT_dos_05$fAUC<- BW_CRRT_dos_05$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_CRRT_05 <- subset(BW_CRRT_dos_05, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_CRRT_05$PTA_Cmin_75 <- 100 * ave(PTA_CRRT_05$DV >= 7.5, PTA_CRRT_05$DAY, PTA_CRRT_05$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_CRRT_05$PTA_Cmin_80 <- 100 * ave(PTA_CRRT_05$DV >= 80, PTA_CRRT_05$DAY, PTA_CRRT_05$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_CRRT_05$PTA_fAUC_200 <- 100 * ave(PTA_CRRT_05$fAUC >= 200, PTA_CRRT_05$DAY, PTA_CRRT_05$BW, FUN = mean)

# Create PTA_CRRT_05_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_CRRT_05_overall <- unique(PTA_CRRT_05[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_CRRT_dos_05 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_CRRT_05_overall, "PTA_CRRT_dos_05.csv",quote=F,row.names = FALSE)

```

```{r for the 1600 LD & 800 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_CRRT_06.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_CRRT_dos_06 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_CRRT_dos_06$ID<-as.integer(BW_CRRT_dos_06$ID)

# Create a new variable AUC24 for each ID
BW_CRRT_dos_06 <- BW_CRRT_dos_06 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_CRRT_dos_06<- BW_CRRT_dos_06 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_CRRT_dos_06$fAUC<- BW_CRRT_dos_06$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_CRRT_06 <- subset(BW_CRRT_dos_06, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_CRRT_06$PTA_Cmin_75 <- 100 * ave(PTA_CRRT_06$DV >= 7.5, PTA_CRRT_06$DAY, PTA_CRRT_06$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_CRRT_06$PTA_Cmin_80 <- 100 * ave(PTA_CRRT_06$DV >= 80, PTA_CRRT_06$DAY, PTA_CRRT_06$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_CRRT_06$PTA_fAUC_200 <- 100 * ave(PTA_CRRT_06$fAUC >= 200, PTA_CRRT_06$DAY, PTA_CRRT_06$BW, FUN = mean)

# Create PTA_CRRT_06_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_CRRT_06_overall <- unique(PTA_CRRT_06[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_CRRT_dos_06 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_CRRT_06_overall, "PTA_CRRT_dos_06.csv",quote=F,row.names = FALSE)

```

```{r for the 1800 LD & 800 MD, warning=FALSE}

# Use read_nonmem_table function to import data
working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim'
simulations_tablefile <- paste0(working.directory, '/sim_BW_CRRT_07.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
BW_CRRT_dos_07 <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
BW_CRRT_dos_07$ID<-as.integer(BW_CRRT_dos_07$ID)

# Create a new variable AUC24 for each ID
BW_CRRT_dos_07 <- BW_CRRT_dos_07 %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

BW_CRRT_dos_07<- BW_CRRT_dos_07 %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
BW_CRRT_dos_07$fAUC<- BW_CRRT_dos_07$AUC24*0.89

# Extract ID, DV, fAUC, DAY, and BW columns
PTA_CRRT_07 <- subset(BW_CRRT_dos_07, select = c("ID", "DV", "fAUC", "DAY", "BW"))

# Calculate percentage of DV >= 7.5 per DAY per BW (PTA_Cmin_75)
PTA_CRRT_07$PTA_Cmin_75 <- 100 * ave(PTA_CRRT_07$DV >= 7.5, PTA_CRRT_07$DAY, PTA_CRRT_07$BW, FUN = mean)

# Calculate percentage of DV >= 80 per DAY per BW (PTA_Cmin_80)
PTA_CRRT_07$PTA_Cmin_80 <- 100 * ave(PTA_CRRT_07$DV >= 80, PTA_CRRT_07$DAY, PTA_CRRT_07$BW, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY per BW (PTA_fAUC_200)
PTA_CRRT_07$PTA_fAUC_200 <- 100 * ave(PTA_CRRT_07$fAUC >= 200, PTA_CRRT_07$DAY, PTA_CRRT_07$BW, FUN = mean)

# Create PTA_CRRT_07_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY, and BW
PTA_CRRT_07_overall <- unique(PTA_CRRT_07[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY", "BW")])

# Export PTA_CRRT_dos_07 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
write.csv(PTA_CRRT_07_overall, "PTA_CRRT_dos_07.csv",quote=F,row.names = FALSE)

```

#### Plotting PTA datasets

##### CKDEPI - non CRRT

```{r PTA_02_overall to PTA_04_overall datasets}

# PTA_02_overall to PTA_04_overall datasets corresspond to 800 to 1200 LD & 400 MD

## Day 1
 
# Import PTA_dos_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
PTA_dos_02<-read.csv("PTA_dos_02.csv")
# Add regimen
PTA_dos_02$Regimen<-1

# Import PTA_dos_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
PTA_dos_03<-read.csv("PTA_dos_03.csv")
# Add regimen
PTA_dos_03$Regimen<-2

# Import PTA_dos_04 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim")
PTA_dos_04<-read.csv("PTA_dos_04.csv")
# Add regimen
PTA_dos_04$Regimen<-3

# Combine 3 PTA datasets into 1 - PTA_CKDEPI
PTA_CKDEPI<-rbind(PTA_dos_02,PTA_dos_03,PTA_dos_04)

# Plotting day 1 to day 14
PTA_NOCRRT200_DAY1<-  ggplot(PTA_CKDEPI[PTA_CKDEPI$DAY == 1,],aes(x = CKDEPI, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(5, 215), breaks = seq(5, 215, by = 10), expand = c(0,0)) +
  xlab(TeX(r"($\eGFR_{CKD-EPI}\ (ml/min/1.73m^2)$)")) + #update xlabel 071223
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = c("#fde725", "#21918c", "#440154"),name = "Dosing regimen",
                     labels = c("800 mg q24h LD / 400 mg q24h MD", "1000 mg q24h LD / 400 mg q24h MD",
                                "1200 mg q24h LD / 400 mg q24h MD")) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_NOCRRT200_DAY1

## Day 2
PTA_NOCRRT200_DAY2<-  ggplot(PTA_CKDEPI[PTA_CKDEPI$DAY == 2,],aes(x = CKDEPI, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(5, 215), breaks = seq(5, 215, by = 10), expand = c(0,0)) +
  xlab(TeX(r"($\eGFR_{CKD-EPI}\ (ml/min/1.73m^2)$)")) + #update xlabel 071223
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = c("#fde725", "#21918c", "#440154"),name = "Dosing regimen",
                     labels = c("800 mg q24h LD / 400 mg q24h MD", "1000 mg q24h LD / 400 mg q24h MD",
                                "1200 mg q24h LD / 400 mg q24h MD")) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_NOCRRT200_DAY2

## Day 7
PTA_NOCRRT200_DAY7<-  ggplot(PTA_CKDEPI[PTA_CKDEPI$DAY == 7,],aes(x = CKDEPI, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(5, 215), breaks = seq(5, 215, by = 10), expand = c(0,0)) +
  xlab(TeX(r"($\eGFR_{CKD-EPI}\ (ml/min/1.73m^2)$)")) + #update xlabel 071223
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = c("#fde725", "#21918c", "#440154"),name = "Dosing regimen",
                     labels = c("800 mg q24h LD / 400 mg q24h MD", "1000 mg q24h LD / 400 mg q24h MD",
                                "1200 mg q24h LD / 400 mg q24h MD")) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_NOCRRT200_DAY7

## Day 14
PTA_NOCRRT200_DAY14<-  ggplot(PTA_CKDEPI[PTA_CKDEPI$DAY == 14,],aes(x = CKDEPI, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(5, 215), breaks = seq(5, 215, by = 10), expand = c(0,0)) +
  xlab(TeX(r"($\eGFR_{CKD-EPI}\ (ml/min/1.73m^2)$)")) + #update xlabel 071223
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = c("#fde725", "#21918c", "#440154"),name = "Dosing regimen",
                     labels = c("800 mg q24h LD / 400 mg q24h MD", "1000 mg q24h LD / 400 mg q24h MD",
                                "1200 mg q24h LD / 400 mg q24h MD")) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_NOCRRT200_DAY14


## Combining these 4 plots into 1

grid_CKDEPI <- plot_grid(PTA_NOCRRT200_DAY1, PTA_NOCRRT200_DAY2, PTA_NOCRRT200_DAY7, PTA_NOCRRT200_DAY14, nrow = 2, align = "v")

title <- ggdraw() + 
  #draw_label("Probability of fAUC 200 mgxh/L target attainment", fontface = "bold", size = 12)
  draw_label("Non-CRRT", fontface = "bold", size = 12)

# Arrange the title and grid using plot_grid()
grid_CKDEPI <- plot_grid(title, grid_CKDEPI, ncol = 1, rel_heights = c(0.02, 1))

# Export the combined plots
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim/PTA plots")
#setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Workshops and Conferences/ECCMID 2024")
ggsave("grid_CKDEPI.png", grid_CKDEPI, dpi = 300, width = 16, height = 8.27)

```

```{r creating 1 common legend only,warning=FALSE}

# Inspired by the plot in Clindamycin project

# Define common legend for both plots
common_legend <- get_legend(PTA_NOCRRT200_DAY1)

# Remove legends from individual plots
PTA_NOCRRT200_DAY1 <- PTA_NOCRRT200_DAY1 + theme(legend.position = "none")
PTA_NOCRRT200_DAY2 <- PTA_NOCRRT200_DAY2 + theme(legend.position = "none")
PTA_NOCRRT200_DAY7 <- PTA_NOCRRT200_DAY7 + theme(legend.position = "none")
PTA_NOCRRT200_DAY14<-PTA_NOCRRT200_DAY14 + theme(legend.position = "none")

# Combine these 4 plots into 1

grid_CKDEPI <- plot_grid(PTA_NOCRRT200_DAY1, PTA_NOCRRT200_DAY2, PTA_NOCRRT200_DAY7, PTA_NOCRRT200_DAY14, nrow = 2, align = "v")

# Creating title

title <- ggdraw() + 
  #draw_label("Probability of fAUC 200 mgxh/L target attainment", fontface = "bold", size = 12)
  draw_label("Non-CRRT", fontface = "bold", size = 12)

# Arrange the title and grid using plot_grid()
grid_CKDEPI <- plot_grid(title, grid_CKDEPI, ncol = 1, rel_heights = c(0.02, 1),align = "v")

# Finally, arrange legend and grid using plot_grid()
grid_CKDEPI_common <- plot_grid(grid_CKDEPI,common_legend, nrow = 1, rel_widths = c(1, 0.2))

# Export the common legend - combined plots
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/CKDEPI_Sim/PTA plots")
#setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Workshops and Conferences/ECCMID 2024")
ggsave("grid_CKDEPI_commonlegend.png", grid_CKDEPI_common, dpi = 300, width = 16, height = 8.27)

```

##### BW - CRRT

```{r PTA_CRRT_dos_01 to PTA_CRRT_dos_07 datasets, warning=FALSE}

## Day 1

# Import PTA_CRRT_dos_01 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_CRRT_dos_01<-read.csv("PTA_CRRT_dos_01.csv")
# Add regimen
PTA_CRRT_dos_01$Regimen<-4

# Import PTA_CRRT_dos_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_CRRT_dos_02<-read.csv("PTA_CRRT_dos_02.csv")
# Add regimen
PTA_CRRT_dos_02$Regimen<-1

# Import PTA_CRRT_dos_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_CRRT_dos_03<-read.csv("PTA_CRRT_dos_03.csv")
# Add regimen
PTA_CRRT_dos_03$Regimen<-2

# Import PTA_CRRT_dos_04 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_CRRT_dos_04<-read.csv("PTA_CRRT_dos_04.csv")
# Add regimen
PTA_CRRT_dos_04$Regimen<-3

# Import PTA_CRRT_dos_05 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_CRRT_dos_05<-read.csv("PTA_CRRT_dos_05.csv")
# Add regimen
PTA_CRRT_dos_05$Regimen<-5

# Import PTA_CRRT_dos_06 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_CRRT_dos_06<-read.csv("PTA_CRRT_dos_06.csv")
# Add regimen
PTA_CRRT_dos_06$Regimen<-6

# Import PTA_CRRT_dos_07 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_CRRT_dos_07<-read.csv("PTA_CRRT_dos_07.csv")
# Add regimen
PTA_CRRT_dos_07$Regimen<-7

# Combine 7 PTA datasets into 1 - PTA_BW_CRRT
PTA_BW_CRRT<-rbind(PTA_CRRT_dos_01,PTA_CRRT_dos_02,PTA_CRRT_dos_03,PTA_CRRT_dos_04,PTA_CRRT_dos_05,PTA_CRRT_dos_06,PTA_CRRT_dos_07)

# Define the labels and colors
dosing_labels_day1 <- c("800 mg q24h LD",
                   "1000 mg q24h LD",
                   "1200 mg q24h LD",
                   "1400 mg q24h LD",
                   "1600 mg q24h LD",
                   "1800 mg q24h LD")

dosing_labels_day14 <- c("400 mg q24h MD",
                   "600 mg q24h MD",
                   "800 mg q24h MD")

dosing_labels_day27 <- c("1000 mg q24h LD / 800 mg q24h MD",
                   "1200 mg q24h LD / 800 mg q24h MD",
                   "1400 mg q24h LD / 800 mg q24h MD",
                   "1600 mg q24h LD / 800 mg q24h MD",
                   "1800 mg q24h LD / 800 mg q24h MD")

dosing_colors_day1 <- c("#fde725",
                   "#35b779",
                   "#21918c",
                   "#31688e",
                   "#443983",
                   "#440154")

dosing_colors_day14 <- c("#fde725",
                         "#90d743",
                   "#35b779")

dosing_colors_day27 <- c("#35b779",
                   "#21918c",
                   "#31688e",
                   "#443983",
                   "#440154")

# Plotting day 1 to day 14
# Here we use Colorblind-Friendly Palette - scale_colour_viridis_d()
PTA_BW_CRRT200_DAY1<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 1 & PTA_BW_CRRT$Regimen != 2,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_colour_viridis_d(name = "Dosing regimen",
                     labels = dosing_labels_day1) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_vline(xintercept = c(60, 80, 100, 120, 140), linetype = "dashed", color = "gray50", size = 1)
PTA_BW_CRRT200_DAY1
# Note: scale_colour_viridis_d works best with the default setting

# A very similar way of generating viridis color palette like above using hex codes, which allows for flexibility
PTA_BW_CRRT200_DAY1<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 1 & PTA_BW_CRRT$Regimen != 2,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day1, name = "Dosing regimen",
                     labels = dosing_labels_day1) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_vline(xintercept = c(60, 80, 100, 120, 140), linetype = "dashed", color = "gray50", size = 1)
PTA_BW_CRRT200_DAY1
# Will do similarly for the following days

## Day 14
PTA_BW_CRRT200_DAY14<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 14 & PTA_BW_CRRT$Regimen<4, ],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day14, name = "Dosing regimen",
                     labels = dosing_labels_day14) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_CRRT200_DAY14

## Day 2
PTA_BW_CRRT200_DAY2<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 2 & PTA_BW_CRRT$Regimen > 2,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
 scale_color_manual(values = dosing_colors_day27, name = "Dosing regimen",
                     labels = dosing_labels_day27) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_vline(xintercept = c(60, 80, 100, 120, 140), linetype = "dashed", color = "gray50", size = 1)
PTA_BW_CRRT200_DAY2

## Day 7
PTA_BW_CRRT200_DAY7<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 7 & PTA_BW_CRRT$Regimen > 2 ,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day27, name = "Dosing regimen",
                     labels = dosing_labels_day27) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_CRRT200_DAY7

## Combining these 4 plots into 1

grid_BW_CRRT <- plot_grid(PTA_BW_CRRT200_DAY1, PTA_BW_CRRT200_DAY14, PTA_BW_CRRT200_DAY2, PTA_BW_CRRT200_DAY7, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of fAUC 200 mgxh/L target attainment", fontface = "bold", size = 12)

# Arrange the title and grid using plot_grid()
grid_BW_CRRT <- plot_grid(title, grid_BW_CRRT, ncol = 1, rel_heights = c(0.02, 1))

# Export the combined plots
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim/PTA plots")
ggsave("grid_BW_CRRT.png", grid_BW_CRRT, dpi = 300, width = 16, height = 8.27)

```

```{r grid plot for fAUC of 400 mg/h.L}

## Day 1

# Create PTA_BW_CRRT dataset from above

# Define the labels and colors

dosing_labels_day12 <- c("800 mg q24h LD / 400 mg q24h MD",
                    "1000 mg q24h LD / 800 mg q24h MD",
                   "1200 mg q24h LD / 800 mg q24h MD",
                   "1400 mg q24h LD / 800 mg q24h MD",
                   "1600 mg q24h LD / 800 mg q24h MD",
                   "1800 mg q24h LD / 800 mg q24h MD")

dosing_labels_day714 <- c("400 mg q24h MD",
                   "600 mg q24h MD",
                   "800 mg q24h MD")

dosing_colors_day12 <- c("#fde725",
                   "#90d743",
                   "#35b779",
                   "#21918c",
                   "#31688e",
                   "#443983")

dosing_colors_day714 <- c("#fde725",
                         "#440154",
                   "#90d743")

## Plotting day 1 and 2
# Here we use Colorblind-Friendly Palette - scale_colour_viridis_d()
# I also enforce limits on vertical lines here

# Firstly, create dataset with BW, Regimen and PTA on day 1 
BW_Reg <- data.frame( #BW and Regimen dataset
  BW = c(60, 80, 100, 120, 140),
  Regimen = c(3, 4, 5, 6,7)
)

# Then, make a dataset of PTA on Day 1 per BW per Regimen
BW_PTA_DaY1<-BW_Reg %>%
  left_join(
    PTA_BW_CRRT %>% filter(DAY == 1),
    by = c("BW", "Regimen")
  )

# Similarly for day 2
BW_PTA_DaY2<-BW_Reg %>%
  left_join(
    PTA_BW_CRRT %>% filter(DAY == 2),
    by = c("BW", "Regimen")
  )

# Then making PTA_BW_noCRRT400_DAY1 plot, which I use geom_segment to enforce restriction on vertical lines, using newly created BW_PTA_DaY1 dataset
PTA_BW_CRRT400_DAY1<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 1 & PTA_BW_CRRT$Regimen != 2,],aes(x = BW, y = PTA_fAUC_400,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5),expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 400 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day12, name = "Dosing regimen",
                     labels = dosing_labels_day12) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY1,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_400  # Ending at the corresponding PTA_fAUC_400 value
    ),
    linetype = "dashed",
    color = "gray50",
    size = 1
  )
PTA_BW_CRRT400_DAY1

## Day 2
PTA_BW_CRRT400_DAY2<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 2 & PTA_BW_CRRT$Regimen != 2,],aes(x = BW, y = PTA_fAUC_400,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5),expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 400 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day12, name = "Dosing regimen",
                     labels = dosing_labels_day12) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY2,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_400  # Ending at the corresponding PTA_fAUC_400 value
    ),
    linetype = "dashed",
    color = "gray50",
    size = 1
  )
PTA_BW_CRRT400_DAY2

## Day 7
PTA_BW_CRRT400_DAY7<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 7 & PTA_BW_CRRT$Regimen<4, ],aes(x = BW, y = PTA_fAUC_400,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 400 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day714, name = "Dosing regimen",
                     labels = dosing_labels_day714) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_CRRT400_DAY7

## Day 14
PTA_BW_CRRT400_DAY14<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 14 & PTA_BW_CRRT$Regimen<4, ],aes(x = BW, y = PTA_fAUC_400,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 400 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day714, name = "Dosing regimen",
                     labels = dosing_labels_day714) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_CRRT400_DAY14

## Combining these DAY 1 & 2 into 1

# Define common legend for both plots
common_legend_CRRT400_DAY12 <- get_legend(PTA_BW_CRRT400_DAY1)

# Remove legends from individual plots
PTA_BW_CRRT400_DAY1 <- PTA_BW_CRRT400_DAY1 + theme(legend.position = "none")
PTA_BW_CRRT400_DAY2 <- PTA_BW_CRRT400_DAY2 + theme(legend.position = "none")

# Combine these 2 plots into 1

PTA_BW_CRRT400_DAY12 <- plot_grid(PTA_BW_CRRT400_DAY1, PTA_BW_CRRT400_DAY2,common_legend_CRRT400_DAY12,rel_widths = c(1,1,0.35),nrow = 1, align = "h")

# Then combining day 7 & 14

# Define common legend for both plots
common_legend_CRRT400_DAY714 <- get_legend(PTA_BW_CRRT400_DAY7)

# Remove legends from individual plots
PTA_BW_CRRT400_DAY7 <- PTA_BW_CRRT400_DAY7 + theme(legend.position = "none")
PTA_BW_CRRT400_DAY14 <- PTA_BW_CRRT400_DAY14 + theme(legend.position = "none")

# Combine these 2 plots into 1

PTA_BW_CRRT400_DAY714 <- plot_grid(PTA_BW_CRRT400_DAY7, PTA_BW_CRRT400_DAY14,common_legend_CRRT400_DAY714,rel_widths = c(1,1,0.35),nrow = 1, align = "h")

## Then combining these 4 plots
grid_BW_CRRT_400 <- plot_grid(PTA_BW_CRRT400_DAY12, PTA_BW_CRRT400_DAY714, nrow = 2, align = "v")

title_CRRT_400 <- ggdraw() + 
  #draw_label("Probability of fAUC 400 mgxh/L target attainment", fontface = "bold", size = 12)
draw_label("CRRT", fontface = "bold", size = 12,hjust=2.7)

# Arrange the title and grid using plot_grid()
grid_BW_CRRT_400 <- plot_grid(title_CRRT_400, grid_BW_CRRT_400, ncol = 1, rel_heights = c(0.02, 1))
grid_BW_CRRT_400

# Export grid_BW_noCRRT_rearranged plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim/PTA plots")
ggsave("grid_BW_CRRT_400.png", grid_BW_CRRT_400, dpi = 300, width = 16, height = 8.27)

```


##### BW - no CRRT

```{r PTA_noCRRT_dos_02 to PTA_noCRRT_dos_06 datasets, warning=FALSE}

## Day 1

# Import PTA_noCRRT_dos_02 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_noCRRT_dos_02<-read.csv("PTA_noCRRT_dos_02.csv")
# Add regimen
PTA_noCRRT_dos_02$Regimen<-4

# Import PTA_noCRRT_dos_03 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_noCRRT_dos_03<-read.csv("PTA_noCRRT_dos_03.csv")
# Add regimen
PTA_noCRRT_dos_03$Regimen<-3

# Import PTA_noCRRT_dos_04 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_noCRRT_dos_04<-read.csv("PTA_noCRRT_dos_04.csv")
# Add regimen
PTA_noCRRT_dos_04$Regimen<-2

# Import PTA_noCRRT_dos_05 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_noCRRT_dos_05<-read.csv("PTA_noCRRT_dos_05.csv")
# Add regimen
PTA_noCRRT_dos_05$Regimen<-5

# Import PTA_noCRRT_dos_06 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_noCRRT_dos_06<-read.csv("PTA_noCRRT_dos_06.csv")
# Add regimen
PTA_noCRRT_dos_06$Regimen<-6

# Import PTA_noCRRT_dos_07 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_noCRRT_dos_07<-read.csv("PTA_noCRRT_dos_07.csv")
# Add regimen
PTA_noCRRT_dos_07$Regimen<-7 #1800 LD 400 MD

# Import PTA_noCRRT_dos_08 dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim")
PTA_noCRRT_dos_08<-read.csv("PTA_noCRRT_dos_08.csv")
# Add regimen
PTA_noCRRT_dos_08$Regimen<-1 # 800 LD 200 MD

# Combine 7 PTA datasets into 1 - PTA_BW_noCRRT
PTA_BW_noCRRT<-rbind(PTA_noCRRT_dos_02,PTA_noCRRT_dos_03,PTA_noCRRT_dos_04,PTA_noCRRT_dos_05,PTA_noCRRT_dos_06,PTA_noCRRT_dos_07,PTA_noCRRT_dos_08)

# Define the labels and colors
dosing_labels_day1 <- c("800 mg q24h LD",
                   "1000 mg q24h LD",
                   "1200 mg q24h LD",
                   "1400 mg q24h LD",
                   "1600 mg q24h LD",
                   "1800 mg q24h LD")

dosing_labels_day14 <- c("200 mg q24h MD","400 mg q24h MD")

dosing_labels_day27 <- c("800 mg q24h LD / 400 mg q24h MD",
                         "1000 mg q24h LD / 400 mg q24h MD",
                   "1200 mg q24h LD / 400 mg q24h MD",
                   "1400 mg q24h LD / 400 mg q24h MD",
                   "1600 mg q24h LD / 400 mg q24h MD",
                   "1800 mg q24h LD / 400 mg q24h MD")

dosing_colors_day127 <- c("#fde725",
                        "#90d743",
                   "#35b779",
                   "#21918c",
                   "#31688e",
                   "#440154")

dosing_colors_day14 <- c("#443983","#fde725")

# Plotting day 1 to day 14
# Here we use Colorblind-Friendly Palette - scale_colour_viridis_d()
PTA_BW_noCRRT200_DAY1<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 1 & PTA_BW_noCRRT$Regimen>1,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day127, name = "Dosing regimen",
                     labels = dosing_labels_day1) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_vline(xintercept = c(60, 80, 100, 120, 140), linetype = "dashed", color = "gray50", size = 1)
PTA_BW_noCRRT200_DAY1

## Day 14
PTA_BW_noCRRT200_DAY14<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 14 & PTA_BW_noCRRT$Regimen<3, ],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day14, name = "Dosing regimen",
                     labels = dosing_labels_day14) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_noCRRT200_DAY14

## Day 2
PTA_BW_noCRRT200_DAY2<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 2 & PTA_BW_noCRRT$Regimen>1,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
 scale_color_manual(values = dosing_colors_day127, name = "Dosing regimen",
                     labels = dosing_labels_day27) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_vline(xintercept = c(60, 80, 100, 120, 140), linetype = "dashed", color = "gray50", size = 1)
PTA_BW_noCRRT200_DAY2

## Day 7
PTA_BW_noCRRT200_DAY7<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 7 & PTA_BW_noCRRT$Regimen>1,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day127, name = "Dosing regimen",
                     labels = dosing_labels_day27) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_noCRRT200_DAY7

## Combining these 4 plots into 1

grid_BW_noCRRT <- plot_grid(PTA_BW_noCRRT200_DAY1, PTA_BW_noCRRT200_DAY14, PTA_BW_noCRRT200_DAY2, PTA_BW_noCRRT200_DAY7, nrow = 2, align = "v")

title <- ggdraw() + 
  draw_label("Probability of fAUC 200 mgxh/L target attainment", fontface = "bold", size = 12)

# Arrange the title and grid using plot_grid()
grid_BW_noCRRT <- plot_grid(title, grid_BW_noCRRT, ncol = 1, rel_heights = c(0.02, 1))

# Export the combined plots
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim/PTA plots")
ggsave("grid_BW_noCRRT.png", grid_BW_noCRRT, dpi = 300, width = 16, height = 8.27)

```

```{r grid plot for fAUC of 400 mg/h.L}

# Adapting the code of rearrange BW_CRRT 200 below - 201123
# PTA_BW_noCRRT created above
## Day 1

# Create PTA_BW_noCRRT dataset from above

# Define the labels and colors

dosing_labels_day12 <- c("800 mg q24h LD / 400 mg q24h MD",
                         "1000 mg q24h LD / 400 mg q24h MD",
                   "1200 mg q24h LD / 400 mg q24h MD",
                   "1400 mg q24h LD / 400 mg q24h MD",
                   "1600 mg q24h LD / 400 mg q24h MD",
                   "1800 mg q24h LD / 400 mg q24h MD")

dosing_labels_day714 <- c("200 mg q24h MD","400 mg q24h MD")

dosing_colors_day12 <- c("#fde725",
                        "#90d743",
                   "#35b779",
                   "#21918c",
                   "#31688e",
                   "#440154")

dosing_colors_day714 <- c("#443983","#fde725")


## Plotting day 1 and 2
# Here we use Colorblind-Friendly Palette - scale_colour_viridis_d()
# I also enforce limits on vertical lines here

# Firstly, create dataset with BW, Regimen and PTA on day 1 
BW_Reg <- data.frame( #BW and Regimen dataset
  BW = c(60, 80, 100, 120, 140),
  Regimen = c(2, 3, 4, 5, 6)
)

# Then, make a dataset of PTA on Day 1 per BW per Regimen
BW_PTA_DaY1<-BW_Reg %>%
  left_join(
    PTA_BW_noCRRT %>% filter(DAY == 1),
    by = c("BW", "Regimen")
  )

# Similarly for day 2
BW_PTA_DaY2<-BW_Reg %>%
  left_join(
    PTA_BW_noCRRT %>% filter(DAY == 2),
    by = c("BW", "Regimen")
  )

# Then making PTA_BW_noCRRT400_DAY1 plot, which I use geom_segment to enforce restriction on vertical lines, using newly created BW_PTA_DaY1 dataset
PTA_BW_noCRRT400_DAY1<- ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 1 & PTA_BW_noCRRT$Regimen>1,],aes(x = BW, y = PTA_fAUC_400,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5),expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 400 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day12, name = "Dosing regimen",
                     labels = dosing_labels_day12) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY1,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_400  # Ending at the corresponding PTA_fAUC_400 value
    ),
    linetype = "dashed",
    color = "gray50",
    size = 1
  )
PTA_BW_noCRRT400_DAY1

## Day 2
PTA_BW_noCRRT400_DAY2<- ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 2 & PTA_BW_noCRRT$Regimen>1,],aes(x = BW, y = PTA_fAUC_400,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 400 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
 scale_color_manual(values = dosing_colors_day12, name = "Dosing regimen",
                     labels = dosing_labels_day12) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY2,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_400  # Ending at the corresponding PTA_fAUC_400 value
    ),
    linetype = "dashed",
    color = "gray50",
    size = 1
  )
PTA_BW_noCRRT400_DAY2

## Day 7
PTA_BW_noCRRT400_DAY7<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 7 & PTA_BW_noCRRT$Regimen<3,],aes(x = BW, y = PTA_fAUC_400,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 400 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day714, name = "Dosing regimen",
                     labels = dosing_labels_day714) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_noCRRT400_DAY7

## Day 14
PTA_BW_noCRRT400_DAY14<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 14 & PTA_BW_noCRRT$Regimen<3, ],aes(x = BW, y = PTA_fAUC_400,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 400 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day714, name = "Dosing regimen",
                     labels = dosing_labels_day714) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_noCRRT400_DAY14

## Combining these DAY 1 & 2 into 1

# Define common legend for both plots
common_legend_noCRRT400_DAY12 <- get_legend(PTA_BW_noCRRT400_DAY1)

# Remove legends from individual plots
PTA_BW_noCRRT400_DAY1 <- PTA_BW_noCRRT400_DAY1 + theme(legend.position = "none")
PTA_BW_noCRRT400_DAY2 <- PTA_BW_noCRRT400_DAY2 + theme(legend.position = "none")

# Combine these 2 plots into 1

grid_BW_noCRRT400_DAY12 <- plot_grid(PTA_BW_noCRRT400_DAY1, PTA_BW_noCRRT400_DAY2,common_legend_noCRRT400_DAY12,rel_widths = c(1,1,0.35),nrow = 1, align = "h")
grid_BW_noCRRT400_DAY12

# Then combining day 7 & 14

# Define common legend for both plots
common_legend_noCRRT400_DAY714 <- get_legend(PTA_BW_noCRRT400_DAY7)

# Remove legends from individual plots
PTA_BW_noCRRT400_DAY7 <- PTA_BW_noCRRT400_DAY7 + theme(legend.position = "none")
PTA_BW_noCRRT400_DAY14 <- PTA_BW_noCRRT400_DAY14 + theme(legend.position = "none")

# Combine these 2 plots into 1

grid_BW_noCRRT400_DAY714 <- plot_grid(PTA_BW_noCRRT400_DAY7, PTA_BW_noCRRT400_DAY14,common_legend_noCRRT400_DAY714,rel_widths = c(1,1,0.35),nrow = 1, align = "h")
grid_BW_noCRRT400_DAY714

## Then combining these 4 plots
grid_BW_noCRRT_400 <- plot_grid(grid_BW_noCRRT400_DAY12, grid_BW_noCRRT400_DAY714, nrow = 2, align = "v")

title_noCRRT_400 <- ggdraw() + 
  #draw_label("Probability of fAUC 400 mgxh/L target attainment", fontface = "bold", size = 12)
draw_label("Non-CRRT", fontface = "bold", size = 12,hjust=1.7)

# Arrange the title and grid using plot_grid()
grid_BW_noCRRT_400 <- plot_grid(title_noCRRT_400, grid_BW_noCRRT_400, ncol = 1, rel_heights = c(0.02, 1))
grid_BW_noCRRT_400

# Export grid_BW_noCRRT_rearranged plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim/PTA plots")
ggsave("grid_BW_noCRRT_400.png", grid_BW_noCRRT_400, dpi = 300, width = 16, height = 8.27)

```

##### BW - CRRT & no CRRT on the same plot

```{r rearrange non CRRT plot grid, warning=FALSE}

## Day 1

# Create PTA_BW_noCRRT dataset from above

# Define the labels and colors

dosing_labels_day12 <- c("800 mg q24h LD / 400 mg q24h MD",
                         "1000 mg q24h LD / 400 mg q24h MD",
                   "1200 mg q24h LD / 400 mg q24h MD",
                   "1400 mg q24h LD / 400 mg q24h MD",
                   "1600 mg q24h LD / 400 mg q24h MD",
                   "1800 mg q24h LD / 400 mg q24h MD")

dosing_labels_day714 <- c("200 mg q24h MD","400 mg q24h MD")

dosing_colors_day12 <- c("#fde725",
                        "#90d743",
                   "#35b779",
                   "#21918c",
                   "#31688e",
                   "#440154")

dosing_colors_day714 <- c("#443983","#fde725")


## Plotting day 1 and 2
# Here we use Colorblind-Friendly Palette - scale_colour_viridis_d()
# I also enforce limits on vertical lines here

# Firstly, create dataset with BW, Regimen and PTA on day 1 
BW_Reg <- data.frame( #BW and Regimen dataset
  BW = c(60, 80, 100, 120, 140),
  Regimen = c(2, 3, 4, 5, 6)
)

# Then, make a dataset of PTA on Day 1 per BW per Regimen
BW_PTA_DaY1<-BW_Reg %>%
  left_join(
    PTA_BW_noCRRT %>% filter(DAY == 1),
    by = c("BW", "Regimen")
  )

# Similarly for day 2
BW_PTA_DaY2<-BW_Reg %>%
  left_join(
    PTA_BW_noCRRT %>% filter(DAY == 2),
    by = c("BW", "Regimen")
  )

# Then making PTA_BW_noCRRT200_DAY1 plot, which I use geom_segment to enforce restriction on vertical lines, using newly created BW_PTA_DaY1 dataset
PTA_BW_noCRRT200_DAY1<- ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 1 & PTA_BW_noCRRT$Regimen>1,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day12, name = "Dosing regimen",
                     labels = dosing_labels_day12) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY1,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_200  # Ending at the corresponding PTA_fAUC_200 value
    ),
    linetype = "dashed",
    color = "gray50",
    size = 1
  )
PTA_BW_noCRRT200_DAY1

## Day 2
PTA_BW_noCRRT200_DAY2<- ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 2 & PTA_BW_noCRRT$Regimen>1,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
 scale_color_manual(values = dosing_colors_day12, name = "Dosing regimen",
                     labels = dosing_labels_day12) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY2,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_200  # Ending at the corresponding PTA_fAUC_200 value
    ),
    linetype = "dashed",
    color = "gray50",
    size = 1
  )
PTA_BW_noCRRT200_DAY2

## Day 7
PTA_BW_noCRRT200_DAY7<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 7 & PTA_BW_noCRRT$Regimen<3,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day714, name = "Dosing regimen",
                     labels = dosing_labels_day714) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_noCRRT200_DAY7

## Day 14
PTA_BW_noCRRT200_DAY14<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 14 & PTA_BW_noCRRT$Regimen<3, ],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day714, name = "Dosing regimen",
                     labels = dosing_labels_day714) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_noCRRT200_DAY14

## Combining these DAY 1 & 2 into 1

# Define common legend for both plots
common_legend <- get_legend(PTA_BW_noCRRT200_DAY1)

# Remove legends from individual plots
PTA_BW_noCRRT200_DAY1 <- PTA_BW_noCRRT200_DAY1 + theme(legend.position = "none")
PTA_BW_noCRRT200_DAY2 <- PTA_BW_noCRRT200_DAY2 + theme(legend.position = "none")

# Combine these 2 plots into 1

grid_BW_noCRRT_DAY12 <- plot_grid(PTA_BW_noCRRT200_DAY1, PTA_BW_noCRRT200_DAY2,common_legend,rel_widths = c(1,1,0.35),nrow = 1, align = "h")
grid_BW_noCRRT_DAY12

# Then combining day 7 & 14

# Define common legend for both plots
common_legend <- get_legend(PTA_BW_noCRRT200_DAY7)

# Remove legends from individual plots
PTA_BW_noCRRT200_DAY7 <- PTA_BW_noCRRT200_DAY7 + theme(legend.position = "none")
PTA_BW_noCRRT200_DAY14 <- PTA_BW_noCRRT200_DAY14 + theme(legend.position = "none")

# Combine these 2 plots into 1

grid_BW_noCRRT_DAY714 <- plot_grid(PTA_BW_noCRRT200_DAY7, PTA_BW_noCRRT200_DAY14,common_legend,rel_widths = c(1,1,0.35),nrow = 1, align = "h")
grid_BW_noCRRT_DAY714

## Then combining these 4 plots
grid_BW_noCRRT <- plot_grid(grid_BW_noCRRT_DAY12, grid_BW_noCRRT_DAY714, nrow = 2, align = "v")

title <- ggdraw() + 
  #draw_label("Probability of fAUC 200 mgxh/L target attainment", fontface = "bold", size = 12)
draw_label("Non-CRRT", fontface = "bold", size = 12,hjust=1.7)

# Arrange the title and grid using plot_grid()
grid_BW_noCRRT <- plot_grid(title, grid_BW_noCRRT, ncol = 1, rel_heights = c(0.02, 1))
grid_BW_noCRRT

# Export grid_BW_noCRRT_rearranged plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim/PTA plots")
#setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Workshops and Conferences/ECCMID 2024")
ggsave("grid_BW_noCRRT_rearranged.png", grid_BW_noCRRT, dpi = 300, width = 16, height = 8.27)

```

```{r similarly - rearrange CRRT plot grid, warning=FALSE}

## Day 1

# Create PTA_BW_CRRT dataset from above

# Define the labels and colors

dosing_labels_day12 <- c("800 mg q24h LD / 400 mg q24h MD",
                    "1000 mg q24h LD / 800 mg q24h MD",
                   "1200 mg q24h LD / 800 mg q24h MD",
                   "1400 mg q24h LD / 800 mg q24h MD",
                   "1600 mg q24h LD / 800 mg q24h MD",
                   "1800 mg q24h LD / 800 mg q24h MD")

dosing_labels_day714 <- c("400 mg q24h MD",
                   "600 mg q24h MD",
                   "800 mg q24h MD")

dosing_colors_day12 <- c("#fde725",
                   "#90d743",
                   "#35b779",
                   "#21918c",
                   "#31688e",
                   "#443983")

dosing_colors_day714 <- c("#fde725",
                         "#440154",
                   "#90d743")

## Plotting day 1 and 2
# Here we use Colorblind-Friendly Palette - scale_colour_viridis_d()
# I also enforce limits on vertical lines here

# Firstly, create dataset with BW, Regimen and PTA on day 1 
BW_Reg <- data.frame( #BW and Regimen dataset
  BW = c(60, 80, 100, 120, 140),
  Regimen = c(3, 4, 5, 6,7)
)

# Then, make a dataset of PTA on Day 1 per BW per Regimen
BW_PTA_DaY1<-BW_Reg %>%
  left_join(
    PTA_BW_CRRT %>% filter(DAY == 1),
    by = c("BW", "Regimen")
  )

# Similarly for day 2
BW_PTA_DaY2<-BW_Reg %>%
  left_join(
    PTA_BW_CRRT %>% filter(DAY == 2),
    by = c("BW", "Regimen")
  )

# Then making PTA_BW_noCRRT200_DAY1 plot, which I use geom_segment to enforce restriction on vertical lines, using newly created BW_PTA_DaY1 dataset
PTA_BW_CRRT200_DAY1<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 1 & PTA_BW_CRRT$Regimen != 2,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day12, name = "Dosing regimen",
                     labels = dosing_labels_day12) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY1,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_200  # Ending at the corresponding PTA_fAUC_200 value
    ),
    linetype = "dashed",
    color = "gray50",
    size = 1
  )
PTA_BW_CRRT200_DAY1

## Day 2
PTA_BW_CRRT200_DAY2<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 2 & PTA_BW_CRRT$Regimen != 2,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 2") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day12, name = "Dosing regimen",
                     labels = dosing_labels_day12) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY2,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_200  # Ending at the corresponding PTA_fAUC_200 value
    ),
    linetype = "dashed",
    color = "gray50",
    size = 1
  )
PTA_BW_CRRT200_DAY2

## Day 7
PTA_BW_CRRT200_DAY7<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 7 & PTA_BW_CRRT$Regimen<4, ],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 7") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day714, name = "Dosing regimen",
                     labels = dosing_labels_day714) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_CRRT200_DAY7

## Day 14
PTA_BW_CRRT200_DAY14<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 14 & PTA_BW_CRRT$Regimen<4, ],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5), expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day714, name = "Dosing regimen",
                     labels = dosing_labels_day714) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_CRRT200_DAY14

## Combining these DAY 1 & 2 into 1

# Define common legend for both plots
common_legend <- get_legend(PTA_BW_CRRT200_DAY1)

# Remove legends from individual plots
PTA_BW_CRRT200_DAY1 <- PTA_BW_CRRT200_DAY1 + theme(legend.position = "none")
PTA_BW_CRRT200_DAY2 <- PTA_BW_CRRT200_DAY2 + theme(legend.position = "none")

# Combine these 2 plots into 1

PTA_BW_CRRT200_DAY12 <- plot_grid(PTA_BW_CRRT200_DAY1, PTA_BW_CRRT200_DAY2,common_legend,rel_widths = c(1,1,0.35),nrow = 1, align = "h")

# Then combining day 7 & 14

# Define common legend for both plots
common_legend <- get_legend(PTA_BW_CRRT200_DAY7)

# Remove legends from individual plots
PTA_BW_CRRT200_DAY7 <- PTA_BW_CRRT200_DAY7 + theme(legend.position = "none")
PTA_BW_CRRT200_DAY14 <- PTA_BW_CRRT200_DAY14 + theme(legend.position = "none")

# Combine these 2 plots into 1

PTA_BW_CRRT200_DAY714 <- plot_grid(PTA_BW_CRRT200_DAY7, PTA_BW_CRRT200_DAY14,common_legend,rel_widths = c(1,1,0.35),nrow = 1, align = "h")

## Then combining these 4 plots
grid_BW_CRRT <- plot_grid(PTA_BW_CRRT200_DAY12, PTA_BW_CRRT200_DAY714, nrow = 2, align = "v")

title <- ggdraw() + 
  #draw_label("Probability of fAUC 200 mgxh/L target attainment", fontface = "bold", size = 12)
draw_label("CRRT", fontface = "bold", size = 12,hjust=2.7)

# Arrange the title and grid using plot_grid()
grid_BW_CRRT <- plot_grid(title, grid_BW_CRRT, ncol = 1, rel_heights = c(0.02, 1))
grid_BW_CRRT

# Export grid_BW_noCRRT_rearranged plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim/PTA plots")
#setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Workshops and Conferences/ECCMID 2024")
ggsave("grid_BW_CRRT_rearranged.png", grid_BW_CRRT, dpi = 300, width = 16, height = 8.27)

```

###### Plot for ECCMID 081123 

```{r make a plot of CRRT & non-CRRT day 1 & day 14}

## First of all, for CRRT

# Create PTA_BW_CRRT dataset from above

# Define the labels and colors

dosing_labels_day1 <- c("800 mg q24h (day 1)",
                    "1000 mg q24h (day 1)",
                   "1200 mg q24h (day 1)",
                   "1400 mg q24h (day 1)",
                   "1600 mg q24h (day 1)",
                   "1800 mg q24h (day 1)")

dosing_labels_day14 <- c("400 mg q24h (from day 2)",
                   "600 mg q24h (from day 2)",
                   "800 mg q24h (from day 2)")

dosing_colors_day1 <- c("#fde725",
                   "#90d743",
                   "#35b779",
                   "#21918c",
                   "#31688e",
                   "#443983")

dosing_colors_day14 <- c("#fde725",
                         "#440154",
                   "#90d743")

## Enforcing limits on vertical lines day 1

# Firstly, create dataset with BW, Regimen and PTA on day 1 
BW_Reg <- data.frame( #BW and Regimen dataset
  BW = c(60, 80, 100, 120, 140),
  Regimen = c(3, 4, 5, 6,7)
)

# Then, make a dataset of PTA on Day 1 per BW per Regimen
BW_PTA_DaY1<-BW_Reg %>%
  left_join(
    PTA_BW_CRRT %>% filter(DAY == 1),
    by = c("BW", "Regimen")
  )

# Then making PTA_BW_noCRRT200_DAY1 plot, which I use geom_segment to enforce restriction on vertical lines, using newly created BW_PTA_DaY1 dataset

PTA_BW_CRRT200_DAY1<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 1 & PTA_BW_CRRT$Regimen != 2,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5),expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day1, name = "Dosing regimen",
                     labels = dosing_labels_day1) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY1,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_200  # Ending at the corresponding PTA_fAUC_200 value
    ),
    linetype = "4C88C488",
    color = "gray50",
    size = 1
  )
PTA_BW_CRRT200_DAY1

## Day 14
PTA_BW_CRRT200_DAY14<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 14 & PTA_BW_CRRT$Regimen<4, ],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5),expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day14, name = "Dosing regimen",
                     labels = dosing_labels_day14) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_CRRT200_DAY14

## Combining these DAY 1 & 14 into 1, they have different legends

# Combine these 2 plots into 1

PTA_BW_CRRT200_DAY114 <- plot_grid(PTA_BW_CRRT200_DAY1, PTA_BW_CRRT200_DAY14,nrow = 1, align = "h")

# Create common title
title <- ggdraw() + 
draw_label("CRRT", fontface = "bold", size = 12,hjust=2.7) #

# Arrange the title and grid using plot_grid()

grid_BW_CRRT <- plot_grid(title, PTA_BW_CRRT200_DAY114, ncol = 1, rel_heights = c(0.04, 1))
grid_BW_CRRT

## Second of all, for non-CRRT

# Create PTA_BW_noCRRT dataset from above

# Define the labels and colors

dosing_labels_day1 <- c("800 mg q24h (day 1)",
                    "1000 mg q24h (day 1)",
                   "1200 mg q24h (day 1)",
                   "1400 mg q24h (day 1)",
                   "1600 mg q24h (day 1)",
                   "1800 mg q24h (day 1)")

dosing_labels_day14 <- c("200 mg q24h (from day 2)",
                         "400 mg q24h (from day 2)")

dosing_colors_day1 <- c("#fde725",
                   "#90d743",
                   "#35b779",
                   "#21918c",
                   "#31688e",
                   "#443983")

dosing_colors_day14 <- c("#443983","#fde725")


# Similarly, enforce limits on vertical lines here

# Firstly, create dataset with BW, Regimen and PTA on day 1 
BW_Reg <- data.frame( #BW and Regimen dataset
  BW = c(60, 80, 100, 120, 140),
  Regimen = c(2, 3, 4, 5, 6)
)

# Then, make a dataset of PTA on Day 1 per BW per Regimen
BW_PTA_DaY1<-BW_Reg %>%
  left_join(
    PTA_BW_noCRRT %>% filter(DAY == 1),
    by = c("BW", "Regimen")
  )

# Then making PTA_BW_noCRRT200_DAY1 plot, which I use geom_segment to enforce restriction on vertical lines, using newly created BW_PTA_DaY1 dataset
PTA_BW_noCRRT200_DAY1<- ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 1 & PTA_BW_noCRRT$Regimen>1,],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5),expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day1, name = "Dosing regimen",
                     labels = dosing_labels_day1) +
   geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) +
  geom_segment(
    data = BW_PTA_DaY1,
    aes(
      x = BW,
      xend = BW,
      y = 0,  # Starting from the x-axis
      yend = PTA_fAUC_200  # Ending at the corresponding PTA_fAUC_200 value
    ),
    linetype = "4C88C488",#change this for a second
    color = "gray50",
    size = 1
  )
PTA_BW_noCRRT200_DAY1

# Day 14
PTA_BW_noCRRT200_DAY14<-  ggplot(PTA_BW_noCRRT[PTA_BW_noCRRT$DAY == 14 & PTA_BW_noCRRT$Regimen<3, ],aes(x = BW, y = PTA_fAUC_200,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 5),expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \textit{f}AUC_{0-24}\ \geq 200 \, \mg \times h/L\ (\%)$)")) +
  theme_minimal() +
        ggtitle("Day 14") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day14, name = "Dosing regimen",
                     labels = dosing_labels_day14) +
geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1)
PTA_BW_noCRRT200_DAY14

## Combining these DAY 1 & 14 into 1, they have different legends

# Combine these 2 plots into 1

grid_BW_noCRRT_DAY114 <- plot_grid(PTA_BW_noCRRT200_DAY1, PTA_BW_noCRRT200_DAY14,nrow = 1, align = "h")
grid_BW_noCRRT_DAY114

# Create common title
title <- ggdraw() + 
draw_label("Non-CRRT", fontface = "bold", size = 12,hjust=1.7) #change title according to Erwin's comments

# Arrange the title and grid using plot_grid()
grid_BW_noCRRT <- plot_grid(title, grid_BW_noCRRT_DAY114, ncol = 1, rel_heights = c(0.04, 1))
grid_BW_noCRRT

# Add panel titles

#PTA_Cmin80_c<-grid.arrange(textGrob("(c)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 11)), PTA_Cmin80, ncol = 1, heights = c(0, 1))

grid_BW_noCRRT_a<-grid.arrange(textGrob("(a)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 11)), grid_BW_noCRRT, ncol = 1, heights = c(0, 1))

grid_BW_CRRT_b<-grid.arrange(textGrob("(b)", x = 0.05, y = 0.95, just = c("left", "top"), gp = gpar(fontsize = 11)), grid_BW_CRRT, ncol = 1, heights = c(0, 1))

# Add plot of Cmin<80 to the above two plots - 151123 #adding plot title 161123
#grid_BW_PTA_Toxic <- plot_grid(grid_BW_noCRRT_a, grid_BW_CRRT_b, PTA_Cmin80_c, nrow = 3, align = "v")

## Finally, combine grid_BW_noCRRT & grid_BW_CRRT vertically

grid_BW_hybrid_DAY114 <- plot_grid(grid_BW_noCRRT_a, grid_BW_CRRT_b,nrow = 2, align = "v")

# Export grid_BW_hybrid_DAY114 plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Workshops and Conferences/ECCMID 2024")
ggsave("grid_BW_hybrid_DAY114.png", grid_BW_hybrid_DAY114, dpi = 300, width = 16, height = 8.27)
#ggsave("grid_BW_PTA_Toxic.png", grid_BW_PTA_Toxic, dpi = 300, width = 16, height = 11)

```

#### Plotting % of Toxicity

##### BW - CRRT

```{r toxicity % day 1 to day 14,warning=FALSE}

# PTA_BW_CRRT dataset is created above when plotting PTA
# Similarly, dosing labels and colors are also created from above

# Then we can plot PTA Cmin 80mg/L for Day 1

PTA_BW_CRRT80_DAY1<-  ggplot(PTA_BW_CRRT[PTA_BW_CRRT$DAY == 1 & PTA_BW_CRRT$Regimen != 2,],aes(x = BW, y = PTA_Cmin_80,group = factor(Regimen), color = factor(Regimen))) +
  geom_line(size=1) +
  scale_x_continuous(limits = c(30, 150), breaks = seq(30, 150, by = 5), name = "Body weight (kg)" ,expand = c(0,0)) +
  scale_y_continuous(limits = c(0, 0.1), breaks = seq(0, 0.1, by = 0.01), name = "Probability (%)",expand = c(0,0)) +
  theme_minimal() +
        ggtitle("Day 1") +
  theme(legend.position = "right") +
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10),
        axis.text = element_text(size = 9),
        legend.title = element_text(size = 9),
        legend.text = element_text(size = 8),
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) +
  labs(color = "Regimen") +
  scale_color_manual(values = dosing_colors_day1, name = "Dosing regimen",
                     labels = dosing_labels_day1) #+
   #geom_hline(yintercept = 90, linetype = "dashed", color = "gray50",size=1) #+
  #geom_vline(xintercept = c(60, 80, 100, 120, 140), linetype = "dashed", color = "gray50", size = 1)
PTA_BW_CRRT80_DAY1

# Too small so I will make a box plot - 141123

# First of all, create a new CRRT column in PTA_BW_CRRT/noCRRT datasets
PTA_BW_CRRT$CRRT<-1
PTA_BW_noCRRT$CRRT<-0
PTA_BW<-rbind(PTA_BW_CRRT,PTA_BW_noCRRT)

# Select data of the optimised recommended dosing regimen
PTA_BW_optimised<-PTA_BW %>%
  filter(
    (CRRT == 1 & BW <= 60 & Regimen == 3) |
    (CRRT == 1 & 60 < BW & BW <= 80 & Regimen == 4) |
    (CRRT == 1 & 80 < BW & BW <= 100 & Regimen == 5) |
    (CRRT == 1 & 100 < BW & BW <= 120 & Regimen == 6) |
    (CRRT == 1 & 120 < BW & Regimen == 7) |
    (CRRT == 0 & BW <= 60 & Regimen == 2) |
    (CRRT == 0 & 60 < BW & BW <= 80 & Regimen == 3) |
    (CRRT == 0 & 80 < BW & BW <= 100 & Regimen == 4) |
    (CRRT == 0 & 100 < BW & BW <= 120 & Regimen == 5) |
    (CRRT == 0 & 120 < BW & BW <= 140 & Regimen == 6) |
    (CRRT == 0 & 140 < BW & Regimen == 7)
  )

#Excluding unecessary regimens to make box plots, specifically regimen = 2 for 
#BW-CRRT, and regimen = 1 for BW-nonCRRT

#PTA_BW <- PTA_BW %>%
  #filter(!(CRRT == 1 & Regimen == 2 | CRRT == 0 & Regimen == 1))

# Then I can make box plots
PTA_Cmin80 <- ggplot(PTA_BW_optimised, aes(x = factor(CRRT), y = PTA_Cmin_80)) +
  geom_boxplot(fill = "#fde725", color = "#fde725",lwd=1.2,fatten=1.1, outlier.shape = NA, alpha = 0.6) +
  #geom_jitter(fill = "#440154", color = "#440154",alpha=0.3,width = 0.3) +
  scale_x_discrete(labels = c("No","Yes")) +
  xlab("Continuous renal replacement therapy") +
  scale_y_continuous(limits = c(0, 0.5), breaks = seq(0, 0.5, by = 0.1),expand = c(0,0)) +
  ylab(TeX(r"($Probability\ of\ \C_{min}\ >80\ \mg / \L\ (\%)$)")) +
  theme_minimal() +
        #ggtitle("Probability of having Cmin > 80 mg/L") + #comment out title according to Erwin's comment
  theme(plot.title = element_text(hjust = 0.5, size = 11,face="bold"),
        axis.title = element_text(size = 10), #change text into markdown for a second
        axis.text = element_text(size = 9),
        legend.position = "none",
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        axis.line.x = element_line(color = "grey", size = 0.5),
        axis.line.y = element_line(color = "grey", size = 0.5)) 
PTA_Cmin80

# Export PTA_Cmin80
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/BW_Sim/PTA plots")
ggsave("PTA_Cmin80.png", PTA_Cmin80, dpi = 300, width = 16, height = 8.27)

```

### Clindamycin side project 131023

#### Import the dataset that I've created

```{r Clindamycin_APriori & Clindamycin_APosteriori datasets,warning=FALSE}

# Load a ";" seperated file
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Clindamycin_APriori<-read.csv("Clindamycin_APriori.csv",sep=";")

# Export to a comma seperated file
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
write.csv(Clindamycin_APriori, "Clindamycin_APriori.csv",quote=F,row.names = FALSE)

# Similarly for a Posteriori dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Clindamycin_APosteriori<-read.csv("Clindamycin_APosteriori.csv",sep=";")

# Export to a "," seperated file
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
write.csv(Clindamycin_APosteriori, "Clindamycin_APosteriori.csv",quote=F,row.names = FALSE)

```

#### Finetuning A.Priori & A.Posteriori datasets to calculate AUC

```{r adding dummy rows to calculate AUCs,warning=FALSE}

# Load Apriori file
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Clindamycin_APriori<-read.csv("Clindamycin_APriori.csv")

# Create a new row by copying the first row
new_row <- Clindamycin_APriori[1, ]

# Add the new row as the second row
Clindamycin_APriori <- rbind(Clindamycin_APriori[1, ], new_row, Clindamycin_APriori[-1, ])

# Reset row names if needed
row.names(Clindamycin_APriori) <- NULL


# Read my Mod1_Run01 model
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod1_Run01<-read.csv("Mod1_Run01.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod1_Run02 model
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod1_Run02<-read.csv("Mod1_Run02.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod2_Run01 model
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod2_Run01<-read.csv("Mod2_Run01.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod2_Run02 model
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod2_Run02<-read.csv("Mod2_Run02.csv",skip=1,check.names = FALSE, sep="")

```

#### Finetuning datasets based on Erwin's comments

```{r firstly Apriori_Final, warning=FALSE}

# Load Apriori_Final file
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Clindamycin_APriori_Final<-read.csv("Clindamycin_APriori_Final.csv")

## Adding more lines to make smooth curves

# Set the initial TIME value for the 12th row
row_to_replicate <- Clindamycin_APriori_Final[12, ]
row_to_replicate$TIME <- 65.65

# Initialize an empty dataframe to store the results
replicated_data <- data.frame()

# Initialize the starting TIME value
current_time <- 65.65

# Set the increment value
time_increment <- 0.2

# Continue replicating as long as the TIME value is less than 72.5
while (current_time < 72.5) {
  # Update the TIME value in the row to be the current_time
  row_to_replicate$TIME <- current_time
  
  # Add the replicated row with the updated TIME value to the results dataframe
  replicated_data <- rbind(replicated_data, row_to_replicate)
  
  # Update the TIME value
  current_time <- current_time + time_increment
}

# Add the replicated data to the original dataframe
Clindamycin_APriori_Final <- rbind(Clindamycin_APriori_Final, replicated_data)

# Sort the dataset by TIME
Clindamycin_APriori_Final <- Clindamycin_APriori_Final %>%
  arrange(TIME)

## Updating the TAD column

# Find the row where TIME is 65.37
row_to_update <- which(Clindamycin_APriori_Final$TIME == 65.37)

# Update the TAD value of the row where TIME = 65.37 to 0
Clindamycin_APriori_Final[row_to_update, "TAD"] <- 0

# Update the TAD of the following rows
for (i in (row_to_update + 1):nrow(Clindamycin_APriori_Final)) {
  Clindamycin_APriori_Final$TAD[i] <- Clindamycin_APriori_Final$TIME[i] - 65.37
}

# Change row.names
row.names(Clindamycin_APriori_Final) <- 1:50

# round TIME and TAD
Clindamycin_APriori_Final$TIME<-round(Clindamycin_APriori_Final$TIME,2)
Clindamycin_APriori_Final$TAD<-round(Clindamycin_APriori_Final$TAD,2)

# Export Clindamycin_APriori_Finetune dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
write.csv(Clindamycin_APriori_Final, "Clindamycin_APriori_Finetune.csv",quote=F,row.names = FALSE)

```

```{r similary for APosteriori_Final, warning=FALSE}

# Load Apriori_Final file
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Clindamycin_APosteriori_Final<-read.csv("Clindamycin_APosteriori_Final.csv")

## Adding more lines to make smooth curves

# Set the initial TIME value for the 12th row
row_to_replicate <- Clindamycin_APosteriori_Final[12, ]
row_to_replicate$TIME <- 65.65
row_to_replicate$DV <- 0

# Initialize an empty dataframe to store the results
replicated_data <- data.frame()

# Initialize the starting TIME value
current_time <- 65.65

# Set the increment value
time_increment <- 0.2

# Continue replicating as long as the TIME value is less than 72.5
while (current_time < 72.5) {
  # Update the TIME value in the row to be the current_time
  row_to_replicate$TIME <- current_time
  
  # Add the replicated row with the updated TIME value to the results dataframe
  replicated_data <- rbind(replicated_data, row_to_replicate)
  
  # Update the TIME value
  current_time <- current_time + time_increment
}

# Add the replicated data to the original dataframe
Clindamycin_APosteriori_Final <- rbind(Clindamycin_APosteriori_Final, replicated_data)

# Sort the dataset by TIME
Clindamycin_APosteriori_Final <- Clindamycin_APosteriori_Final %>%
  arrange(TIME)

## Updating the TAD column

# Find the row where TIME is 65.37
row_to_update <- which(Clindamycin_APosteriori_Final$TIME == 65.37)

# Update the TAD value of the row where TIME = 65.37 to 0
Clindamycin_APosteriori_Final[row_to_update, "TAD"] <- 0

# Update the TAD of the following rows
for (i in (row_to_update + 1):nrow(Clindamycin_APosteriori_Final)) {
  Clindamycin_APosteriori_Final$TAD[i] <- Clindamycin_APosteriori_Final$TIME[i] - 65.37
}

# Change row.names
row.names(Clindamycin_APosteriori_Final) <- 1:50

# round TIME and TAD
Clindamycin_APosteriori_Final$TIME<-round(Clindamycin_APosteriori_Final$TIME,2)
Clindamycin_APosteriori_Final$TAD<-round(Clindamycin_APosteriori_Final$TAD,2)

# Change MDV of non-DV events to 0
Clindamycin_APosteriori_Final$MDV<-ifelse(Clindamycin_APosteriori_Final$EVID==0&Clindamycin_APosteriori_Final$DV==0,1,Clindamycin_APosteriori_Final$MDV)

# Export Clindamycin_APosteriori_Finetune dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
write.csv(Clindamycin_APosteriori_Final, "Clindamycin_APosteriori_Finetune.csv",quote=F,row.names = FALSE)

```

##### Adjusting Finetune dataset - DV = "."

```{r changing DV from 0 to ".",warning=FALSE}

# Load Clindamycin_APosteriori_Finetune file
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Clindamycin_APosteriori_Finetune<-read.csv("Clindamycin_APosteriori_Finetune.csv")

# Change DV from 0 to '.'
Clindamycin_APosteriori_Finetune$DV<-ifelse(Clindamycin_APosteriori_Finetune$DV==0,".",Clindamycin_APosteriori_Finetune$DV)

# Export Clindamycin_APosteriori_Finetune
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
write.csv(Clindamycin_APosteriori_Finetune, "Clindamycin_APosteriori_Finetune.csv",quote=F,row.names = FALSE)

```

#### Checking sensivity of the results when changing time of the first dose

```{r checking the first dose at 4pm and 6pm,warning=FALSE}

## First of all, at 4pm

# Read my Mod1_Run01_4pm dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod1_Run01_4pm<-read.csv("Mod1_Run01_4pm.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod1_Run02_4pm dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod1_Run02_4pm<-read.csv("Mod1_Run02_4pm.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod2_Run01_4pm dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod2_Run01_4pm<-read.csv("Mod2_Run01_4pm.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod2_Run02_4pm dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod2_Run02_4pm<-read.csv("Mod2_Run02_4pm.csv",skip=1,check.names = FALSE, sep="")

## Calculating half-lives at 4pm and 8pm
T_mod1_pri_4pm<-log(2)*103/23
T_mod1_pri_8pm<-log(2)*103/23
T_mod1_pos_4pm<-log(2)*45.25/5.78
T_mod1_pos_8pm<-log(2)*47.96/6.06

T_mod2_pri_4pm<-log(2)*75.23/20.10
T_mod2_pos_4pm<-log(2)*75.23/6.88
T_mod2_pos_8pm<-log(2)*75.23/7.41

## Calculating AUC at 4pm and 8pm
AUC_mod1_pos_4pm<-196.43-70.82
AUC_mod1_pos_8pm<-228.37-70.75
AUC_mod2_pos_4pm<-135.57-81.52
AUC_mod2_pos_8pm<-163.07-81.47

# Calculate CL/F & Vd/F of Mod 2
CL.F_mod2_pri_4pm<-17.69/0.88
Vd.F_mod2_pri_4pm<-66.2/0.88
CL.F_mod2_pos_4pm<-6.05/0.88
Vd.F_mod2_pos_4pm<-66.2/0.88
CL.F_mod2_pos_8pm<-6.52/0.88
Vd.F_mod2_pos_8pm<-66.2/0.88

```

#### Analyse final run after I added multiple doses to calculate steady-state AUC, starting dose at 19:30, not 18:00

```{r import Mod1_Run01_Final Mod1_Run02_Final Mod2_Run01_Final Mod2_Run02_Final,warning=FALSE}

# Read my Mod1_Run01_Final dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod1_Run01_Final<-read.csv("Mod1_Run01_Final.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod1_Run02_Final dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod1_Run02_Final<-read.csv("Mod1_Run02_Final.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod2_Run01_Final dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod2_Run01_Final<-read.csv("Mod2_Run01_Final.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod2_Run02_Final dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod2_Run02_Final<-read.csv("Mod2_Run02_Final.csv",skip=1,check.names = FALSE, sep="")

## Calculating half-lives 
T_mod1_pri<-log(2)*103/23
T_mod1_pos<-log(2)*73.72/6.61

T_mod2_pri<-log(2)*66.2/17.69
T_mod2_pos<-log(2)*75.23/8.19

## Calculating AUC
AUC_mod1_pri<-227.24-148.65
AUC_mod1_pos<-714.27-436.42
AUC_mod2_pri<-259.72-169.28
AUC_mod2_pos<-585.77-360.38

# Calculate CL/F & Vd/F of Mod 2
CL.F_mod2_pri<-17.69/0.88
Vd.F_mod2_pri<-66.2/0.88
CL.F_mod2_pos<-7.21/0.88
Vd.F_mod2_pos<-66.2/0.88

```

```{r making plots of apriori observed posterior, warning=FALSE}

# Mimram et al model

mod_mimram<-ggplot() +
  geom_line(data = Mod1_Run01_Final[Mod1_Run01_Final$EVID == 0, ],
             mapping = aes(x = TIME, y = IPRED, color = "A priori prediction"),
             size = 1) +
  geom_line(data = Mod1_Run02_Final[Mod1_Run02_Final$MDV == 0, ],
             mapping = aes(x = TIME, y = IPRED, color = "A posteriori prediction"),
             size = 1) +
  geom_line(data = Mod1_Run02_Final[Mod1_Run02_Final$MDV == 0, ],
             mapping = aes(x = TIME, y = DV, color = "Observed"),
             size = 1) +
  ggtitle("Mimram et al model") +
  xlab("Time since first dose (hours)") +
  ylab("Clindamycin total concentration (mg/L)") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  scale_x_continuous(limits = c(65, 73), breaks = seq(65, 73, by = 1)) +
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, by = 2)) +
  theme(plot.title = element_text(hjust = 0.5, size = 14,face="bold"),
    axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.title = element_blank(),
        legend.text = element_text(size = 8)) +
  scale_color_manual(values = c("A priori prediction" = "#440154",
    "A posteriori prediction" = "#fde725",
     "Observed" = "#21918c"),
    breaks=c('A priori prediction', 'A posteriori prediction', 'Observed'))

# Bouazza et al model

mod_bouazza<-ggplot() +
  geom_line(data = Mod2_Run01_Final[Mod2_Run01_Final$EVID == 0, ],
             mapping = aes(x = TIME, y = IPRED, color = "A priori prediction"),
             size = 1) +
  geom_line(data = Mod2_Run02_Final[Mod2_Run02_Final$MDV == 0, ],
             mapping = aes(x = TIME, y = IPRED, color = "A posteriori prediction"),
             size = 1) +
  geom_line(data = Mod2_Run02_Final[Mod2_Run02_Final$MDV == 0, ],
             mapping = aes(x = TIME, y = DV, color = "Observed"),
             size = 1) +
  ggtitle("Bouazza et al model") +
  xlab("Time since first dose (hours)") +
  ylab("Clindamycin total concentration (mg/L)") +
  theme_bw() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  scale_x_continuous(limits = c(65, 73), breaks = seq(65, 73, by = 1)) +
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, by = 2)) +
  theme(plot.title = element_text(hjust = 0.5, size = 14,face="bold"),
    axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.title = element_blank(),
        legend.text = element_text(size = 8)) +
  scale_color_manual(values = c("A priori prediction" = "#440154",
    "A posteriori prediction" = "#fde725",
     "Observed" = "#21918c"),
    breaks=c('A priori prediction', 'A posteriori prediction', 'Observed'))

# Define common legend for both plots
common_legend <- get_legend(mod_bouazza)

# Reduce the size of the legend
common_legend <- common_legend #+ theme(legend.key.width= unit(5, 'cm'))

# Remove legends from individual plots
mod_mimram_nolegend <- mod_mimram + theme(legend.position = "none")
mod_bouazza_nolegend <- mod_bouazza + theme(legend.position = "none")

# Combine the two plots with the common legend
grid_clinda <- plot_grid(mod_mimram_nolegend, mod_bouazza_nolegend, rel_widths = c(1, 1), nrow = 1, align = "h", common_legend)

# Display or save the grid_clinda plot as needed
grid_clinda

# Export the combined plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/Plots")
ggsave("grid_clinda.png", grid_clinda, dpi = 300, width = 16, height = 8.27)

# Combine the two plots with the common legend
grid_clinda <- plot_grid(mod_mimram, mod_bouazza,nrow = 1, align = "h")

# Export the combined plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/Plots")
ggsave("grid_clinda.png", grid_clinda, dpi = 300, width = 16, height = 8.27)

```

#### Analyse final run after Erwin's comments

```{r finetuning final plots,warning=FALSE}

# Read my Mod1_Run01_Finetune dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod1_Run01_Finetune<-read.csv("Mod1_Run01_Finetune.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod1_Run02_Finetune dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod1_Run02_Finetune<-read.csv("Mod1_Run02_Finetune.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod2_Run01_Finetune dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod2_Run01_Finetune<-read.csv("Mod2_Run01_Finetune.csv",skip=1,check.names = FALSE, sep="")

# Read my Mod2_Run02_Finetune dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/My Code")
Mod2_Run02_Finetune<-read.csv("Mod2_Run02_Finetune.csv",skip=1,check.names = FALSE, sep="")

# Mimram et al model

mod_mimram<-ggplot() +
  geom_line(data = Mod1_Run01_Finetune[Mod1_Run01_Finetune$EVID == 0 & Mod1_Run01_Finetune$TIME > 48.5, ], 
            mapping = aes(x = TAD, y = IPRED, color = "A priori prediction"),
             size = 1) +
  geom_line(data = Mod1_Run02_Finetune[Mod1_Run02_Finetune$EVID == 0 & Mod1_Run02_Finetune$TIME > 48.5, ],
             mapping = aes(x = TAD, y = IPRED, color = "A posteriori prediction"),
             size = 1) +
  geom_point(data = Mod1_Run02_Finetune[Mod1_Run02_Finetune$MDV == 0 & Mod1_Run02_Finetune$DV != 0, ],
             mapping = aes(x = TAD, y = DV, color = "Observed"),
             size = 2,
             shape=19) +
  ggtitle("(A) Mimram et al. model") +
  xlab("Time since last dose (hours)") +
  ylab("Total clindamycin plasma concentration (mg/L)") +
  theme_classic() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  scale_x_continuous(limits = c(0, 7.5), breaks = seq(0, 7.5, by = 0.5)) +
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, by = 2)) +
  theme(plot.title = element_text(hjust = 0.5, size = 14,face="bold"),
    axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.title = element_blank(),
        legend.text = element_text(size = 8)) +
  scale_color_manual(values = c("A priori prediction" = "#440154",
    "A posteriori prediction" = "#fde725",
     "Observed" = "#21918c"),
    breaks=c('A priori prediction', 'A posteriori prediction', 'Observed')) +
  guides(color = guide_legend(override.aes = list(shape = c(NA, NA, 19),linetype = c(1, 1, 0))))

# Bouazza et al model

mod_bouazza<-ggplot() +
  geom_line(data = Mod2_Run01_Finetune[Mod2_Run01_Finetune$EVID == 0 & Mod2_Run01_Finetune$TIME > 48.5, ], 
            mapping = aes(x = TAD, y = IPRED, color = "A priori prediction"),
             size = 1) +
  geom_line(data = Mod2_Run02_Finetune[Mod2_Run02_Finetune$EVID == 0 & Mod2_Run02_Finetune$TIME > 48.5, ],
             mapping = aes(x = TAD, y = IPRED, color = "A posteriori prediction"),
             size = 1) +
  geom_point(data = Mod2_Run02_Finetune[Mod2_Run02_Finetune$MDV == 0 & Mod2_Run02_Finetune$DV != 0, ],
             mapping = aes(x = TAD, y = DV, color = "Observed"),
             size = 2,
             shape=19) +
  ggtitle("(B) Bouazza et al. model") +
  xlab("Time since last dose (hours)") +
  ylab("Total clindamycin plasma concentration (mg/L)") +
  theme_classic() +
  theme(panel.grid.major.x = element_blank(),
        panel.grid.minor.x = element_blank(),
        panel.grid.major.y = element_blank(),
        panel.grid.minor.y = element_blank()) +
  scale_x_continuous(limits = c(0, 7.5), breaks = seq(0, 7.5, by = 0.5)) +
  scale_y_continuous(limits = c(0, 20), breaks = seq(0, 20, by = 2)) +
  theme(plot.title = element_text(hjust = 0.5, size = 14,face="bold"),
    axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.title = element_blank(),
        legend.text = element_text(size = 8)) +
  scale_color_manual(values = c("A priori prediction" = "#440154",
    "A posteriori prediction" = "#fde725",
     "Observed" = "#21918c"),
    breaks=c('A priori prediction', 'A posteriori prediction', 'Observed')) +
  guides(color = guide_legend(override.aes = list(shape = c(NA, NA, 19),linetype = c(1, 1, 0))))

## Combining two plots

# Define common legend for both plots
common_legend <- get_legend(mod_bouazza)

# Remove legends from individual plots
mod_mimram_nolegend <- mod_mimram + theme(legend.position = "none")
mod_bouazza_nolegend <- mod_bouazza + theme(legend.position = "none")

# Combine the two plots with the common legend
grid_clinda <- plot_grid(mod_mimram_nolegend, mod_bouazza_nolegend,common_legend, nrow = 1,rel_widths=c(1,1,0.2), align = "h") 
# it worked - perfect

# Display or save the grid_clinda plot as needed
grid_clinda

# Export the combined plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/PhD in KU Leuven/Clindamycin side project/Plots")
ggsave("grid_clinda_classic.png", grid_clinda, dpi = 300, width = 16, height = 8.27)

```

```{r recalculating half-lives for posterior distribution}

T_mod1_pri<-log(2)*103/23
T_mod1_pos<-log(2)*70.75/6.56

T_mod2_pri<-log(2)*66.2/17.69
T_mod2_pos<-log(2)*75.23/8.10

## Calculating AUC
AUC_mod1_pri<-227.24-148.65
AUC_mod1_pos<-724.63-444.52
AUC_mod2_pri<-259.72-169.28
AUC_mod2_pos<-591.58-363.59

# Calculate CL/F & Vd/F of Mod 2
CL.F_mod2_pri<-17.69/0.88
Vd.F_mod2_pri<-66.2/0.88
CL.F_mod2_pos<-7.13/0.88
Vd.F_mod2_pos<-66.2/0.88

```

### CKDEPI & Fluc conc over Time plots

#### CKDEPI over Time plots

```{r investigating CKDEPI over TIME in CRRT patients, warning=FALSE}

# Import the dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets/Archived dataset")
FlucTotIV_clean <- read.csv("FlucTotIV_clean.csv", na.strings = "NA")

# Change DV from 0 to NA
FlucTotIV_clean$DV <-ifelse(FlucTotIV_clean$DV==0,NA,FlucTotIV_clean$DV)

# Define a function to calculate CKDEPI from CREAT
calculate_CKDEPI <- function(data, creatinine_column, sex_column, age_column, multiplier) {
  CKDEPI <- ifelse(data[[sex_column]] == 1 & data[[creatinine_column]] < 0.9,
                   multiplier * ((data[[creatinine_column]]/0.9)^-0.302) * (0.9938^data[[age_column]]),
                   ifelse(data[[sex_column]] == 1 & data[[creatinine_column]] >= 0.9,
                          multiplier * ((data[[creatinine_column]]/0.9)^-1.200) * (0.9938^data[[age_column]]),
                          ifelse(data[[sex_column]] == 2 & data[[creatinine_column]] < 0.7,
                                 multiplier * ((data[[creatinine_column]]/0.7)^-0.241) * (0.9938^data[[age_column]]) * 1.012,
                                 multiplier * ((data[[creatinine_column]]/0.7)^-1.200) * (0.9938^data[[age_column]]) * 1.012)
                   )
  )
  return(CKDEPI)
}

# Define a new column CKDEPI_DOS_INT from CREAT_DOS_INT
FlucTotIV_clean[["CKDEPI_DOS_INT"]] <- calculate_CKDEPI(FlucTotIV_clean,"CREAT_DOS_INT", 
                                                            "SEX", "AGE", 142)

# Get unique IDs with CRRT == 1 only

FlucTotIV_clean <- FlucTotIV_clean %>%filter(!HOSPITAL%in%c(3,4))
crrt_1_ids <- unique(FlucTotIV_clean$ID[FlucTotIV_clean$CRRT == 1 & !FlucTotIV_clean$ID %in% FlucTotIV_clean$ID[FlucTotIV_clean$CRRT == 0]]) #ids of those who have CRRT all the time 

# Select 5 random patients from crrt_IDs
set.seed(123) # set seed for reproducibility
crrt_IDs_1 <- sample(crrt_1_ids, size = 5, replace = FALSE)

# Create a subset of the original data frame with the selected patients
CRRT_subset_1 <- FlucTotIV_clean %>% 
        filter(ID %in% crrt_IDs_1)
CRRT_subset_2 <- FlucTotIV_clean %>% 
        filter(ID %in% crrt_1_ids) %>% 
        filter(!(ID %in% crrt_IDs_1))

# First plot
CKDEPI_DOS_INT_time_crrt_01<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CKDEPI_DOS_INT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CKDEPI_DOS_INT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CKDEPI over Time for 5 Random Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CKDEPI (ml/min/1.73m2)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("CKDEPI_DOS_INT_time_crrt_01.png", plot = CKDEPI_DOS_INT_time_crrt_01, dpi = 300, width = 10, height = 5)

# Second plot
CKDEPI_DOS_INT_time_crrt_02<-ggplot() +
        geom_line(data = CRRT_subset_2, aes(x = TIME, y = CKDEPI_DOS_INT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_2, aes(x = TIME, y = CKDEPI_DOS_INT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CKDEPI over Time for 5 remaing Patients with CRRT on all the time on both sampling & dosing days", x = "Time (hours)", y = "CKDEPI (ml/min/1.73m2)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_2[CRRT_subset_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
ggsave("CKDEPI_DOS_INT_time_crrt_02.png", plot = CKDEPI_DOS_INT_time_crrt_02, dpi = 300, width = 10, height = 5)


#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off

miscel_IDs <- FlucTotIV_clean %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
CKDEPI_DOS_INT_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = CKDEPI_DOS_INT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = CKDEPI_DOS_INT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CKDEPI over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "CKDEPI (ml/min/1.73m2)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 

# Export the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Exploratory data analysis/CKDEPI over TIME")
ggsave("CKDEPI_DOS_INT_time_miscel_01.png", plot = CKDEPI_DOS_INT_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
CKDEPI_DOS_INT_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = CKDEPI_DOS_INT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = CKDEPI_DOS_INT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CKDEPI over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "CKDEPI (ml/min/1.73m2)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
# Export the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Exploratory data analysis/CKDEPI over TIME")
ggsave("CKDEPI_DOS_INT_time_miscel_02.png", plot = CKDEPI_DOS_INT_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
CKDEPI_DOS_INT_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = CKDEPI_DOS_INT, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = CKDEPI_DOS_INT, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "CKDEPI over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "CKDEPI (ml/min/1.73m2)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 

# Export the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Exploratory data analysis/CKDEPI over TIME")
ggsave("CKDEPI_DOS_INT_time_miscel_03.png", plot = CKDEPI_DOS_INT_time_miscel_03, dpi = 300, width = 10, height = 5)

```

#### CKDEPI over Time plots imputation data 02

```{r imputed impute_BW02 dataset}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan")
Fluc_NONMEM_mul_impute_BW02 <- read.csv("Fluc_NONMEM_mul_impute_BW02.csv")

```

```{r}
# make plot of 5 imputed CRRT patients
# crrt_IDs_1 created above

CRRT_subset_1 <- Fluc_NONMEM_mul_impute_BW02 %>% 
        filter(ID %in% crrt_IDs_1)

CRRT_imputed_BW02<-ggplot() +
        geom_line(data = CRRT_subset_1, aes(x = TIME, y = CKDEPI01, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_subset_1, aes(x = TIME, y = CKDEPI01, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(17)) +
        scale_color_manual(values = c("red")) +
        labs(title = "CKDEPI over Time for 5 Random Patients with CRRT on all the time", x = "Time (hours)", y = "CKDEPI (ml/min/1.73m2)") +
        theme_bw() +
        geom_rect(data = CRRT_subset_1[CRRT_subset_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 

# Export dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets/Exploratory data analysis/CKDEPI over TIME/imputed dataset")
ggsave("CRRT_imputed_BW02.png", plot = CRRT_imputed_BW02, dpi = 300, width = 10, height = 5)

```


#### Fluc Conc over Time plots

```{r investigating Fluc Conc over TIME in CRRT patients, warning=FALSE}

# Import the dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Archived dataset")
FlucTotIV_clean <- read.csv("FlucTotIV_clean.csv", na.strings = "NA")

# Change DV from 0 to NA
FlucTotIV_clean$DV <-ifelse(FlucTotIV_clean$DV==0,NA,FlucTotIV_clean$DV)

# Define a function to calculate CKDEPI from CREAT
calculate_CKDEPI <- function(data, creatinine_column, sex_column, age_column, multiplier) {
  CKDEPI <- ifelse(data[[sex_column]] == 1 & data[[creatinine_column]] < 0.9,
                   multiplier * ((data[[creatinine_column]]/0.9)^-0.302) * (0.9938^data[[age_column]]),
                   ifelse(data[[sex_column]] == 1 & data[[creatinine_column]] >= 0.9,
                          multiplier * ((data[[creatinine_column]]/0.9)^-1.200) * (0.9938^data[[age_column]]),
                          ifelse(data[[sex_column]] == 2 & data[[creatinine_column]] < 0.7,
                                 multiplier * ((data[[creatinine_column]]/0.7)^-0.241) * (0.9938^data[[age_column]]) * 1.012,
                                 multiplier * ((data[[creatinine_column]]/0.7)^-1.200) * (0.9938^data[[age_column]]) * 1.012)
                   )
  )
  return(CKDEPI)
}

# Define a new column CKDEPI_DOS_INT from CREAT_DOS_INT
FlucTotIV_clean[["CKDEPI_DOS_INT"]] <- calculate_CKDEPI(FlucTotIV_clean,"CREAT_DOS_INT", 
                                                            "SEX", "AGE", 142)

#### I make the same plot for those who are on CRRT on & off on the whole treatment period

# First selecting the ID of those who have CRRT non-missing and CRRT on and off

miscel_IDs <- FlucTotIV_clean %>%
        group_by(ID) %>% 
        summarize(has_both_crrt = n_distinct(CRRT) == 2) %>% 
        filter(has_both_crrt) %>% 
        pull(ID) #equal 16
miscel_IDs<-as.character(miscel_IDs)

# Select 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_1 <- sample(miscel_IDs, size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_1 <- FlucTotIV_clean %>% 
        filter(ID %in% miscel_IDs_1)

# First plot
DV_time_miscel_01<-ggplot() +
        geom_line(data = CRRT_miscel_1, aes(x = TIME, y = DV, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_1, aes(x = TIME, y = DV, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "DV over Time for Patients with CRRT on and off 01", x = "Time (hours)", y = "DV (mg/L)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_1[CRRT_miscel_1$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 

# Export the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Exploratory data analysis/DV over TIME")
ggsave("DV_time_miscel_01.png", plot = DV_time_miscel_01, dpi = 300, width = 10, height = 5)

# Select another 6 random patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_2 <- sample(setdiff(miscel_IDs, miscel_IDs_1), size = 6, replace = FALSE)

# create a subset of the original data frame with the 6 patients
CRRT_miscel_2 <- FlucTotIV_clean %>% 
        filter(ID %in% miscel_IDs_2)

# Second plot
DV_time_miscel_02<-ggplot() +
        geom_line(data = CRRT_miscel_2, aes(x = TIME, y = DV, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_2, aes(x = TIME, y = DV, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "DV over Time for Patients with CRRT on and off 02", x = "Time (hours)", y = "DV (mg/L)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_2[CRRT_miscel_2$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 
# Export the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Exploratory data analysis/DV over TIME")
ggsave("DV_time_miscel_02.png", plot = DV_time_miscel_02, dpi = 300, width = 10, height = 5)

## And finally, select the remaining 4 patients from miscel_IDs
set.seed(123) # set seed for reproducibility
miscel_IDs_3 <- setdiff(miscel_IDs, c(miscel_IDs_1,miscel_IDs_2))

# create a subset of the original data frame with the 6 patients
CRRT_miscel_3 <- FlucTotIV_clean %>% 
        filter(ID %in% miscel_IDs_3)

# Third plot
DV_time_miscel_03<-ggplot() +
        geom_line(data = CRRT_miscel_3, aes(x = TIME, y = DV, group = ID, color = factor(CRRT)), size = 1) +
        geom_point(data = CRRT_miscel_3, aes(x = TIME, y = DV, shape = factor(CRRT)), size = 2) +
        scale_shape_manual(values = c(16, 17)) +
        scale_color_manual(values = c("black", "red")) +
        labs(title = "DV over Time for Patients with CRRT on and off 03", x = "Time (hours)", y = "DV (mg/L)") +
        theme_bw() +
        geom_rect(data = CRRT_miscel_3[CRRT_miscel_3$CRRT == 1, ], aes(xmin = TIME, xmax = TIME+0.1, ymin = -Inf, ymax = Inf),
                  fill = "grey", alpha = 0.2) +
        facet_wrap(~ ID, scales = "free") +
        guides(shape = guide_legend(title = "CRRT"), color = guide_legend(title = "CRRT")) 

# Export the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Exploratory data analysis/DV over TIME")
ggsave("DV_time_miscel_03.png", plot = DV_time_miscel_03, dpi = 300, width = 10, height = 5)

```

### Testing the effect of FFM - 261023

#### Exporting FFM dataset

```{r select appropriate variables for calculating FFM}

FlucTotIV_clean_imputed <- Fluc_NONMEM_mul_impute[, !names(Fluc_NONMEM_mul_impute) %in%c("CMT", "APACHE", "RACE", "CL24", "GGT", "AFT", "ALT", "AST", "BILI", "ALB", "SOFA", "IHD", "UF", "ECMO", "OCC3", "ARCCKD", "ARC24", "ARCAlg", "BMI", "BSA", "dup","FLUID",paste0("CREAT", sprintf("%02d", 1:10)),"CREAT_DOS_INT","unique_CREAT","CREAT3","CRRT2","dosing_interval","Creat_imputed","BW","BW2")]

```

```{r calculating FFM from BW and LENGTH}

for (i in 1:10) {
  FFM_var <- paste0("FFM", sprintf("%02d", i))
  BW_var <- paste0("BW", sprintf("%02d", i))
  LENGTH_var <- paste0("LENGTH", sprintf("%02d", i))
  
  FlucTotIV_clean_imputed[, FFM_var] <- ifelse(FlucTotIV_clean_imputed$SEX == 1,
    0.407 * FlucTotIV_clean_imputed[, BW_var] + 0.267 * FlucTotIV_clean_imputed[, LENGTH_var] * 100 - 19.2,
    0.252 * FlucTotIV_clean_imputed[, BW_var] + 0.473 * FlucTotIV_clean_imputed[, LENGTH_var] * 100 - 48.3
  )
}


```

```{r exporting FFM dataset, warning=FALSE}

# Full dataset with BW, LENGTH & FFM
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan")
write.csv(FlucTotIV_clean_imputed, "Fluc_NONMEM_mul_impute_FFM01_full.csv",quote=F,row.names = FALSE)

# Minimal dataset for modelling (without BW & LENGTH)
FlucTotIV_clean_FFM <- FlucTotIV_clean_imputed[, !names(FlucTotIV_clean_imputed) %in%c(paste0("BW", sprintf("%02d", 1:10)),paste0("LENGTH", sprintf("%02d", 1:10)))]
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Imputed_dos_int_datasets/2l method/2l.pan")
write.csv(FlucTotIV_clean_FFM, "Fluc_NONMEM_mul_impute_FFM01.csv",quote = F,row.names = FALSE)

```

### Population level simulation - 301023

#### Creating optmised dosing virtual dataset

```{r read in datafile, warning=FALSE}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation")
dosing_CRRT <- read.csv("dosing_03.csv")

```

```{r create a dataset of 1000 patients from dosing_CRRT dataset}

# Create a new dataset with only patient 13
dosing_CRRT_13 <- dosing_CRRT[dosing_CRRT$ID == 13,]

# Create 12 copies of the patient 13 dataset and assign IDs 14-1000
new_patients <- lapply(14:1000, function(id){
  new_df <- dosing_CRRT_13
  new_df$ID <- id
  return(new_df)
})

# Combine the new datasets with the original dataset
dosing_CRRT <- rbind(dosing_CRRT, do.call(rbind, new_patients))

## Assign new BW to these newly added patients

# Rename FFM to BW
names(dosing_CRRT)[names(dosing_CRRT) == "FFM"] <- "BW"

```

```{r assigning BW to the new dataset}

# for reproducibility
set.seed(123)

# Create the empirical cumulative distribution function (ECDF)
ecdf_BW <- ecdf(na.omit(FlucTotIV_clean$BW2))

# Generate random values from the ECDF
random_values <- runif(1000)

# Map the random values to the empirical distribution using the inverse transform sampling method
sampled_BW <- round(quantile(na.omit(FlucTotIV_clean$BW2), random_values), 1)

# Assign the sampled BW values to dosing_CRRT dataset
dosing_CRRT$BW <- sampled_BW[match(dosing_CRRT$ID, 1:1000)]

```

```{r assigning CKDEPI to the new dataset}

# for reproducibility
set.seed(123)

# Create the empirical cumulative distribution function (ECDF)
ecdf_CKDEPI <- ecdf(na.omit(FlucTotIV_clean$CKDEPI))

# Generate random values from the ECDF
random_values <- runif(1000)

# Map the random values to the empirical distribution using the inverse transform sampling method
sampled_CKDEPI <- round(quantile(na.omit(FlucTotIV_clean$CKDEPI), random_values), 1)

# Assign the sampled BW values to dosing_CRRT dataset
dosing_CRRT$CKDEPI <- sampled_CKDEPI[match(dosing_CRRT$ID, 1:1000)]

```

###### I will create my dosing_CRRT dataset with 9% full-time CRRT, and 9% part time CRRT (in which 51.5% DAYS on CRRT)

```{r mimic the aforementioned characterictics for my dosing_CRRT}

# Create a dummy dataset with 1000 patient IDs and 14 days:
dummy_data <- data.frame(
  ID = rep(1:1000, each = 14),
  DAY = rep(1:14, times = 1000)
)

# Add the CRRT variable to the dummy dataset and assign it temporarily to 0:
dummy_data$CRRT <- 0

# Randomly select 9% of the patient IDs and assign their CRRT to 1:
set.seed(42)  # Set seed for reproducibility
selected_ids <- sample(unique(dummy_data$ID), size = round(0.09 * 1000))
dummy_data$CRRT[dummy_data$ID %in% selected_ids] <- 1

# Randomly select another 9% of patient IDs that are not in selected_ids:
available_ids <- setdiff(unique(dummy_data$ID), selected_ids)
selected_ids_2 <- sample(available_ids, size = round(0.09 * 1000))
selected_days <- sample(unique(dummy_data$DAY), size = round(0.515 * 14))

# Assign 51.5% of the selected days to CRRT == 1, and the remaining to CRRT == 0
dummy_data$CRRT[dummy_data$ID %in% selected_ids_2 & dummy_data$DAY %in% selected_days] <- 1
dummy_data$CRRT[dummy_data$ID %in% selected_ids_2 & !dummy_data$DAY %in% selected_days] <- 0

# Assign CRRT == 0 to the remaining 82% of patient IDs:

dummy_data$CRRT[!(dummy_data$ID %in% c(selected_ids, selected_ids_2))] <- 0

# Assign the CRRT information from the dummy dataset to the dosing_CRRT dataset based on ID and DAY:

dosing_CRRT <- merge(dosing_CRRT, dummy_data[, c("ID", "DAY", "CRRT")], by = c("ID", "DAY"), all.x = TRUE)
dosing_CRRT$CRRT.x<-NULL
colnames(dosing_CRRT)[colnames(dosing_CRRT) == "CRRT.y"] <- "CRRT"

```

###### Updating dosing information

```{r updating loading and maintenance dose for dosing_CRRT}

dosing_CRRT <- dosing_CRRT %>%
  mutate(
    AMT = ifelse(TIME == 0 & BW > 120 & CRRT == 1, 1800,
           ifelse(TIME == 0 & BW <= 120 & BW > 100 & CRRT == 1, 1600,
           ifelse(TIME == 0 & BW <= 100 & BW > 80 & CRRT == 1, 1400,
           ifelse(TIME == 0 & BW <= 80 & BW > 60 & CRRT == 1, 1200, 
                  ifelse(TIME == 0 & BW <= 60 & CRRT == 1, 1000,
                         ifelse(TIME == 0 & BW > 140 & CRRT == 0, 1800,
                                ifelse(TIME == 0 & BW <= 140 & BW > 120 & CRRT == 0, 1600,
                                  ifelse(TIME == 0 & BW <= 120 & BW > 100 & CRRT == 0, 1400,
                                       ifelse(TIME == 0 & BW <= 100 & BW > 80 & CRRT == 0, 1200,
                                              ifelse(TIME == 0 & BW <= 80 & BW > 60 & CRRT == 0, 1000,
                                                     ifelse(TIME == 0 & BW <= 60 & CRRT == 0, 800,
                                                            ifelse(TIME > 0 & MDV==1 & CRRT == 1, 800,
                                                                   ifelse(TIME > 0 & MDV==1 & CRRT == 0, 400,0
                                                            
                  ))))
  )))
))))))
)

```

###### Updating TIME and TAD

```{r dataset for conc time curve opt dosing}

# Repeat the 2nd row of each ID per DAY 14 times

rows= seq(2,41999,by=3)
times = 14
dosing_CRRT_repeated<-dosing_CRRT[rep(rows, times),]

# Update the TAD values in dosing_CRRT 
dosing_CRRT_combined<-rbind(dosing_CRRT,dosing_CRRT_repeated)

# Rearrange the dataset
dosing_CRRT_combined<-arrange(dosing_CRRT_combined, ID, DAY,TAD,TIME)

# Define the desired TAD values
desired_tad <- c(0, 0.1, 0.25, 0.5, 0.6, 1, 1.5, 2, 3, 4, 6, 8, 12, 18, 21, 22.5, 23.9)

dosing_CRRT_combined$TAD<-rep(desired_tad,14000)

# Reset row names
rownames(dosing_CRRT_combined) <- 1:238000

# Exclude trough and PEAK dataset
dosing_CRRT_combined$PEAK<-NULL
dosing_CRRT_combined$TROUGH<-NULL

# Update TIME
dosing_CRRT_combined$TIME<-(dosing_CRRT_combined$DAY-1)*24+dosing_CRRT_combined$TAD

# Export pop_opt_conc
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
write.csv(dosing_CRRT_combined,"pop_opt_conc.csv",quote=F,row.names=FALSE)

```

#### Creating standard dosing virtual dataset

```{r dataset for conc time curve std dosing, warning=FALSE}

dosing_CRRT_std <- dosing_CRRT_combined %>%
  mutate(
    AMT = ifelse(TIME == 0, 800,
           ifelse(TIME >0 & TAD==0, 400,0
           )
    )
  )

# Export pop_std_conc
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
write.csv(dosing_CRRT_std,"pop_std_conc.csv",quote=F,row.names=FALSE)

```

#### Minimize the pop_sim datasets

##### For standard dosing

```{r pop_dosing_std dataset, warning=FALSE}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/BW_Simulations/Population_Simulations")
pop_dosing_std<-read.csv("pop_dosing_std.csv")

```

```{r keep only trough concen of pop_dosing_std }

pop_dos_std<-pop_dosing_std%>%filter(pop_dosing_std$TAD%in%c(0,23.9))

```

```{r adding CKDEPI column}

# for reproducibility
set.seed(123)

# Create the empirical cumulative distribution function (ECDF)
ecdf_func <- ecdf(na.omit(FlucTotIV_clean$CKDEPI))

# Generate random values from the ECDF
random_values <- runif(1000)

# Map the random values to the empirical distribution using the inverse transform sampling method
sampled_CKDEPI <- round(quantile(na.omit(FlucTotIV_clean$CKDEPI), random_values), 1)

# Assign the sampled CKDEPI values to pop_dos_std dataset
pop_dos_std$CKDEPI <- sampled_CKDEPI[match(pop_dos_std$ID, 1:1000)]

```

```{r exporting population level - standard dosing, warning=FALSE}

# pop_sim_std dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/Pop_Sim")
write.csv(pop_dos_std, "pop_sim_std.csv",quote=F,row.names = FALSE)

```

##### For optimise dosing

```{r updating std into optimised dosing}

# pop_dos_std taken from above

pop_dos_opt <- pop_dos_std %>%
  mutate(
    AMT = ifelse(TIME == 0 & BW > 120 & CRRT == 1, 1800,
           ifelse(TIME == 0 & BW <= 120 & BW > 100 & CRRT == 1, 1600,
           ifelse(TIME == 0 & BW <= 100 & BW > 80 & CRRT == 1, 1400,
           ifelse(TIME == 0 & BW <= 80 & BW > 60 & CRRT == 1, 1200, 
                  ifelse(TIME == 0 & BW <= 60 & CRRT == 1, 1000,
                         ifelse(TIME == 0 & BW > 140 & CRRT == 0, 1800,
                                ifelse(TIME == 0 & BW <= 140 & BW > 120 & CRRT == 0, 1600,
                                  ifelse(TIME == 0 & BW <= 120 & BW > 100 & CRRT == 0, 1400,
                                       ifelse(TIME == 0 & BW <= 100 & BW > 80 & CRRT == 0, 1200,
                                              ifelse(TIME == 0 & BW <= 80 & BW > 60 & CRRT == 0, 1000,
                                                     ifelse(TIME == 0 & BW <= 60 & CRRT == 0, 800,
                                                            ifelse(TIME > 0 & MDV==1 & CRRT == 1, 800,
                                                                   ifelse(TIME > 0 & MDV==1 & CRRT == 0, 400,0
                                                            
                  ))))
  )))
))))))
)

```

```{r exporting population level - optimal dosing, warning=FALSE}

# pop_sim_opt dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/Pop_Sim")
write.csv(pop_dos_opt, "pop_sim_opt.csv",quote=F,row.names = FALSE)

```

#### PTA pop_sim_std dataset

```{r pop_sim_std dataset, warning=FALSE}

working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/Pop_Sim'
simulations_tablefile <- paste0(working.directory, '/pop_sim_std.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
pop_std_dos <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]
# Ergo, pop_std_dos is my trough-concentration dataset

# Convert ID into numeric
pop_std_dos$ID<-as.integer(pop_std_dos$ID)

# Create a new variable AUC24 for each ID
pop_std_dos <- pop_std_dos %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

pop_std_dos<- pop_std_dos %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
pop_std_dos$fAUC<- pop_std_dos$AUC24*0.89

# Extract ID, DV, fAUC, DAY columns
PTA_pop_std <- subset(pop_std_dos, select = c("ID", "DV", "fAUC", "DAY"))

# Calculate percentage of DV >= 7.5 per DAY (PTA_Cmin_75)
PTA_pop_std$PTA_Cmin_75 <- 100 * ave(PTA_pop_std$DV >= 7.5, PTA_pop_std$DAY, FUN = mean)

# Calculate percentage of DV >= 80 per DAY (PTA_Cmin_80)
PTA_pop_std$PTA_Cmin_80 <- 100 * ave(PTA_pop_std$DV >= 80, PTA_pop_std$DAY, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY (PTA_fAUC_200)
PTA_pop_std$PTA_fAUC_200 <- 100 * ave(PTA_pop_std$fAUC >= 200, PTA_pop_std$DAY, FUN = mean)

# Create PTA_pop_std_overall dataset with unique values of PTA_Cmin, PTA_fAUC, DAY
PTA_pop_std_overall <- unique(PTA_pop_std[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY")])

# Export PTA_pop_std_overall dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/Pop_Sim")
write.csv(PTA_pop_std_overall, "PTA_pop_std_overall.csv",quote=F,row.names = FALSE)

```

#### PTA pop_sim_opt dataset

```{r pop_sim_opt dataset, warning=FALSE}

working.directory<-'C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/Pop_Sim'
simulations_tablefile <- paste0(working.directory, '/pop_sim_opt.1.npctab.dta') 
dataframe_simulations <- read_nonmem_table(simulations_tablefile)

# Extract only the trough events
pop_opt_dos <- dataframe_simulations[dataframe_simulations$TROUGH == 1,]

# Convert ID into numeric
pop_opt_dos$ID<-as.integer(pop_opt_dos$ID)

# Create a new variable AUC24 for each ID
pop_opt_dos <- pop_opt_dos %>% group_by(ID) %>% mutate(AUC24 = AUC2 - lag(AUC2, default = AUC2[1]))%>%ungroup()

pop_opt_dos<- pop_opt_dos %>% mutate(AUC24 = ifelse(DAY == "1", AUC2,AUC24))

# Create a new variable fAUC, which equals AUC24*89 (we assume protein binding is 11%)
pop_opt_dos$fAUC<- pop_opt_dos$AUC24*0.89

# Extract ID, DV, fAUC, and DAY columns
PTA_pop_opt <- subset(pop_opt_dos, select = c("ID", "DV", "fAUC", "DAY"))

# Calculate percentage of DV >= 7.5 per DAY (PTA_Cmin_75)
PTA_pop_opt$PTA_Cmin_75 <- 100 * ave(PTA_pop_opt$DV >= 7.5, PTA_pop_opt$DAY, FUN = mean)

# Calculate percentage of DV >= 80 per DAY (PTA_Cmin_80)
PTA_pop_opt$PTA_Cmin_80 <- 100 * ave(PTA_pop_opt$DV >= 80, PTA_pop_opt$DAY, FUN = mean)

# Calculate percentage of fAUC >= 200 per DAY (PTA_fAUC_200)
PTA_pop_opt$PTA_fAUC_200 <- 100 * ave(PTA_pop_opt$fAUC >= 200, PTA_pop_opt$DAY, FUN = mean)

# Create PTA_pop_opt_overall dataset with unique values of PTA_Cmin, PTA_fAUC, and DAY
PTA_pop_opt_overall <- unique(PTA_pop_opt[c("PTA_Cmin_75","PTA_Cmin_80", "PTA_fAUC_200", "DAY")])

# Export PTA_pop_opt_overall dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/Pop_Sim")
write.csv(PTA_pop_opt_overall, "PTA_pop_opt_overall.csv",quote=F,row.names = FALSE)

# Read PTA_pop_opt_overall when needed
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Bootstrap and dosing simulation/2l.method/2l.pan/Pop_Sim")
PTA_pop_opt_overall<-read.csv("PTA_pop_opt_overall.csv")

```

### 10 bootstraps results

```{r read pooled 10 bootstraps dataset, warning=FALSE}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets and R codes/Pooled_datasets")
Pooled_Bootstrap_2l.pan<-read.csv("Pooled_Bootstrap_2l.pan_071123.csv")

```

```{r reporting the median of the median (95% CI) of 10 bootstraps}

Pooled_Bootstrap_2l.pan %>% filter(Model!=100) %>%
  group_by(Parameters) %>% 
  summarise(median_median = median(Median_Mean),
            median_lower_bound = median(Lower_bound),
            median_upper_bound = median(Upper_bound)) %>%
  print()
 
```

```{r create 3 new columns for %CV of IIV/PropErr}

Pooled_Bootstrap_2l.pan$CV_mean<-sqrt(exp(Pooled_Bootstrap_2l.pan$Median_Mean)-1)*100
Pooled_Bootstrap_2l.pan$CV_lower<-sqrt(exp(Pooled_Bootstrap_2l.pan$Lower_bound)-1)*100
Pooled_Bootstrap_2l.pan$CV_upper<-sqrt(exp(Pooled_Bootstrap_2l.pan$Upper_bound)-1)*100

```

```{r calculate the median of these %CV of the 10 model and the final model}

Pooled_Bootstrap_2l.pan %>% filter (Parameters%in%c("IIV_CLcrrt","IIV_CLr","IIV_V1","PropErr","Cov_CLr_V1")) %>%
  group_by(Parameters) %>% filter(Model!=100) %>%
  summarise(median_CV_mean = median(CV_mean),
            median_CV_lower = median(CV_lower),
            median_CV_upper = median(CV_upper)) %>%
  print()

Pooled_Bootstrap_2l.pan %>% filter (Parameters%in%c("IIV_CLcrrt","IIV_CLr","IIV_V1","PropErr","Cov_CLr_V1")) %>%filter(Model==100) %>%select(CV_mean,CV_lower,CV_upper,Model,Parameters) %>%
  print()

Pooled_Bootstrap_2l.pan %>% filter (Parameters%in%c("IIV_CLcrrt","IIV_CLr","IIV_V1","PropErr","Cov_CLr_V1")) %>%
        group_by(Model) %>%
select(CV_mean,CV_lower,CV_upper,Model,Parameters) %>%
  print()

```

```{r number of successful run}

successful_run<-c(196,185,198,195,197,191,193,192,185,193) #from run 01 to run10
percentage<- successful_run/200
summary(percentage)

```

### Manuscript report - 300124

```{r read in dataset, warning=FALSE}

# Read in dataset from above

# When IHD == 1, converts CRRT == 1, otherwise remains

FlucTotIV_clean$CRRT[FlucTotIV_clean$IHD==1]<-1

# Convert AMT == 0 back into NA

FlucTotIV_clean$AMT[FlucTotIV_clean$AMT==0]<-NA

# Convert DV == 0 back into NA

FlucTotIV_clean$DV[FlucTotIV_clean$DV==0]<-NA

# Convert TAD and RATE == 0 back into NA

FlucTotIV_clean$TAD[FlucTotIV_clean$TAD==0]<-NA

FlucTotIV_clean$RATE[FlucTotIV_clean$RATE==0]<-NA

```

```{r table1}

## Create CRRT2 that it equals 1 if at least one observation per patient ID has CRRT == 1, otherwise 0

FlucTotIV_clean$CRRT2<-ave(FlucTotIV_clean$CRRT, FlucTotIV_clean$ID, FUN=function(x) ifelse(sum(x, na.rm=TRUE)>0, 1, 0))

# Change SEX and CRRT2 into factor

FlucTotIV_clean$SEX<-as.factor(FlucTotIV_clean$SEX)

FlucTotIV_clean$CRRT2<-as.factor(FlucTotIV_clean$CRRT2)

## Then, summarise APACHE + AGE + SEX + CRRT2 with table1 at a patient level

# Extract data that each ID has only 1 observation

FlucTotIV_clean2<-FlucTotIV_clean[!duplicated(FlucTotIV_clean$ID),]

# Now summarise APACHE + AGE + SEX + CRRT2 with table1 at a patient level

table1(~ APACHE + AGE + SEX + CRRT2|HOSPITAL, data=FlucTotIV_clean2,render.continuous=
               c(.="Median [Q1-Q3]"))

## CKDEPI off CRRT

summary(FlucTotIV_clean$CKDEPI[FlucTotIV_clean$CRRT == 0]) # still remains as in the former version

## Creat CREAT_WITH so that it equals 1 if CREAT_DOS_INT is missing or CREAT is not missing, otherwise equals NA

# CREAT_WITH is the missing CREAT within dosing interval

FlucTotIV_clean$CREAT_WITH<-ifelse(is.na(FlucTotIV_clean$CREAT_DOS_INT)|!is.na(FlucTotIV_clean$CREAT),1,NA)

## Next, summarise AMT + DV + BW2 + CKDEPI + CREAT_DOS_INT + CREAT_WITH with table1 at the observation level

table1(~ AMT + DV + BW2 + CKDEPI + CREAT_DOS_INT + CREAT_WITH|HOSPITAL, data=FlucTotIV_clean,render.continuous=
               c(.="Median [Q1-Q3]"))

```

#### GOF plots

```{r import GOF_overall.npctab.dta, warning=FALSE}

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets/GOF plots/2l.pan")
GOF_overall <- read_nonmem_table("GOF_overall.npctab.dta")
GOF_overall <- subset (GOF_overall, EVID==0)

```

```{r over all GOF, warning=FALSE}

# Overall PRED_CWRES

PRED_CWRES<-ggplot(data = GOF_overall, aes(x=PRED, y=CWRES)) +
  geom_point(colour="#fde725", shape=21, size=3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0,color = "gray50",size=1,linetype="dotdash") +
  geom_hline(yintercept = -2, linetype = "dashed",color = "gray50",size=1) +  
  geom_hline(yintercept = 2, linetype = "dashed",color = "gray50",size=1) +
  scale_x_continuous(limits = c(0, 60),breaks = seq(0,60, by = 10),expand=c(0,0)) +
  scale_y_continuous(limits = c(-4, 4), breaks = seq(-4, 4, by = 1),expand=c(0,0)) +
  geom_smooth(se = F, colour = "#440154", method = "loess") +
  ggtitle("(a)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0, size = 12),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.position="none",
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) 

# PRED_CWRES per hospital

# make title for each hospital

hospital.labs <- c("Van Daele et al.", "Muilwijk et al.", "Bergner et al.", "Buijk et al.","Sandaradura et al.", "Sinnollareddy et al.", "Alobaid et al.", "Boonstra et al.")

names(hospital.labs) <- c("1", "2", "3","4", "5", "6","7", "8")

# ggplot code
PRED_CWRES_HOSPITAL<-ggplot(data = GOF_overall, aes(x = PRED, y = CWRES)) +
  geom_point(colour = "#fde725", shape = 21, size = 3) +
  xlab('Population predicted fluconazole concentration (mg/L)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0, color = "gray50", size = 1,linetype="dotdash") +
  geom_hline(yintercept = -2, linetype = "dashed", color = "gray50", size = 1) +
  geom_hline(yintercept = 2, linetype = "dashed", color = "gray50", size = 1) +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = FALSE, colour = "#440154", method = "loess") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "none",
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank(),
    # Facet
    strip.text = element_text(size = 14, face = "bold"),
    strip.background = element_blank()
  ) + facet_wrap(~HOSPITAL, labeller = labeller(HOSPITAL=hospital.labs), nrow=2)


# Overall TAD_CWRES

TAD_CWRES <-ggplot(data = GOF_overall, aes(x=TAD, y=CWRES)) +
  geom_point(colour="#fde725", shape=21, size=3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0,color = "gray50",size=1,linetype="dotdash") +
  geom_hline(yintercept = -2, linetype = "dashed",color = "gray50",size=1) +  
  geom_hline(yintercept = 2, linetype = "dashed",color = "gray50",size=1) +
  scale_x_continuous(limits = c(0, 50),breaks = seq(0,50, by = 10),expand=c(0,0)) +
  scale_y_continuous(limits = c(-4, 4), breaks = seq(-4, 4, by = 1),expand=c(0,0)) +
  geom_smooth(se = F, colour = "#440154", method = "loess") +
  ggtitle("(b)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0, size = 12),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.position="none",
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) 

# TAD_CWRES per hospital

# hospital.labs created above

TAD_CWRES_HOSPITAL<-ggplot(data = GOF_overall, aes(x = TAD, y = CWRES)) +
  geom_point(colour = "#fde725", shape = 21, size = 3) +
  xlab('Time since last dose (hours)') +
  ylab('Conditional weighted residual error') +
  geom_hline(yintercept = 0, color = "gray50", size = 1,linetype="dotdash") +
  geom_hline(yintercept = -2, linetype = "dashed", color = "gray50", size = 1) +
  geom_hline(yintercept = 2, linetype = "dashed", color = "gray50", size = 1) +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(-4.1, 4.1), breaks = seq(-9999, 9999, by = 1)) +
  geom_smooth(se = FALSE, colour = "#440154", method = "loess") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "none",
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank(),
    # Facet
    strip.text = element_text(size = 14, face = "bold"),
    strip.background = element_blank()
  ) + facet_wrap(~HOSPITAL, labeller = labeller(HOSPITAL=hospital.labs), nrow=2)

# Overall PRED_DV

PRED_DV <-ggplot(data = GOF_overall, aes(x=PRED, y=DV)) +
  geom_point(colour="#fde725", shape=21, size=3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1,linetype="dotdash",size=1,color = "gray50") +
  scale_x_continuous(limits = c(0,60), breaks = seq(0, 999, by = 10),expand=c(0,0)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10),expand=c(0,0)) +
  geom_smooth(se = F, colour = "#440154", method = "loess") +
  ggtitle("(c)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0, size = 12),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.position="none",
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) 

# PRED_DV per hospital

# hospital.labs created above

PRED_DV_HOSPITAL<-ggplot(data = GOF_overall, aes(x = PRED, y = DV)) +
  geom_point(colour = "#fde725", shape = 21, size = 3) +
  xlab('Population predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1,linetype="dotdash",size=1,color = "gray50") +
  scale_x_continuous(breaks = seq(0, 9999, by = 10)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) +
  geom_smooth(se = FALSE, colour = "#440154", method = "loess") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "none",
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank(),
    # Facet
    strip.text = element_text(size = 14, face = "bold"),
    strip.background = element_blank()
  ) + facet_wrap(~HOSPITAL, labeller = labeller(HOSPITAL=hospital.labs), nrow=2)


# Overall IPRED_DV

IPRED_DV <-ggplot(data = GOF_overall, aes(x=IPRED, y=DV)) +
  geom_point(colour="#fde725", shape=21, size=3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1,linetype="dotdash",size=1,color = "gray50") +
  scale_x_continuous(limits = c(0,80), breaks = seq(0, 999, by = 10),expand=c(0,0)) +
  scale_y_continuous(limits = c(0,100), breaks = seq(0, 999, by = 10),expand=c(0,0)) +
  geom_smooth(se = F, colour = "#440154", method = "loess") +
  ggtitle("(d)") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0, size = 12),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.position="none",
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank()) 

# IPRED_DV per hospital

# hospital.labs created above

IPRED_DV_HOSPITAL<-ggplot(data = GOF_overall, aes(x = IPRED, y = DV)) +
  geom_point(colour = "#fde725", shape = 21, size = 3) +
  xlab('Individual predicted concentration (mg/L)') +
  ylab('Observed concentration (mg/L)') +
  geom_abline(intercept = 0, slope = 1,linetype="dotdash",size=1,color = "gray50") +
  scale_x_continuous(limits = c(0, 80),breaks = seq(0, 80, by = 10)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) +
  geom_smooth(se = FALSE, colour = "#440154", method = "loess") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "none",
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank(),
    # Facet
    strip.text = element_text(size = 14, face = "bold"),
    strip.background = element_blank()
  ) + facet_wrap(~HOSPITAL, labeller = labeller(HOSPITAL=hospital.labs), nrow=2)


# Combine 4 overall plots

overall_GOF <- plot_grid(PRED_CWRES, TAD_CWRES, PRED_DV, IPRED_DV, nrow = 2, align = "h")

title_overall_GOF <- ggdraw() + 
  draw_label("Overall data", fontface = "bold", size = 14)

overall_GOF_title <- plot_grid(title_overall_GOF, overall_GOF, ncol = 1, rel_heights = c(0.05, 1))


## Export per hospital plot

setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Plots/GOF/2l.pan")
#ggsave("PRED_CWRES_HOSPITAL.png", PRED_CWRES_HOSPITAL, dpi = 300, width = 12, height = 7) #this size works better for this particular plot
#ggsave("TAD_CWRES_HOSPITAL.png", TAD_CWRES_HOSPITAL, dpi = 300, width = 12, height = 7)
#ggsave("PRED_DV_HOSPITAL.png", PRED_DV_HOSPITAL, dpi = 300, width = 12, height = 7)
ggsave("IPRED_DV_HOSPITAL.png", IPRED_DV_HOSPITAL, dpi = 300, width = 12, height = 7)

## Export overall_GOF plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Plots/GOF/2l.pan")
ggsave("overall_GOF.png", overall_GOF_title, dpi = 300, width = 12, height = 7)


```

#### BW vs Vc plot

```{r some more EDA,warning=FALSE}

# Import dataset
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/My datasets/Exploratory data analysis/BW vs V")
base_mod<-read_nonmem_table("basemod.npctab.dta")

# Exclude BW2 <0
base_mod<-base_mod%>%filter(BW!=-99)

# Make a plot
BW_Vc<-ggplot(data = base_mod, aes(x=BW, y=V1)) +
  geom_point(colour="#fde725", size=3,alpha=0.5) +
  xlab('Body weight (kg)') +
  ylab('Central volume of distribution (L)') +
  scale_x_continuous(limits = c(30, 145),breaks = seq(30, 145, by = 5),expand = c(0.005,0)) +
  scale_y_continuous(limits = c(0, 110), breaks = seq(0, 110, by = 10),expand = c(0.005,0)) +
  #geom_smooth(se = F, colour = "#440154", method = "glm") +
  ggtitle("Fluconazole base model") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14,face="bold"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.position="none",
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank())

# Export the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Plots/EDA/BW_Vc")
ggsave("BW_Vc_base.png", BW_Vc, dpi = 300, width = 12, height = 7)


```

#### DV vs TIME plot

```{r DV over Time plot,warning=FALSE}

# Exclude BW2 <0
DV_TIME<-FlucTotIV_clean%>%filter(EVID==0)

# Make a plot
DV_TIME_plot<-ggplot(data = DV_TIME, aes(x=TIME, y=DV)) +
  geom_point(colour="#fde725", size=3,alpha=0.5) +
  xlab('Time (hours)') +
  ylab('Total fluconazole plasma concentration (mg/L)') +
  scale_x_continuous(limits = c(0, 1100),breaks = seq(0, 1100, by = 50),expand = c(0.005,0)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10),expand = c(0.005,0)) +
  #geom_smooth(se = F, colour = "#440154", method = "glm") +
  #ggtitle("Fluconazole base model") +
  theme_minimal() +
  theme(plot.title = element_text(hjust = 0.5, size = 14,face="bold"),
        axis.title = element_text(size = 12),
        axis.text = element_text(size = 10),
        legend.position="none",
        panel.grid.major = element_line(colour = "gray85"),
        panel.grid.minor = element_blank())

# Plot per hospital

# make title for each hospital

hospital.labs <- c("Van Daele et al.", "Muilwijk et al.", "Bergner et al.", "Buijk et al.","Sandaradura et al.", "Sinnollareddy et al.", "Alobaid et al.", "Boonstra et al.")

names(hospital.labs) <- c("1", "2", "3","4", "5", "6","7", "8")

# ggplot code
DV_TIME_HOSPITAL_plot<-ggplot(data = DV_TIME, aes(x = TIME, y = DV)) +
  geom_point(colour = "#fde725", shape = 21, size = 3) +
  xlab('Time (hours)') +
  ylab('Total fluconazole plasma concentration (mg/L)') +
  scale_x_continuous(breaks = seq(0, 9999, by = 150)) +
  scale_y_continuous(limits = c(0, 100), breaks = seq(0, 100, by = 10)) +
  #geom_smooth(se = FALSE, colour = "#440154", method = "loess") +
  theme_minimal() +
  theme(
    plot.title = element_text(hjust = 0, size = 12),
    axis.title = element_text(size = 12),
    axis.text = element_text(size = 10),
    legend.position = "none",
    panel.grid.major = element_line(colour = "gray85"),
    panel.grid.minor = element_blank(),
    # Facet
    strip.text = element_text(size = 14, face = "bold"),
    strip.background = element_blank()
  ) + facet_wrap(~HOSPITAL, labeller = labeller(HOSPITAL=hospital.labs), nrow=2)

# Export the plot
setwd("C:/Users/u0164053/OneDrive - KU Leuven/Fluconazole PoPPK/Fluconazol_project/Plots/EDA/DV_Time")
#ggsave("DV_TIME_plot.png", DV_TIME_plot, dpi = 300, width = 16, height = 8.27)
ggsave("DV_TIME_HOSPITAL_plot.png", DV_TIME_HOSPITAL_plot, dpi = 300, width = 12, height = 7)


```




